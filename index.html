<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة اختبار مواد الهندسة المدنية | Civil Engineering Materials Testing Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Cairo', 'Inter', sans-serif;
        }
        .english-text {
            font-family: 'Inter', sans-serif;
        }
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        .spec-input {
            width: 50px;
            padding: 4px;
            text-align: center;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            font-size: 12px;
        }
        .spec-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, createContext, useContext } = React;

        // ============= ICONS =============
        const FlaskIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M9 3h6v6l4 8a2 2 0 0 1-1.8 3H6.8a2 2 0 0 1-1.8-3l4-8V3z"/>
                <path d="M9 3h6"/>
            </svg>
        );

        const BeakerIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M4.5 3h15"/>
                <path d="M6 3v16a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V3"/>
                <path d="M6 14h12"/>
            </svg>
        );

        const LayersIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polygon points="12 2 2 7 12 12 22 7 12 2"/>
                <polyline points="2 17 12 22 22 17"/>
                <polyline points="2 12 12 17 22 12"/>
            </svg>
        );

        const ScaleIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/>
                <path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/>
                <path d="M7 21h10"/>
                <path d="M12 3v18"/>
                <path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/>
            </svg>
        );

        const DropletIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z"/>
            </svg>
        );

        const FilterIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
            </svg>
        );

        const CircleDotIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <circle cx="12" cy="12" r="1"/>
            </svg>
        );

        const RotateCwIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/>
                <path d="M21 3v5h-5"/>
            </svg>
        );

        const ThermometerIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z"/>
            </svg>
        );

        const BoxIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/>
                <path d="m3.3 7 8.7 5 8.7-5"/>
                <path d="M12 22V12"/>
            </svg>
        );

        const MenuIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="4" x2="20" y1="12" y2="12"/>
                <line x1="4" x2="20" y1="6" y2="6"/>
                <line x1="4" x2="20" y1="18" y2="18"/>
            </svg>
        );

        const ChevronLeftIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m15 18-6-6 6-6"/>
            </svg>
        );

        const RefreshIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                <path d="M21 3v5h-5"/>
                <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                <path d="M8 16H3v5"/>
            </svg>
        );

        const CheckCircleIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
        );

        const AlertTriangleIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
                <line x1="12" x2="12" y1="9" y2="13"/>
                <line x1="12" x2="12.01" y1="17" y2="17"/>
            </svg>
        );

        const MixerIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M12 2v4"/>
                <path d="m6.8 15-3.5 2"/>
                <path d="m20.7 17-3.5-2"/>
                <path d="M6.8 9 3.3 7"/>
                <path d="m20.7 7-3.5 2"/>
                <circle cx="12" cy="12" r="6"/>
            </svg>
        );

        // ============= TEST ITEMS =============
        const testItems = [
            { id: 'C136', astm: 'C136', arabic: 'التحليل المنخلي للتدرج', english: 'Sieve Analysis', icon: LayersIcon, hasTabs: true },
            { id: 'D4791', astm: 'D4791', arabic: 'التفلطح والاستطالة', english: 'Flat & Elongated Particles', icon: ScaleIcon },
            { id: 'C127', astm: 'C127', arabic: 'الوزن النوعي والامتصاص (ركام خشن)', english: 'Specific Gravity (Coarse)', icon: BeakerIcon },
            { id: 'C128', astm: 'C128', arabic: 'الوزن النوعي والامتصاص (ركام ناعم)', english: 'Specific Gravity (Fine)', icon: DropletIcon },
            { id: 'C117', astm: 'C117', arabic: 'المواد أنعم من 200 (بالغسيل)', english: 'Materials Finer than 75µm', icon: FilterIcon },
            { id: 'C142', astm: 'C142', arabic: 'الكتل الطينية والحبيبات الهشة', english: 'Clay Lumps & Friable Particles', icon: CircleDotIcon },
            { id: 'C131', astm: 'C131', arabic: 'مقاومة البري (لوس أنجلوس)', english: 'L.A. Abrasion Resistance', icon: RotateCwIcon },
            { id: 'C88', astm: 'C88', arabic: 'أصالة الركام (Soundness)', english: 'Soundness of Aggregates', icon: ThermometerIcon },
            { id: 'C29', astm: 'C29', arabic: 'الوزن الحجمي للركام', english: 'Bulk Density (Unit Weight)', icon: BoxIcon },
        ];

        // ============= SIEVE DATA DEFINITIONS =============
        // Size No. 67 for 3/4" Coarse Aggregate
        const sieveDataSize67 = [
            { id: '1in', sieveMetric: '25.0 mm', sieveImperial: '1"', arabicName: '1 بوصة', defaultMin: 100, defaultMax: 100 },
            { id: '34in', sieveMetric: '19.0 mm', sieveImperial: '3/4"', arabicName: '3/4 بوصة', defaultMin: 90, defaultMax: 100 },
            { id: '38in', sieveMetric: '9.5 mm', sieveImperial: '3/8"', arabicName: '3/8 بوصة', defaultMin: 20, defaultMax: 55 },
            { id: 'no4', sieveMetric: '4.75 mm', sieveImperial: 'No. 4', arabicName: 'رقم 4', defaultMin: 0, defaultMax: 10 },
            { id: 'no8', sieveMetric: '2.36 mm', sieveImperial: 'No. 8', arabicName: 'رقم 8', defaultMin: 0, defaultMax: 5 },
            { id: 'pan', sieveMetric: 'Pan', sieveImperial: 'Pan', arabicName: 'الوعاء', defaultMin: null, defaultMax: null },
        ];

        // Size No. 8 for 3/8" Coarse Aggregate
        const sieveDataSize8 = [
            { id: '12in', sieveMetric: '12.5 mm', sieveImperial: '1/2"', arabicName: '1/2 بوصة', defaultMin: 100, defaultMax: 100 },
            { id: '38in', sieveMetric: '9.5 mm', sieveImperial: '3/8"', arabicName: '3/8 بوصة', defaultMin: 85, defaultMax: 100 },
            { id: 'no4', sieveMetric: '4.75 mm', sieveImperial: 'No. 4', arabicName: 'رقم 4', defaultMin: 10, defaultMax: 30 },
            { id: 'no8', sieveMetric: '2.36 mm', sieveImperial: 'No. 8', arabicName: 'رقم 8', defaultMin: 0, defaultMax: 10 },
            { id: 'no16', sieveMetric: '1.18 mm', sieveImperial: 'No. 16', arabicName: 'رقم 16', defaultMin: 0, defaultMax: 5 },
            { id: 'pan', sieveMetric: 'Pan', sieveImperial: 'Pan', arabicName: 'الوعاء', defaultMin: null, defaultMax: null },
        ];

        // Fine Aggregate (Sand) - ASTM C33
        const sieveDataSand = [
            { id: '38in', sieveMetric: '9.5 mm', sieveImperial: '3/8"', arabicName: '3/8 بوصة', defaultMin: 100, defaultMax: 100 },
            { id: 'no4', sieveMetric: '4.75 mm', sieveImperial: 'No. 4', arabicName: 'رقم 4', defaultMin: 95, defaultMax: 100 },
            { id: 'no8', sieveMetric: '2.36 mm', sieveImperial: 'No. 8', arabicName: 'رقم 8', defaultMin: 80, defaultMax: 100 },
            { id: 'no16', sieveMetric: '1.18 mm', sieveImperial: 'No. 16', arabicName: 'رقم 16', defaultMin: 50, defaultMax: 85 },
            { id: 'no30', sieveMetric: '0.600 mm', sieveImperial: 'No. 30', arabicName: 'رقم 30', defaultMin: 25, defaultMax: 60 },
            { id: 'no50', sieveMetric: '0.300 mm', sieveImperial: 'No. 50', arabicName: 'رقم 50', defaultMin: 5, defaultMax: 30 },
            { id: 'no100', sieveMetric: '0.150 mm', sieveImperial: 'No. 100', arabicName: 'رقم 100', defaultMin: 0, defaultMax: 10 },
            { id: 'no200', sieveMetric: '0.075 mm', sieveImperial: 'No. 200', arabicName: 'رقم 200', defaultMin: 0, defaultMax: 3 },
            { id: 'pan', sieveMetric: 'Pan', sieveImperial: 'Pan', arabicName: 'الوعاء', defaultMin: null, defaultMax: null },
        ];

        // Combined Gradation Sieves (Master List)
        const combinedSieves = [
            { id: '1in', sieveMetric: '25.0 mm', sieveImperial: '1"', defaultMin: 100, defaultMax: 100 },
            { id: '34in', sieveMetric: '19.0 mm', sieveImperial: '3/4"', defaultMin: 90, defaultMax: 100 },
            { id: '12in', sieveMetric: '12.5 mm', sieveImperial: '1/2"', defaultMin: null, defaultMax: null },
            { id: '38in', sieveMetric: '9.5 mm', sieveImperial: '3/8"', defaultMin: 56, defaultMax: 80 },
            { id: 'no4', sieveMetric: '4.75 mm', sieveImperial: 'No. 4', defaultMin: 35, defaultMax: 65 },
            { id: 'no8', sieveMetric: '2.36 mm', sieveImperial: 'No. 8', defaultMin: 23, defaultMax: 49 },
            { id: 'no16', sieveMetric: '1.18 mm', sieveImperial: 'No. 16', defaultMin: 15, defaultMax: 37 },
            { id: 'no30', sieveMetric: '0.600 mm', sieveImperial: 'No. 30', defaultMin: 10, defaultMax: 28 },
            { id: 'no50', sieveMetric: '0.300 mm', sieveImperial: 'No. 50', defaultMin: 5, defaultMax: 19 },
            { id: 'no100', sieveMetric: '0.150 mm', sieveImperial: 'No. 100', defaultMin: 3, defaultMax: 12 },
            { id: 'no200', sieveMetric: '0.075 mm', sieveImperial: 'No. 200', defaultMin: 2, defaultMax: 8 },
        ];

        // ============= GRADATION CHART COMPONENT =============
        const GradationChart = ({ data, sieves, title, subtitle }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (chartRef.current) {
                    const ctx = chartRef.current.getContext('2d');
                    
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }

                    const chartSieves = sieves.filter(s => s.id !== 'pan');
                    const labels = chartSieves.map(s => s.sieveImperial);
                    const upperLimits = chartSieves.map(s => {
                        const sieveData = data.find(d => d.id === s.id);
                        return sieveData?.maxLimit ?? s.defaultMax;
                    });
                    const lowerLimits = chartSieves.map(s => {
                        const sieveData = data.find(d => d.id === s.id);
                        return sieveData?.minLimit ?? s.defaultMin;
                    });
                    const actualValues = chartSieves.map(s => {
                        const sieveData = data.find(d => d.id === s.id);
                        return sieveData?.percentPassing ?? null;
                    });

                    chartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Upper Limit / الحد الأعلى',
                                    data: upperLimits,
                                    borderColor: '#ef4444',
                                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                    borderWidth: 2,
                                    borderDash: [8, 4],
                                    pointRadius: 0,
                                    tension: 0,
                                    fill: false,
                                },
                                {
                                    label: 'Lower Limit / الحد الأدنى',
                                    data: lowerLimits,
                                    borderColor: '#ef4444',
                                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                    borderWidth: 2,
                                    borderDash: [8, 4],
                                    pointRadius: 0,
                                    tension: 0,
                                    fill: false,
                                },
                                {
                                    label: 'Actual Sample / العينة الفعلية',
                                    data: actualValues,
                                    borderColor: '#3b82f6',
                                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                    borderWidth: 3,
                                    pointRadius: 6,
                                    pointBackgroundColor: '#3b82f6',
                                    pointBorderColor: '#fff',
                                    pointBorderWidth: 2,
                                    tension: 0.1,
                                    fill: false,
                                },
                            ],
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    rtl: true,
                                    labels: {
                                        font: { family: 'Cairo, Inter, sans-serif', size: 11 },
                                        padding: 15,
                                        usePointStyle: true,
                                    },
                                },
                                tooltip: {
                                    rtl: true,
                                    callbacks: {
                                        label: function(context) {
                                            return `${context.dataset.label}: ${context.parsed.y?.toFixed(1) || '-'}%`;
                                        }
                                    }
                                },
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    title: {
                                        display: true,
                                        text: 'نسبة المار (%) / Percent Passing (%)',
                                        font: { family: 'Cairo, Inter, sans-serif', size: 11, weight: 'bold' },
                                    },
                                    grid: { color: 'rgba(0, 0, 0, 0.06)' },
                                    ticks: {
                                        font: { family: 'Inter, sans-serif', size: 10 },
                                        callback: (value) => value + '%'
                                    },
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'حجم المنخل / Sieve Size',
                                        font: { family: 'Cairo, Inter, sans-serif', size: 11, weight: 'bold' },
                                    },
                                    grid: { color: 'rgba(0, 0, 0, 0.06)' },
                                    ticks: { font: { family: 'Inter, sans-serif', size: 10 } },
                                },
                            },
                        },
                    });
                }

                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [data, sieves]);

            return <canvas ref={chartRef} />;
        };

        // ============= COMBINED GRADATION CHART =============
        const CombinedGradationChart = ({ combinedData, sieves }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (chartRef.current) {
                    const ctx = chartRef.current.getContext('2d');
                    
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }

                    const labels = sieves.map(s => s.sieveImperial);
                    const upperLimits = sieves.map(s => {
                        const d = combinedData.find(c => c.id === s.id);
                        return d?.maxLimit ?? s.defaultMax;
                    });
                    const lowerLimits = sieves.map(s => {
                        const d = combinedData.find(c => c.id === s.id);
                        return d?.minLimit ?? s.defaultMin;
                    });
                    const combinedValues = sieves.map(s => {
                        const d = combinedData.find(c => c.id === s.id);
                        return d?.combinedPassing ?? null;
                    });

                    chartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Upper Limit / الحد الأعلى',
                                    data: upperLimits,
                                    borderColor: '#ef4444',
                                    borderWidth: 2,
                                    borderDash: [8, 4],
                                    pointRadius: 0,
                                    tension: 0,
                                    fill: '+1',
                                    backgroundColor: 'rgba(239, 68, 68, 0.08)',
                                },
                                {
                                    label: 'Lower Limit / الحد الأدنى',
                                    data: lowerLimits,
                                    borderColor: '#ef4444',
                                    borderWidth: 2,
                                    borderDash: [8, 4],
                                    pointRadius: 0,
                                    tension: 0,
                                    fill: false,
                                },
                                {
                                    label: 'Combined Mix / الخلطة المجمعة',
                                    data: combinedValues,
                                    borderColor: '#10b981',
                                    backgroundColor: 'rgba(16, 185, 129, 0.2)',
                                    borderWidth: 3,
                                    pointRadius: 6,
                                    pointBackgroundColor: '#10b981',
                                    pointBorderColor: '#fff',
                                    pointBorderWidth: 2,
                                    tension: 0.1,
                                    fill: false,
                                },
                            ],
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    rtl: true,
                                    labels: {
                                        font: { family: 'Cairo, Inter, sans-serif', size: 11 },
                                        padding: 15,
                                        usePointStyle: true,
                                    },
                                },
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    title: {
                                        display: true,
                                        text: 'نسبة المار (%) / Percent Passing (%)',
                                        font: { family: 'Cairo, Inter, sans-serif', size: 11, weight: 'bold' },
                                    },
                                    grid: { color: 'rgba(0, 0, 0, 0.06)' },
                                    ticks: {
                                        font: { family: 'Inter, sans-serif', size: 10 },
                                        callback: (value) => value + '%'
                                    },
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'حجم المنخل / Sieve Size',
                                        font: { family: 'Cairo, Inter, sans-serif', size: 11, weight: 'bold' },
                                    },
                                    grid: { color: 'rgba(0, 0, 0, 0.06)' },
                                    ticks: { font: { family: 'Inter, sans-serif', size: 10 } },
                                },
                            },
                        },
                    });
                }

                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [combinedData, sieves]);

            return <canvas ref={chartRef} />;
        };

        // ============= AGGREGATE TAB COMPONENT (Reusable) =============
        const AggregateTab = ({ 
            title, 
            subtitle, 
            sieveDefinitions, 
            aggregateData, 
            setAggregateData 
        }) => {
            // Sample Preparation State
            const [samplePrep, setSamplePrep] = useState({
                originalWeight: '',
                dryWeight: '',
                washedWeight: ''
            });

            // Weights State
            const [weights, setWeights] = useState(() => {
                const initial = {};
                sieveDefinitions.forEach(sieve => {
                    initial[sieve.id] = '';
                });
                return initial;
            });

            // Spec Limits State (User Editable)
            const [specLimits, setSpecLimits] = useState(() => {
                const initial = {};
                sieveDefinitions.forEach(sieve => {
                    initial[sieve.id] = {
                        min: sieve.defaultMin ?? '',
                        max: sieve.defaultMax ?? ''
                    };
                });
                return initial;
            });

            // Calculate wash loss
            const washLoss = useMemo(() => {
                const dry = parseFloat(samplePrep.dryWeight) || 0;
                const washed = parseFloat(samplePrep.washedWeight) || 0;
                if (dry > 0 && washed > 0 && dry >= washed) {
                    return dry - washed;
                }
                return 0;
            }, [samplePrep.dryWeight, samplePrep.washedWeight]);

            // Calculate all values
            const calculations = useMemo(() => {
                const dryWeight = parseFloat(samplePrep.dryWeight) || 0;
                
                // Sum of retained weights
                const sumRetained = Object.values(weights).reduce((sum, w) => {
                    return sum + (parseFloat(w) || 0);
                }, 0);

                // Total includes wash loss (for verification)
                const totalWithWashLoss = sumRetained + washLoss;

                let cumulativeRetained = 0;
                const results = sieveDefinitions.map(sieve => {
                    let weightRetained = parseFloat(weights[sieve.id]) || 0;
                    
                    // Add wash loss to pan
                    if (sieve.id === 'pan') {
                        weightRetained += washLoss;
                    }

                    const percentRetained = dryWeight > 0 ? (weightRetained / dryWeight) * 100 : 0;
                    cumulativeRetained += percentRetained;
                    const percentPassing = Math.max(0, 100 - cumulativeRetained);

                    const minLimit = specLimits[sieve.id]?.min;
                    const maxLimit = specLimits[sieve.id]?.max;

                    let isWithinSpec = true;
                    if (minLimit !== '' && maxLimit !== '' && minLimit !== null && maxLimit !== null && dryWeight > 0) {
                        isWithinSpec = percentPassing >= parseFloat(minLimit) && percentPassing <= parseFloat(maxLimit);
                    }

                    return {
                        id: sieve.id,
                        weightRetained,
                        percentRetained: percentRetained.toFixed(1),
                        cumulativeRetained: cumulativeRetained.toFixed(1),
                        percentPassing: parseFloat(percentPassing.toFixed(1)),
                        minLimit: minLimit !== '' ? parseFloat(minLimit) : null,
                        maxLimit: maxLimit !== '' ? parseFloat(maxLimit) : null,
                        isWithinSpec,
                    };
                });

                const outOfSpecCount = results.filter(r => !r.isWithinSpec && r.minLimit !== null).length;
                const withinSpecCount = results.filter(r => r.isWithinSpec && r.minLimit !== null).length;

                return { results, totalWithWashLoss, outOfSpecCount, withinSpecCount, dryWeight };
            }, [weights, samplePrep.dryWeight, specLimits, washLoss, sieveDefinitions]);

            // Update parent data when calculations change
            useEffect(() => {
                setAggregateData(calculations.results);
            }, [calculations.results, setAggregateData]);

            const handleWeightChange = (sieveId, value) => {
                setWeights(prev => ({ ...prev, [sieveId]: value }));
            };

            const handleSpecLimitChange = (sieveId, type, value) => {
                setSpecLimits(prev => ({
                    ...prev,
                    [sieveId]: { ...prev[sieveId], [type]: value }
                }));
            };

            const handleReset = () => {
                const resetWeights = {};
                const resetLimits = {};
                sieveDefinitions.forEach(sieve => {
                    resetWeights[sieve.id] = '';
                    resetLimits[sieve.id] = {
                        min: sieve.defaultMin ?? '',
                        max: sieve.defaultMax ?? ''
                    };
                });
                setWeights(resetWeights);
                setSpecLimits(resetLimits);
                setSamplePrep({ originalWeight: '', dryWeight: '', washedWeight: '' });
            };

            const hasData = calculations.dryWeight > 0;
            const allPassing = calculations.outOfSpecCount === 0 && hasData;

            return (
                <div className="p-4 space-y-4">
                    {/* Header */}
                    <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                        <div className="flex items-center justify-between mb-4">
                            <div>
                                <h2 className="text-lg font-bold text-slate-800">{title}</h2>
                                <p className="english-text text-sm text-slate-500">{subtitle}</p>
                            </div>
                            <button
                                onClick={handleReset}
                                className="flex items-center gap-2 px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors text-sm"
                            >
                                <RefreshIcon />
                                <span className="font-medium">إعادة تعيين</span>
                            </button>
                        </div>

                        {/* Sample Preparation Section */}
                        <div className="bg-gradient-to-l from-blue-50 to-indigo-50 rounded-lg p-4 border border-blue-100">
                            <h3 className="text-sm font-bold text-blue-800 mb-3">
                                تحضير العينة <span className="english-text text-xs font-normal text-blue-600">/ Sample Preparation (ASTM C117/C136)</span>
                            </h3>
                            <div className="grid grid-cols-4 gap-4">
                                <div>
                                    <label className="block text-xs font-medium text-slate-700 mb-1">
                                        وزن العينة الأصلية
                                        <span className="english-text block text-slate-500 font-normal">Original Sample Wt. (g)</span>
                                    </label>
                                    <input
                                        type="number"
                                        min="0"
                                        step="0.1"
                                        value={samplePrep.originalWeight}
                                        onChange={(e) => setSamplePrep(p => ({ ...p, originalWeight: e.target.value }))}
                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg text-center english-text focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                        placeholder="0.0"
                                        dir="ltr"
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-medium text-slate-700 mb-1">
                                        الوزن بعد التجفيف
                                        <span className="english-text block text-slate-500 font-normal">Dry Weight - Total (g)</span>
                                    </label>
                                    <input
                                        type="number"
                                        min="0"
                                        step="0.1"
                                        value={samplePrep.dryWeight}
                                        onChange={(e) => setSamplePrep(p => ({ ...p, dryWeight: e.target.value }))}
                                        className="w-full px-3 py-2 border border-blue-400 rounded-lg text-center english-text font-bold focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white"
                                        placeholder="0.0"
                                        dir="ltr"
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-medium text-slate-700 mb-1">
                                        الوزن بعد الغسيل
                                        <span className="english-text block text-slate-500 font-normal">Washed Weight (g)</span>
                                    </label>
                                    <input
                                        type="number"
                                        min="0"
                                        step="0.1"
                                        value={samplePrep.washedWeight}
                                        onChange={(e) => setSamplePrep(p => ({ ...p, washedWeight: e.target.value }))}
                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg text-center english-text focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                        placeholder="0.0"
                                        dir="ltr"
                                    />
                                </div>
                                <div className={`rounded-lg p-3 ${washLoss > 0 ? 'bg-amber-100 border border-amber-300' : 'bg-slate-100 border border-slate-200'}`}>
                                    <div className="text-xs font-medium text-slate-600">
                                        فقد الغسيل
                                        <span className="english-text block text-slate-500 font-normal">Wash Loss (g)</span>
                                    </div>
                                    <div className={`text-xl font-bold english-text ${washLoss > 0 ? 'text-amber-700' : 'text-slate-400'}`}>
                                        {washLoss.toFixed(1)}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Summary Cards */}
                        <div className="grid grid-cols-4 gap-3 mt-4">
                            <div className="bg-blue-50 rounded-lg p-3 border border-blue-100">
                                <div className="text-xl font-bold text-blue-600 english-text">
                                    {calculations.dryWeight.toFixed(1)}
                                </div>
                                <div className="text-xs font-medium text-blue-800">الوزن الجاف (جم)</div>
                                <div className="english-text text-xs text-blue-600">Dry Weight (g)</div>
                            </div>
                            <div className="bg-slate-50 rounded-lg p-3 border border-slate-200">
                                <div className="text-xl font-bold text-slate-700 english-text">
                                    {calculations.totalWithWashLoss.toFixed(1)}
                                </div>
                                <div className="text-xs font-medium text-slate-700">المجموع + الفقد</div>
                                <div className="english-text text-xs text-slate-500">Total + Loss</div>
                            </div>
                            <div className={`rounded-lg p-3 border ${allPassing ? 'bg-green-50 border-green-100' : 'bg-slate-50 border-slate-200'}`}>
                                <div className={`text-xl font-bold ${allPassing ? 'text-green-600' : 'text-slate-400'}`}>
                                    {hasData ? calculations.withinSpecCount : '-'}
                                </div>
                                <div className={`text-xs font-medium ${allPassing ? 'text-green-800' : 'text-slate-600'}`}>ضمن المواصفات</div>
                                <div className={`english-text text-xs ${allPassing ? 'text-green-600' : 'text-slate-500'}`}>Within Spec</div>
                            </div>
                            <div className={`rounded-lg p-3 border ${calculations.outOfSpecCount > 0 ? 'bg-red-50 border-red-100' : 'bg-slate-50 border-slate-200'}`}>
                                <div className={`text-xl font-bold ${calculations.outOfSpecCount > 0 ? 'text-red-600' : 'text-slate-400'}`}>
                                    {hasData ? calculations.outOfSpecCount : '-'}
                                </div>
                                <div className={`text-xs font-medium ${calculations.outOfSpecCount > 0 ? 'text-red-800' : 'text-slate-600'}`}>خارج المواصفات</div>
                                <div className={`english-text text-xs ${calculations.outOfSpecCount > 0 ? 'text-red-600' : 'text-slate-500'}`}>Out of Spec</div>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 xl:grid-cols-5 gap-4">
                        {/* Data Entry Table */}
                        <div className="xl:col-span-3 bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                            <div className="bg-slate-50 border-b border-slate-200 px-4 py-3">
                                <h3 className="text-sm font-bold text-slate-800">جدول التحليل المنخلي</h3>
                                <p className="english-text text-xs text-slate-500">Sieve Analysis Data Table</p>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm" dir="rtl">
                                    <thead>
                                        <tr className="bg-slate-800 text-white">
                                            <th className="px-2 py-2 text-right">
                                                <div className="font-bold text-xs">حجم المنخل</div>
                                                <div className="english-text text-xs text-slate-300 font-normal">Sieve Size</div>
                                            </th>
                                            <th className="px-2 py-2 text-center">
                                                <div className="font-bold text-xs">الوزن المحجوز</div>
                                                <div className="english-text text-xs text-slate-300 font-normal">Wt. Ret. (g)</div>
                                            </th>
                                            <th className="px-2 py-2 text-center">
                                                <div className="font-bold text-xs">% المحجوز</div>
                                                <div className="english-text text-xs text-slate-300 font-normal">% Ret.</div>
                                            </th>
                                            <th className="px-2 py-2 text-center">
                                                <div className="font-bold text-xs">% التراكمي</div>
                                                <div className="english-text text-xs text-slate-300 font-normal">Cum. %</div>
                                            </th>
                                            <th className="px-2 py-2 text-center">
                                                <div className="font-bold text-xs">% المار</div>
                                                <div className="english-text text-xs text-slate-300 font-normal">% Pass</div>
                                            </th>
                                            <th className="px-2 py-2 text-center">
                                                <div className="font-bold text-xs">حدود المواصفة (أدنى/أقصى)</div>
                                                <div className="english-text text-xs text-slate-300 font-normal">Spec Limits (Min/Max)</div>
                                            </th>
                                            <th className="px-2 py-2 text-center">
                                                <div className="font-bold text-xs">الحالة</div>
                                                <div className="english-text text-xs text-slate-300 font-normal">Status</div>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {sieveDefinitions.map((sieve, index) => {
                                            const calc = calculations.results.find(r => r.id === sieve.id);
                                            const isOutOfSpec = calc && !calc.isWithinSpec && calc.minLimit !== null && hasData;
                                            const isPan = sieve.id === 'pan';
                                            
                                            return (
                                                <tr 
                                                    key={sieve.id}
                                                    className={`border-b border-slate-100 transition-colors ${
                                                        isOutOfSpec 
                                                            ? 'bg-red-50 hover:bg-red-100' 
                                                            : index % 2 === 0 
                                                                ? 'bg-white hover:bg-slate-50' 
                                                                : 'bg-slate-50/50 hover:bg-slate-100'
                                                    }`}
                                                >
                                                    <td className="px-2 py-2">
                                                        <div className="font-bold text-slate-800 text-xs">{sieve.sieveMetric}</div>
                                                        <div className="english-text text-xs text-slate-500">({sieve.sieveImperial})</div>
                                                    </td>
                                                    <td className="px-2 py-2">
                                                        <input
                                                            type="number"
                                                            min="0"
                                                            step="0.1"
                                                            value={weights[sieve.id]}
                                                            onChange={(e) => handleWeightChange(sieve.id, e.target.value)}
                                                            className={`w-20 px-2 py-1.5 border rounded text-center english-text text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none ${
                                                                isOutOfSpec ? 'border-red-300 bg-white' : 'border-slate-300 bg-white'
                                                            }`}
                                                            placeholder="0.0"
                                                            dir="ltr"
                                                        />
                                                        {isPan && washLoss > 0 && (
                                                            <div className="text-xs text-amber-600 mt-1">+{washLoss.toFixed(1)} فقد</div>
                                                        )}
                                                    </td>
                                                    <td className="px-2 py-2 text-center">
                                                        <span className={`english-text text-sm ${hasData ? 'text-slate-700' : 'text-slate-400'}`}>
                                                            {hasData ? calc?.percentRetained : '-'}
                                                        </span>
                                                    </td>
                                                    <td className="px-2 py-2 text-center">
                                                        <span className={`english-text text-sm ${hasData ? 'text-slate-700' : 'text-slate-400'}`}>
                                                            {hasData ? calc?.cumulativeRetained : '-'}
                                                        </span>
                                                    </td>
                                                    <td className="px-2 py-2 text-center">
                                                        <span className={`english-text font-bold text-sm ${
                                                            isOutOfSpec ? 'text-red-600' : hasData ? 'text-blue-600' : 'text-slate-400'
                                                        }`}>
                                                            {hasData ? calc?.percentPassing.toFixed(1) : '-'}
                                                        </span>
                                                    </td>
                                                    <td className="px-2 py-2">
                                                        {!isPan ? (
                                                            <div className="flex items-center justify-center gap-1">
                                                                <input
                                                                    type="number"
                                                                    min="0"
                                                                    max="100"
                                                                    value={specLimits[sieve.id]?.min ?? ''}
                                                                    onChange={(e) => handleSpecLimitChange(sieve.id, 'min', e.target.value)}
                                                                    className="spec-input english-text"
                                                                    placeholder="Min"
                                                                    dir="ltr"
                                                                />
                                                                <span className="text-slate-400">-</span>
                                                                <input
                                                                    type="number"
                                                                    min="0"
                                                                    max="100"
                                                                    value={specLimits[sieve.id]?.max ?? ''}
                                                                    onChange={(e) => handleSpecLimitChange(sieve.id, 'max', e.target.value)}
                                                                    className="spec-input english-text"
                                                                    placeholder="Max"
                                                                    dir="ltr"
                                                                />
                                                            </div>
                                                        ) : (
                                                            <span className="text-slate-400 text-xs">-</span>
                                                        )}
                                                    </td>
                                                    <td className="px-2 py-2 text-center">
                                                        {!isPan && hasData && calc?.minLimit !== null ? (
                                                            calc?.isWithinSpec ? (
                                                                <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-green-100 text-green-700 rounded-full text-xs font-bold">
                                                                    <CheckCircleIcon />
                                                                </span>
                                                            ) : (
                                                                <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-red-100 text-red-700 rounded-full text-xs font-bold">
                                                                    <AlertTriangleIcon />
                                                                </span>
                                                            )
                                                        ) : (
                                                            <span className="text-slate-400 text-xs">-</span>
                                                        )}
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* Gradation Chart */}
                        <div className="xl:col-span-2 bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                            <div className="bg-slate-50 border-b border-slate-200 px-4 py-3">
                                <h3 className="text-sm font-bold text-slate-800">منحنى التدرج الحبيبي</h3>
                                <p className="english-text text-xs text-slate-500">Gradation Curve (S-Curve)</p>
                            </div>
                            <div className="p-4">
                                <div className="h-64" dir="ltr">
                                    <GradationChart 
                                        data={calculations.results}
                                        sieves={sieveDefinitions}
                                    />
                                </div>
                            </div>
                            
                            {/* Result Badge */}
                            {hasData && (
                                <div className={`mx-4 mb-4 rounded-lg p-3 text-center ${allPassing ? 'bg-green-100' : 'bg-red-100'}`}>
                                    <span className={`text-lg font-bold ${allPassing ? 'text-green-700' : 'text-red-700'}`}>
                                        {allPassing ? 'مطابق للمواصفات / PASS' : 'غير مطابق / FAIL'}
                                    </span>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // ============= COMBINED GRADATION (BLENDING) TAB =============
        const CombinedGradationTab = ({ dataA, dataB, dataC }) => {
            // Mix Ratios State
            const [ratios, setRatios] = useState({
                ratioA: 40,
                ratioB: 20,
                ratioC: 40
            });

            // Spec Limits for Combined
            const [combinedLimits, setCombinedLimits] = useState(() => {
                const initial = {};
                combinedSieves.forEach(sieve => {
                    initial[sieve.id] = {
                        min: sieve.defaultMin ?? '',
                        max: sieve.defaultMax ?? ''
                    };
                });
                return initial;
            });

            const totalRatio = ratios.ratioA + ratios.ratioB + ratios.ratioC;
            const isRatioValid = totalRatio === 100;

            // Calculate combined gradation
            const combinedData = useMemo(() => {
                return combinedSieves.map(sieve => {
                    const passA = dataA.find(d => d.id === sieve.id)?.percentPassing ?? 100;
                    const passB = dataB.find(d => d.id === sieve.id)?.percentPassing ?? 100;
                    const passC = dataC.find(d => d.id === sieve.id)?.percentPassing ?? 100;

                    const combinedPassing = (
                        (passA * ratios.ratioA) + 
                        (passB * ratios.ratioB) + 
                        (passC * ratios.ratioC)
                    ) / 100;

                    const minLimit = combinedLimits[sieve.id]?.min !== '' ? parseFloat(combinedLimits[sieve.id]?.min) : null;
                    const maxLimit = combinedLimits[sieve.id]?.max !== '' ? parseFloat(combinedLimits[sieve.id]?.max) : null;

                    let isWithinSpec = true;
                    if (minLimit !== null && maxLimit !== null) {
                        isWithinSpec = combinedPassing >= minLimit && combinedPassing <= maxLimit;
                    }

                    return {
                        id: sieve.id,
                        sieveMetric: sieve.sieveMetric,
                        sieveImperial: sieve.sieveImperial,
                        passA,
                        passB,
                        passC,
                        combinedPassing: parseFloat(combinedPassing.toFixed(1)),
                        minLimit,
                        maxLimit,
                        isWithinSpec
                    };
                });
            }, [dataA, dataB, dataC, ratios, combinedLimits]);

            const outOfSpecCount = combinedData.filter(d => !d.isWithinSpec && d.minLimit !== null).length;
            const allPassing = outOfSpecCount === 0;

            const handleLimitChange = (sieveId, type, value) => {
                setCombinedLimits(prev => ({
                    ...prev,
                    [sieveId]: { ...prev[sieveId], [type]: value }
                }));
            };

            return (
                <div className="p-4 space-y-4">
                    {/* Header */}
                    <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                        <div className="flex items-center justify-between mb-4">
                            <div>
                                <h2 className="text-lg font-bold text-slate-800">التدرج التجميعي (الخلط)</h2>
                                <p className="english-text text-sm text-slate-500">Combined Gradation (Blending)</p>
                            </div>
                            <div className="flex items-center gap-2">
                                <MixerIcon />
                                <span className="text-sm font-medium text-slate-600">Mix Design</span>
                            </div>
                        </div>

                        {/* Mix Design Control Panel */}
                        <div className="bg-gradient-to-l from-purple-50 to-indigo-50 rounded-lg p-4 border border-purple-100">
                            <h3 className="text-sm font-bold text-purple-800 mb-3">
                                لوحة تصميم الخلطة <span className="english-text text-xs font-normal text-purple-600">/ Mix Design Control Panel</span>
                            </h3>
                            <div className="grid grid-cols-4 gap-4">
                                <div>
                                    <label className="block text-xs font-medium text-slate-700 mb-1">
                                        نسبة ركام 3/4"
                                        <span className="english-text block text-slate-500 font-normal">Ratio A - Agg. 3/4" (%)</span>
                                    </label>
                                    <input
                                        type="number"
                                        min="0"
                                        max="100"
                                        value={ratios.ratioA}
                                        onChange={(e) => setRatios(p => ({ ...p, ratioA: parseFloat(e.target.value) || 0 }))}
                                        className="w-full px-3 py-2 border border-purple-300 rounded-lg text-center english-text font-bold focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none bg-white"
                                        dir="ltr"
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-medium text-slate-700 mb-1">
                                        نسبة ركام 3/8"
                                        <span className="english-text block text-slate-500 font-normal">Ratio B - Agg. 3/8" (%)</span>
                                    </label>
                                    <input
                                        type="number"
                                        min="0"
                                        max="100"
                                        value={ratios.ratioB}
                                        onChange={(e) => setRatios(p => ({ ...p, ratioB: parseFloat(e.target.value) || 0 }))}
                                        className="w-full px-3 py-2 border border-purple-300 rounded-lg text-center english-text font-bold focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none bg-white"
                                        dir="ltr"
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-medium text-slate-700 mb-1">
                                        نسبة الرمل
                                        <span className="english-text block text-slate-500 font-normal">Ratio C - Sand (%)</span>
                                    </label>
                                    <input
                                        type="number"
                                        min="0"
                                        max="100"
                                        value={ratios.ratioC}
                                        onChange={(e) => setRatios(p => ({ ...p, ratioC: parseFloat(e.target.value) || 0 }))}
                                        className="w-full px-3 py-2 border border-purple-300 rounded-lg text-center english-text font-bold focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none bg-white"
                                        dir="ltr"
                                    />
                                </div>
                                <div className={`rounded-lg p-3 border-2 ${isRatioValid ? 'bg-green-100 border-green-400' : 'bg-red-100 border-red-400'}`}>
                                    <div className="text-xs font-medium text-slate-600">
                                        المجموع
                                        <span className="english-text block text-slate-500 font-normal">Total Sum</span>
                                    </div>
                                    <div className={`text-xl font-bold english-text ${isRatioValid ? 'text-green-700' : 'text-red-700'}`}>
                                        {totalRatio}%
                                    </div>
                                    <div className={`text-xs font-bold ${isRatioValid ? 'text-green-600' : 'text-red-600'}`}>
                                        {isRatioValid ? '✓ OK' : 'Adjust Ratios'}
                                    </div>
                                </div>
                            </div>

                            {/* Ratio Visualization Bar */}
                            <div className="mt-4">
                                <div className="h-6 rounded-full overflow-hidden flex bg-slate-200">
                                    <div 
                                        className="bg-blue-500 transition-all duration-300 flex items-center justify-center text-white text-xs font-bold"
                                        style={{ width: `${ratios.ratioA}%` }}
                                    >
                                        {ratios.ratioA > 10 && `${ratios.ratioA}%`}
                                    </div>
                                    <div 
                                        className="bg-indigo-500 transition-all duration-300 flex items-center justify-center text-white text-xs font-bold"
                                        style={{ width: `${ratios.ratioB}%` }}
                                    >
                                        {ratios.ratioB > 10 && `${ratios.ratioB}%`}
                                    </div>
                                    <div 
                                        className="bg-amber-500 transition-all duration-300 flex items-center justify-center text-white text-xs font-bold"
                                        style={{ width: `${ratios.ratioC}%` }}
                                    >
                                        {ratios.ratioC > 10 && `${ratios.ratioC}%`}
                                    </div>
                                </div>
                                <div className="flex justify-between mt-1 text-xs">
                                    <span className="text-blue-600 font-medium">● 3/4" Agg</span>
                                    <span className="text-indigo-600 font-medium">● 3/8" Agg</span>
                                    <span className="text-amber-600 font-medium">● Sand</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 xl:grid-cols-5 gap-4">
                        {/* Combined Table */}
                        <div className="xl:col-span-3 bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                            <div className="bg-slate-50 border-b border-slate-200 px-4 py-3">
                                <h3 className="text-sm font-bold text-slate-800">جدول التدرج المجمع</h3>
                                <p className="english-text text-xs text-slate-500">Combined Gradation Table</p>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm" dir="rtl">
                                    <thead>
                                        <tr className="bg-slate-800 text-white">
                                            <th className="px-2 py-2 text-right">
                                                <div className="font-bold text-xs">المنخل</div>
                                                <div className="english-text text-xs text-slate-300 font-normal">Sieve</div>
                                            </th>
                                            <th className="px-2 py-2 text-center bg-blue-700">
                                                <div className="font-bold text-xs">% مار A</div>
                                                <div className="english-text text-xs text-blue-200 font-normal">% Pass A</div>
                                            </th>
                                            <th className="px-2 py-2 text-center bg-indigo-700">
                                                <div className="font-bold text-xs">% مار B</div>
                                                <div className="english-text text-xs text-indigo-200 font-normal">% Pass B</div>
                                            </th>
                                            <th className="px-2 py-2 text-center bg-amber-700">
                                                <div className="font-bold text-xs">% مار C</div>
                                                <div className="english-text text-xs text-amber-200 font-normal">% Pass C</div>
                                            </th>
                                            <th className="px-2 py-2 text-center bg-green-700">
                                                <div className="font-bold text-xs">% مار مجمع</div>
                                                <div className="english-text text-xs text-green-200 font-normal">Combined %</div>
                                            </th>
                                            <th className="px-2 py-2 text-center">
                                                <div className="font-bold text-xs">حدود المواصفة</div>
                                                <div className="english-text text-xs text-slate-300 font-normal">Spec Limits</div>
                                            </th>
                                            <th className="px-2 py-2 text-center">
                                                <div className="font-bold text-xs">الحالة</div>
                                                <div className="english-text text-xs text-slate-300 font-normal">Status</div>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {combinedData.map((row, index) => {
                                            const isOutOfSpec = !row.isWithinSpec && row.minLimit !== null;
                                            
                                            return (
                                                <tr 
                                                    key={row.id}
                                                    className={`border-b border-slate-100 transition-colors ${
                                                        isOutOfSpec 
                                                            ? 'bg-red-50 hover:bg-red-100' 
                                                            : index % 2 === 0 
                                                                ? 'bg-white hover:bg-slate-50' 
                                                                : 'bg-slate-50/50 hover:bg-slate-100'
                                                    }`}
                                                >
                                                    <td className="px-2 py-2">
                                                        <div className="font-bold text-slate-800 text-xs">{row.sieveMetric}</div>
                                                        <div className="english-text text-xs text-slate-500">({row.sieveImperial})</div>
                                                    </td>
                                                    <td className="px-2 py-2 text-center bg-blue-50">
                                                        <span className="english-text text-sm text-blue-700 font-medium">
                                                            {row.passA.toFixed(1)}
                                                        </span>
                                                    </td>
                                                    <td className="px-2 py-2 text-center bg-indigo-50">
                                                        <span className="english-text text-sm text-indigo-700 font-medium">
                                                            {row.passB.toFixed(1)}
                                                        </span>
                                                    </td>
                                                    <td className="px-2 py-2 text-center bg-amber-50">
                                                        <span className="english-text text-sm text-amber-700 font-medium">
                                                            {row.passC.toFixed(1)}
                                                        </span>
                                                    </td>
                                                    <td className="px-2 py-2 text-center bg-green-50">
                                                        <span className={`english-text text-sm font-bold ${isOutOfSpec ? 'text-red-600' : 'text-green-700'}`}>
                                                            {row.combinedPassing.toFixed(1)}
                                                        </span>
                                                    </td>
                                                    <td className="px-2 py-2">
                                                        <div className="flex items-center justify-center gap-1">
                                                            <input
                                                                type="number"
                                                                min="0"
                                                                max="100"
                                                                value={combinedLimits[row.id]?.min ?? ''}
                                                                onChange={(e) => handleLimitChange(row.id, 'min', e.target.value)}
                                                                className="spec-input english-text"
                                                                placeholder="Min"
                                                                dir="ltr"
                                                            />
                                                            <span className="text-slate-400">-</span>
                                                            <input
                                                                type="number"
                                                                min="0"
                                                                max="100"
                                                                value={combinedLimits[row.id]?.max ?? ''}
                                                                onChange={(e) => handleLimitChange(row.id, 'max', e.target.value)}
                                                                className="spec-input english-text"
                                                                placeholder="Max"
                                                                dir="ltr"
                                                            />
                                                        </div>
                                                    </td>
                                                    <td className="px-2 py-2 text-center">
                                                        {row.minLimit !== null ? (
                                                            row.isWithinSpec ? (
                                                                <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-green-100 text-green-700 rounded-full text-xs font-bold">
                                                                    <CheckCircleIcon />
                                                                </span>
                                                            ) : (
                                                                <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-red-100 text-red-700 rounded-full text-xs font-bold">
                                                                    <AlertTriangleIcon />
                                                                </span>
                                                            )
                                                        ) : (
                                                            <span className="text-slate-400 text-xs">-</span>
                                                        )}
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* Combined Chart */}
                        <div className="xl:col-span-2 bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                            <div className="bg-slate-50 border-b border-slate-200 px-4 py-3">
                                <h3 className="text-sm font-bold text-slate-800">منحنى التدرج المجمع</h3>
                                <p className="english-text text-xs text-slate-500">Combined Gradation Curve (Envelope)</p>
                            </div>
                            <div className="p-4">
                                <div className="h-64" dir="ltr">
                                    <CombinedGradationChart 
                                        combinedData={combinedData}
                                        sieves={combinedSieves}
                                    />
                                </div>
                            </div>
                            
                            {/* Result Badge */}
                            <div className={`mx-4 mb-4 rounded-lg p-3 text-center ${allPassing ? 'bg-green-100' : 'bg-red-100'}`}>
                                <span className={`text-lg font-bold ${allPassing ? 'text-green-700' : 'text-red-700'}`}>
                                    {allPassing ? 'الخلطة ضمن الغلاف / WITHIN ENVELOPE' : 'الخلطة خارج الغلاف / OUT OF ENVELOPE'}
                                </span>
                            </div>
                        </div>
                    </div>

                    {/* Formula Explanation */}
                    <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                        <h3 className="text-sm font-bold text-slate-800 mb-2">
                            معادلة الحساب <span className="english-text text-xs font-normal text-slate-500">/ Calculation Formula</span>
                        </h3>
                        <div className="bg-slate-50 rounded-lg p-3 font-mono text-sm text-center english-text">
                            Combined % Passing = (Pass<sub>A</sub> × Ratio<sub>A</sub> + Pass<sub>B</sub> × Ratio<sub>B</sub> + Pass<sub>C</sub> × Ratio<sub>C</sub>) ÷ 100
                        </div>
                    </div>
                </div>
            );
        };

        // ============= C136 PAGE WITH ALL TABS =============
        const C136Page = ({ onGradationDataChange }) => {
            const [activeTab, setActiveTab] = useState('agg34');
            
            // Shared state for aggregate data (to pass to combined tab)
            const [dataA, setDataA] = useState([]);
            const [dataB, setDataB] = useState([]);
            const [dataC, setDataC] = useState([]);

            // Report gradation data to parent (for use by D4791)
            useEffect(() => {
                if (onGradationDataChange) {
                    // Combine all gradation data for use by other tests
                    const combinedData = [...dataA, ...dataB, ...dataC];
                    onGradationDataChange(combinedData);
                }
            }, [dataA, dataB, dataC, onGradationDataChange]);

            const tabs = [
                { id: 'agg34', arabic: 'ركام 3/4"', english: 'Agg. 3/4"' },
                { id: 'agg38', arabic: 'ركام 3/8"', english: 'Agg. 3/8"' },
                { id: 'sand', arabic: 'رمل', english: 'Sand' },
                { id: 'combined', arabic: 'التدرج التجميعي', english: 'Combined' },
            ];

            const renderTabContent = () => {
                switch (activeTab) {
                    case 'agg34':
                        return (
                            <AggregateTab
                                title="التحليل المنخلي - ركام خشن 3/4&quot;"
                                subtitle="Sieve Analysis - Coarse Aggregate 3/4&quot; (ASTM Size No. 67)"
                                sieveDefinitions={sieveDataSize67}
                                aggregateData={dataA}
                                setAggregateData={setDataA}
                            />
                        );
                    case 'agg38':
                        return (
                            <AggregateTab
                                title="التحليل المنخلي - ركام خشن 3/8&quot;"
                                subtitle="Sieve Analysis - Coarse Aggregate 3/8&quot; (ASTM Size No. 8)"
                                sieveDefinitions={sieveDataSize8}
                                aggregateData={dataB}
                                setAggregateData={setDataB}
                            />
                        );
                    case 'sand':
                        return (
                            <AggregateTab
                                title="التحليل المنخلي - الركام الناعم (الرمل)"
                                subtitle="Sieve Analysis - Fine Aggregate (Sand) - ASTM C33"
                                sieveDefinitions={sieveDataSand}
                                aggregateData={dataC}
                                setAggregateData={setDataC}
                            />
                        );
                    case 'combined':
                        return (
                            <CombinedGradationTab
                                dataA={dataA}
                                dataB={dataB}
                                dataC={dataC}
                            />
                        );
                    default:
                        return null;
                }
            };

            return (
                <div className="h-full flex flex-col">
                    {/* Tab Navigation */}
                    <div className="border-b border-slate-200 bg-white">
                        <div className="flex gap-1 p-2">
                            {tabs.map((tab) => (
                                <button
                                    key={tab.id}
                                    onClick={() => setActiveTab(tab.id)}
                                    className={`px-4 py-2.5 rounded-lg transition-all duration-200 ${
                                        activeTab === tab.id
                                            ? 'bg-blue-600 text-white shadow-md'
                                            : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                    }`}
                                >
                                    <div className="font-bold text-sm">{tab.arabic}</div>
                                    <div className={`english-text text-xs ${
                                        activeTab === tab.id ? 'text-blue-100' : 'text-slate-400'
                                    }`}>{tab.english}</div>
                                </button>
                            ))}
                        </div>
                    </div>
                    
                    {/* Tab Content */}
                    <div className="flex-1 overflow-auto bg-slate-50">
                        {renderTabContent()}
                    </div>
                </div>
            );
        };

        // ============= SIDEBAR =============
        const SidebarItem = ({ item, isActive, onClick }) => {
            const Icon = item.icon;
            return (
                <button
                    onClick={onClick}
                    className={`w-full text-right p-3 rounded-lg transition-all duration-200 group ${
                        isActive 
                            ? 'bg-gradient-to-l from-blue-600 to-blue-700 text-white shadow-lg shadow-blue-900/30' 
                            : 'hover:bg-slate-700/50 text-slate-300 hover:text-white'
                    }`}
                >
                    <div className="flex items-start gap-3">
                        <div className={`p-2 rounded-lg ${isActive ? 'bg-blue-500/30' : 'bg-slate-700 group-hover:bg-slate-600'}`}>
                            <Icon />
                        </div>
                        <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2 mb-1">
                                <span className={`px-2 py-0.5 text-xs font-bold rounded ${
                                    isActive ? 'bg-white/20 text-white' : 'bg-amber-500/20 text-amber-400'
                                }`}>
                                    {item.astm}
                                </span>
                            </div>
                            <div className="font-bold text-sm leading-tight mb-0.5 truncate">
                                {item.arabic}
                            </div>
                            <div className={`english-text text-xs leading-tight truncate ${
                                isActive ? 'text-blue-100' : 'text-slate-500'
                            }`}>
                                {item.english}
                            </div>
                        </div>
                    </div>
                </button>
            );
        };

        const Sidebar = ({ activeTest, setActiveTest, isCollapsed, setIsCollapsed }) => {
            return (
                <aside className={`fixed top-0 right-0 h-full bg-slate-800 border-l border-slate-700 transition-all duration-300 z-50 ${
                    isCollapsed ? 'w-0 overflow-hidden' : 'w-72'
                }`}>
                    <div className="flex flex-col h-full">
                        <div className="p-3 border-b border-slate-700 bg-slate-900">
                            <div className="flex items-center justify-between">
                                <button 
                                    onClick={() => setIsCollapsed(true)}
                                    className="p-2 hover:bg-slate-700 rounded-lg text-slate-400 hover:text-white transition-colors"
                                >
                                    <ChevronLeftIcon />
                                </button>
                                <div className="text-left">
                                    <h1 className="text-sm font-bold text-white">اختبارات المواد</h1>
                                    <p className="english-text text-xs text-slate-400">Materials Testing</p>
                                </div>
                            </div>
                        </div>

                        <div className="p-3 border-b border-slate-700">
                            <div className="flex items-center gap-3 justify-end">
                                <div className="text-left">
                                    <div className="text-xs font-bold text-white">مختبر ضمان الجودة</div>
                                    <div className="english-text text-xs text-slate-400">QA Laboratory</div>
                                </div>
                                <div className="w-9 h-9 bg-gradient-to-br from-blue-500 to-blue-700 rounded-xl flex items-center justify-center shadow-lg text-white">
                                    <FlaskIcon />
                                </div>
                            </div>
                        </div>

                        <nav className="flex-1 overflow-y-auto p-2 space-y-1">
                            <div className="text-xs text-slate-500 px-2 mb-2 font-semibold">
                                <span className="block text-slate-400">اختبارات الركام</span>
                                <span className="english-text block text-slate-600">Aggregate Tests</span>
                            </div>
                            {testItems.map((item) => (
                                <SidebarItem
                                    key={item.id}
                                    item={item}
                                    isActive={activeTest === item.id}
                                    onClick={() => setActiveTest(item.id)}
                                />
                            ))}
                        </nav>

                        <div className="p-3 border-t border-slate-700 bg-slate-900">
                            <div className="text-center">
                                <div className="text-xs text-slate-500">LIMS v2.0</div>
                            </div>
                        </div>
                    </div>
                </aside>
            );
        };

        // ============= ASTM D4791 - FLAT & ELONGATED PARTICLES =============
        const FlatElongatedTest = ({ gradationData = [] }) => {
            // Coarse aggregate sieves (> No.4) for F&E testing
            const coarseSieves = [
                { id: '1in_34in', sieveFrom: '1"', sieveTo: '3/4"', sieveMetric: '25.0 - 19.0 mm', minSampleMass: 200 },
                { id: '34in_12in', sieveFrom: '3/4"', sieveTo: '1/2"', sieveMetric: '19.0 - 12.5 mm', minSampleMass: 200 },
                { id: '12in_38in', sieveFrom: '1/2"', sieveTo: '3/8"', sieveMetric: '12.5 - 9.5 mm', minSampleMass: 100 },
                { id: '38in_no4', sieveFrom: '3/8"', sieveTo: 'No. 4', sieveMetric: '9.5 - 4.75 mm', minSampleMass: 100 },
            ];

            // Test settings
            const [testMethod, setTestMethod] = useState('A'); // A = Combined, B = Separate
            const [dimensionalRatio, setDimensionalRatio] = useState('1:3');
            const [maxSpecLimit, setMaxSpecLimit] = useState(10); // Default 10%

            // Data state for each sieve fraction
            const [sieveData, setSieveData] = useState(() => {
                const initial = {};
                coarseSieves.forEach(sieve => {
                    initial[sieve.id] = {
                        percentRetained: '',
                        testSampleMass: '',
                        flatElongatedMass: '',
                        flatMass: '', // For Method B
                        elongatedMass: '', // For Method B
                    };
                });
                return initial;
            });

            // Auto-fill from gradation data
            useEffect(() => {
                if (gradationData && gradationData.length > 0) {
                    // Try to match sieves and get percent retained
                    const newData = { ...sieveData };
                    
                    // Map gradation data to F&E sieve fractions
                    const sieveMapping = {
                        '1in_34in': ['1in', '34in'],
                        '34in_12in': ['34in', '12in'],
                        '12in_38in': ['12in', '38in'],
                        '38in_no4': ['38in', 'no4'],
                    };

                    Object.entries(sieveMapping).forEach(([feId, [fromId, toId]]) => {
                        const fromData = gradationData.find(d => d.id === fromId);
                        const toData = gradationData.find(d => d.id === toId);
                        
                        if (fromData && toData) {
                            // Percent retained on this fraction = % passing from - % passing to
                            const percentRetained = fromData.percentPassing - toData.percentPassing;
                            if (percentRetained > 0) {
                                newData[feId].percentRetained = percentRetained.toFixed(1);
                            }
                        }
                    });

                    setSieveData(newData);
                }
            }, [gradationData]);

            // Handle input changes
            const handleInputChange = (sieveId, field, value) => {
                setSieveData(prev => ({
                    ...prev,
                    [sieveId]: { ...prev[sieveId], [field]: value }
                }));
            };

            // Calculate results
            const calculations = useMemo(() => {
                const results = coarseSieves.map(sieve => {
                    const data = sieveData[sieve.id];
                    const percentRetained = parseFloat(data.percentRetained) || 0;
                    const testSampleMass = parseFloat(data.testSampleMass) || 0;
                    
                    let fePercent = 0;
                    let flatPercent = 0;
                    let elongatedPercent = 0;

                    if (testMethod === 'A') {
                        const feMass = parseFloat(data.flatElongatedMass) || 0;
                        fePercent = testSampleMass > 0 ? (feMass / testSampleMass) * 100 : 0;
                    } else {
                        const flatMass = parseFloat(data.flatMass) || 0;
                        const elongatedMass = parseFloat(data.elongatedMass) || 0;
                        flatPercent = testSampleMass > 0 ? (flatMass / testSampleMass) * 100 : 0;
                        elongatedPercent = testSampleMass > 0 ? (elongatedMass / testSampleMass) * 100 : 0;
                        fePercent = flatPercent + elongatedPercent; // Combined for reporting
                    }

                    const weightedAvg = (fePercent * percentRetained) / 100;
                    const isMandatory = percentRetained >= 10;
                    const hasData = testSampleMass > 0;

                    return {
                        id: sieve.id,
                        sieve,
                        percentRetained,
                        testSampleMass,
                        fePercent: parseFloat(fePercent.toFixed(1)),
                        flatPercent: parseFloat(flatPercent.toFixed(1)),
                        elongatedPercent: parseFloat(elongatedPercent.toFixed(1)),
                        weightedAvg: parseFloat(weightedAvg.toFixed(2)),
                        isMandatory,
                        hasData,
                    };
                });

                const totalWeightedAvg = results.reduce((sum, r) => sum + r.weightedAvg, 0);
                const isPassing = totalWeightedAvg <= maxSpecLimit;
                const mandatoryCount = results.filter(r => r.isMandatory).length;
                const testedCount = results.filter(r => r.hasData).length;

                return { results, totalWeightedAvg, isPassing, mandatoryCount, testedCount };
            }, [sieveData, testMethod, maxSpecLimit]);

            const handleReset = () => {
                const resetData = {};
                coarseSieves.forEach(sieve => {
                    resetData[sieve.id] = {
                        percentRetained: '',
                        testSampleMass: '',
                        flatElongatedMass: '',
                        flatMass: '',
                        elongatedMass: '',
                    };
                });
                setSieveData(resetData);
            };

            return (
                <div className="p-4 space-y-4">
                    {/* Header Card */}
                    <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                        <div className="flex items-center justify-between mb-4">
                            <div>
                                <h2 className="text-lg font-bold text-slate-800">
                                    اختبار التفلطح والاستطالة
                                </h2>
                                <p className="english-text text-sm text-slate-500">
                                    Flat & Elongated Particles Test (ASTM D4791)
                                </p>
                            </div>
                            <button
                                onClick={handleReset}
                                className="flex items-center gap-2 px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors text-sm"
                            >
                                <RefreshIcon />
                                <span className="font-medium">إعادة تعيين</span>
                            </button>
                        </div>

                        {/* Test Settings Panel */}
                        <div className="bg-gradient-to-l from-orange-50 to-amber-50 rounded-lg p-4 border border-orange-100">
                            <h3 className="text-sm font-bold text-orange-800 mb-3">
                                إعدادات الاختبار <span className="english-text text-xs font-normal text-orange-600">/ Test Settings</span>
                            </h3>
                            <div className="grid grid-cols-3 gap-4">
                                {/* Test Method Selection */}
                                <div>
                                    <label className="block text-xs font-medium text-slate-700 mb-1">
                                        طريقة الاختبار
                                        <span className="english-text block text-slate-500 font-normal">Test Method</span>
                                    </label>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => setTestMethod('A')}
                                            className={`flex-1 px-3 py-2 rounded-lg text-xs font-bold transition-all ${
                                                testMethod === 'A'
                                                    ? 'bg-orange-500 text-white shadow-md'
                                                    : 'bg-white border border-slate-300 text-slate-600 hover:bg-slate-50'
                                            }`}
                                        >
                                            <div>طريقة A</div>
                                            <div className="english-text font-normal text-xs opacity-80">Combined (Sec 8.4)</div>
                                        </button>
                                        <button
                                            onClick={() => setTestMethod('B')}
                                            className={`flex-1 px-3 py-2 rounded-lg text-xs font-bold transition-all ${
                                                testMethod === 'B'
                                                    ? 'bg-orange-500 text-white shadow-md'
                                                    : 'bg-white border border-slate-300 text-slate-600 hover:bg-slate-50'
                                            }`}
                                        >
                                            <div>طريقة B</div>
                                            <div className="english-text font-normal text-xs opacity-80">Separate (Sec 8.3)</div>
                                        </button>
                                    </div>
                                </div>

                                {/* Dimensional Ratio */}
                                <div>
                                    <label className="block text-xs font-medium text-slate-700 mb-1">
                                        نسبة الأبعاد
                                        <span className="english-text block text-slate-500 font-normal">Dimensional Ratio</span>
                                    </label>
                                    <select
                                        value={dimensionalRatio}
                                        onChange={(e) => setDimensionalRatio(e.target.value)}
                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg text-center english-text font-bold focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none bg-white"
                                    >
                                        <option value="1:2">1:2</option>
                                        <option value="1:3">1:3</option>
                                        <option value="1:5">1:5</option>
                                    </select>
                                </div>

                                {/* Max Spec Limit */}
                                <div>
                                    <label className="block text-xs font-medium text-slate-700 mb-1">
                                        الحد الأقصى المسموح (%)
                                        <span className="english-text block text-slate-500 font-normal">Max Spec Limit (%)</span>
                                    </label>
                                    <input
                                        type="number"
                                        min="0"
                                        max="100"
                                        value={maxSpecLimit}
                                        onChange={(e) => setMaxSpecLimit(parseFloat(e.target.value) || 0)}
                                        className="w-full px-3 py-2 border border-orange-400 rounded-lg text-center english-text font-bold focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none bg-white"
                                        dir="ltr"
                                    />
                                </div>
                            </div>

                            {/* Info Box */}
                            <div className="mt-3 bg-white/60 rounded-lg p-3 border border-orange-200">
                                <div className="flex items-start gap-2">
                                    <AlertTriangleIcon />
                                    <div className="text-xs text-orange-800">
                                        <strong>ملاحظة (Sec 8.2):</strong> يجب اختبار الكسور التي نسبة المحجوز فيها ≥ 10%
                                        <span className="english-text block text-orange-600 mt-1">
                                            Note: Test fractions with ≥ 10% retained (highlighted rows are mandatory)
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Summary Cards */}
                        <div className="grid grid-cols-4 gap-3 mt-4">
                            <div className="bg-blue-50 rounded-lg p-3 border border-blue-100">
                                <div className="text-xl font-bold text-blue-600 english-text">
                                    {calculations.mandatoryCount}
                                </div>
                                <div className="text-xs font-medium text-blue-800">كسور إلزامية</div>
                                <div className="english-text text-xs text-blue-600">Mandatory Fractions</div>
                            </div>
                            <div className="bg-slate-50 rounded-lg p-3 border border-slate-200">
                                <div className="text-xl font-bold text-slate-700 english-text">
                                    {calculations.testedCount} / {coarseSieves.length}
                                </div>
                                <div className="text-xs font-medium text-slate-700">تم اختبارها</div>
                                <div className="english-text text-xs text-slate-500">Tested</div>
                            </div>
                            <div className={`rounded-lg p-3 border ${calculations.isPassing ? 'bg-green-50 border-green-100' : 'bg-red-50 border-red-100'}`}>
                                <div className={`text-xl font-bold english-text ${calculations.isPassing ? 'text-green-600' : 'text-red-600'}`}>
                                    {calculations.totalWeightedAvg.toFixed(1)}%
                                </div>
                                <div className={`text-xs font-medium ${calculations.isPassing ? 'text-green-800' : 'text-red-800'}`}>المتوسط المرجح</div>
                                <div className={`english-text text-xs ${calculations.isPassing ? 'text-green-600' : 'text-red-600'}`}>Weighted Avg.</div>
                            </div>
                            <div className={`rounded-lg p-3 border ${calculations.isPassing ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                                <div className={`text-xl font-bold ${calculations.isPassing ? 'text-green-600' : 'text-red-600'}`}>
                                    {calculations.isPassing ? '✓' : '✗'}
                                </div>
                                <div className={`text-xs font-medium ${calculations.isPassing ? 'text-green-800' : 'text-red-800'}`}>
                                    {calculations.isPassing ? 'مطابق' : 'غير مطابق'}
                                </div>
                                <div className={`english-text text-xs ${calculations.isPassing ? 'text-green-600' : 'text-red-600'}`}>
                                    {calculations.isPassing ? 'PASS' : 'FAIL'}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Main Data Table */}
                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div className="bg-slate-50 border-b border-slate-200 px-4 py-3">
                            <h3 className="text-sm font-bold text-slate-800">
                                جدول بيانات الاختبار
                            </h3>
                            <p className="english-text text-xs text-slate-500">
                                Test Data Table - {testMethod === 'A' ? 'Method A (Combined F&E)' : 'Method B (Separate Flat & Elongated)'}
                            </p>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm" dir="rtl">
                                <thead>
                                    <tr className="bg-slate-800 text-white">
                                        <th className="px-3 py-2 text-right">
                                            <div className="font-bold text-xs">مقاس المنخل</div>
                                            <div className="english-text text-xs text-slate-300 font-normal">Sieve Size</div>
                                        </th>
                                        <th className="px-3 py-2 text-center">
                                            <div className="font-bold text-xs">نسبة المحجوز بالتدرج (%)</div>
                                            <div className="english-text text-xs text-slate-300 font-normal">% Retained (Gradation)</div>
                                        </th>
                                        <th className="px-3 py-2 text-center">
                                            <div className="font-bold text-xs">وزن العينة المختبرة (جم)</div>
                                            <div className="english-text text-xs text-slate-300 font-normal">Test Sample Mass (g)</div>
                                        </th>
                                        {testMethod === 'A' ? (
                                            <th className="px-3 py-2 text-center bg-orange-700">
                                                <div className="font-bold text-xs">وزن المفلطحة والمستطيلة (جم)</div>
                                                <div className="english-text text-xs text-orange-200 font-normal">F&E Mass (g)</div>
                                            </th>
                                        ) : (
                                            <>
                                                <th className="px-3 py-2 text-center bg-amber-700">
                                                    <div className="font-bold text-xs">وزن المفلطحة (جم)</div>
                                                    <div className="english-text text-xs text-amber-200 font-normal">Flat Mass (g)</div>
                                                </th>
                                                <th className="px-3 py-2 text-center bg-orange-700">
                                                    <div className="font-bold text-xs">وزن المستطيلة (جم)</div>
                                                    <div className="english-text text-xs text-orange-200 font-normal">Elongated Mass (g)</div>
                                                </th>
                                            </>
                                        )}
                                        <th className="px-3 py-2 text-center">
                                            <div className="font-bold text-xs">النسبة المئوية (%)</div>
                                            <div className="english-text text-xs text-slate-300 font-normal">% F&E (Individual)</div>
                                        </th>
                                        <th className="px-3 py-2 text-center bg-green-700">
                                            <div className="font-bold text-xs">المتوسط المرجح</div>
                                            <div className="english-text text-xs text-green-200 font-normal">Weighted Avg.</div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {calculations.results.map((row, index) => {
                                        const data = sieveData[row.id];
                                        const isAutoFilled = gradationData && gradationData.length > 0 && data.percentRetained !== '';
                                        
                                        return (
                                            <tr 
                                                key={row.id}
                                                className={`border-b border-slate-100 transition-colors ${
                                                    row.isMandatory 
                                                        ? 'bg-amber-50 hover:bg-amber-100' 
                                                        : index % 2 === 0 
                                                            ? 'bg-white hover:bg-slate-50' 
                                                            : 'bg-slate-50/50 hover:bg-slate-100'
                                                }`}
                                            >
                                                <td className="px-3 py-2">
                                                    <div className="flex items-center gap-2">
                                                        {row.isMandatory && (
                                                            <span className="w-2 h-2 bg-amber-500 rounded-full" title="Mandatory"></span>
                                                        )}
                                                        <div>
                                                            <div className="font-bold text-slate-800 text-xs">{row.sieve.sieveMetric}</div>
                                                            <div className="english-text text-xs text-slate-500">
                                                                ({row.sieve.sieveFrom} to {row.sieve.sieveTo})
                                                            </div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td className="px-3 py-2">
                                                    <div className="relative">
                                                        <input
                                                            type="number"
                                                            min="0"
                                                            max="100"
                                                            step="0.1"
                                                            value={data.percentRetained}
                                                            onChange={(e) => handleInputChange(row.id, 'percentRetained', e.target.value)}
                                                            className={`w-20 px-2 py-1.5 border rounded text-center english-text text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none ${
                                                                isAutoFilled ? 'border-green-400 bg-green-50' : 'border-slate-300 bg-white'
                                                            }`}
                                                            placeholder="0.0"
                                                            dir="ltr"
                                                        />
                                                        {isAutoFilled && (
                                                            <span className="absolute -top-1 -right-1 w-4 h-4 bg-green-500 text-white rounded-full text-xs flex items-center justify-center" title="Auto-filled from C136">
                                                                ✓
                                                            </span>
                                                        )}
                                                    </div>
                                                </td>
                                                <td className="px-3 py-2">
                                                    <input
                                                        type="number"
                                                        min="0"
                                                        step="0.1"
                                                        value={data.testSampleMass}
                                                        onChange={(e) => handleInputChange(row.id, 'testSampleMass', e.target.value)}
                                                        className="w-24 px-2 py-1.5 border border-slate-300 rounded text-center english-text text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none bg-white"
                                                        placeholder={`≥${row.sieve.minSampleMass}`}
                                                        dir="ltr"
                                                    />
                                                </td>
                                                {testMethod === 'A' ? (
                                                    <td className="px-3 py-2 bg-orange-50">
                                                        <input
                                                            type="number"
                                                            min="0"
                                                            step="0.1"
                                                            value={data.flatElongatedMass}
                                                            onChange={(e) => handleInputChange(row.id, 'flatElongatedMass', e.target.value)}
                                                            className="w-24 px-2 py-1.5 border border-orange-300 rounded text-center english-text text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none bg-white"
                                                            placeholder="0.0"
                                                            dir="ltr"
                                                        />
                                                    </td>
                                                ) : (
                                                    <>
                                                        <td className="px-3 py-2 bg-amber-50">
                                                            <input
                                                                type="number"
                                                                min="0"
                                                                step="0.1"
                                                                value={data.flatMass}
                                                                onChange={(e) => handleInputChange(row.id, 'flatMass', e.target.value)}
                                                                className="w-20 px-2 py-1.5 border border-amber-300 rounded text-center english-text text-sm focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none bg-white"
                                                                placeholder="0.0"
                                                                dir="ltr"
                                                            />
                                                        </td>
                                                        <td className="px-3 py-2 bg-orange-50">
                                                            <input
                                                                type="number"
                                                                min="0"
                                                                step="0.1"
                                                                value={data.elongatedMass}
                                                                onChange={(e) => handleInputChange(row.id, 'elongatedMass', e.target.value)}
                                                                className="w-20 px-2 py-1.5 border border-orange-300 rounded text-center english-text text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none bg-white"
                                                                placeholder="0.0"
                                                                dir="ltr"
                                                            />
                                                        </td>
                                                    </>
                                                )}
                                                <td className="px-3 py-2 text-center">
                                                    <span className={`english-text font-bold text-sm ${
                                                        row.hasData 
                                                            ? row.fePercent > maxSpecLimit 
                                                                ? 'text-red-600' 
                                                                : 'text-blue-600'
                                                            : 'text-slate-400'
                                                    }`}>
                                                        {row.hasData ? row.fePercent.toFixed(1) : '-'}
                                                    </span>
                                                    {testMethod === 'B' && row.hasData && (
                                                        <div className="text-xs text-slate-500 english-text mt-1">
                                                            (F: {row.flatPercent.toFixed(1)} + E: {row.elongatedPercent.toFixed(1)})
                                                        </div>
                                                    )}
                                                </td>
                                                <td className="px-3 py-2 text-center bg-green-50">
                                                    <span className={`english-text font-bold text-sm ${
                                                        row.hasData ? 'text-green-700' : 'text-slate-400'
                                                    }`}>
                                                        {row.hasData ? row.weightedAvg.toFixed(2) : '-'}
                                                    </span>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                                <tfoot>
                                    <tr className="bg-slate-100 border-t-2 border-slate-300">
                                        <td colSpan={testMethod === 'A' ? 5 : 6} className="px-3 py-3 text-left">
                                            <div className="font-bold text-slate-700">
                                                مجموع المتوسط المرجح
                                                <span className="english-text text-sm font-normal text-slate-500 mr-2">
                                                    / Total Weighted Average
                                                </span>
                                            </div>
                                        </td>
                                        <td colSpan={2} className="px-3 py-3 text-center">
                                            <span className={`text-xl font-bold english-text ${
                                                calculations.isPassing ? 'text-green-600' : 'text-red-600'
                                            }`}>
                                                {calculations.totalWeightedAvg.toFixed(1)}%
                                            </span>
                                            <span className={`mr-2 px-2 py-1 rounded text-xs font-bold ${
                                                calculations.isPassing 
                                                    ? 'bg-green-100 text-green-700' 
                                                    : 'bg-red-100 text-red-700'
                                            }`}>
                                                {calculations.isPassing ? 'PASS / ناجح' : 'FAIL / راسب'}
                                            </span>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    {/* Formula & Reference Section */}
                    <div className="grid grid-cols-1 xl:grid-cols-2 gap-4">
                        {/* Calculation Formula */}
                        <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                            <h3 className="text-sm font-bold text-slate-800 mb-2">
                                معادلات الحساب <span className="english-text text-xs font-normal text-slate-500">/ Calculation Formulas</span>
                            </h3>
                            <div className="space-y-2">
                                <div className="bg-slate-50 rounded-lg p-3 font-mono text-xs text-center english-text">
                                    % F&E (Individual) = (Mass of F&E Particles ÷ Test Sample Mass) × 100
                                </div>
                                <div className="bg-green-50 rounded-lg p-3 font-mono text-xs text-center english-text border border-green-200">
                                    Weighted Avg = Σ (% F&E × % Retained) ÷ 100
                                </div>
                            </div>
                        </div>

                        {/* Test Reference */}
                        <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                            <h3 className="text-sm font-bold text-slate-800 mb-2">
                                مرجع الاختبار <span className="english-text text-xs font-normal text-slate-500">/ Test Reference</span>
                            </h3>
                            <div className="bg-blue-50 rounded-lg p-3 border border-blue-100">
                                <div className="flex items-center gap-2 mb-2">
                                    <span className="px-2 py-1 bg-blue-600 text-white text-xs font-bold rounded">ASTM D4791</span>
                                    <span className="text-xs text-blue-800">
                                        Standard Test Method for Flat Particles, Elongated Particles, or Flat and Elongated Particles in Coarse Aggregate
                                    </span>
                                </div>
                                <div className="text-xs text-blue-700">
                                    <div>• <strong>Flat:</strong> Width/Thickness {">"} {dimensionalRatio}</div>
                                    <div>• <strong>Elongated:</strong> Length/Width {">"} {dimensionalRatio}</div>
                                    <div>• <strong>F&E:</strong> Meets both flat and elongated criteria</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Final Result Banner */}
                    <div className={`rounded-xl p-4 text-center ${
                        calculations.isPassing 
                            ? 'bg-gradient-to-l from-green-500 to-emerald-600' 
                            : 'bg-gradient-to-l from-red-500 to-rose-600'
                    }`}>
                        <div className="text-white">
                            <div className="text-2xl font-bold mb-1">
                                {calculations.isPassing ? 'النتيجة: مطابق للمواصفات' : 'النتيجة: غير مطابق للمواصفات'}
                            </div>
                            <div className="english-text text-lg opacity-90">
                                {calculations.isPassing ? 'Result: PASS - Within Specification' : 'Result: FAIL - Exceeds Specification'}
                            </div>
                            <div className="english-text text-sm mt-2 opacity-80">
                                Total Weighted F&E: {calculations.totalWeightedAvg.toFixed(1)}% | Limit: ≤ {maxSpecLimit}%
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ============= ASTM C127 - SPECIFIC GRAVITY & ABSORPTION (COARSE) =============
        const SpecificGravityCoarse = () => {
            // Calculation Mode: A = Single Sample, B = Composite/Average
            const [calcMode, setCalcMode] = useState('A');
            const [showRefTable, setShowRefTable] = useState(false);

            // Reference data for min test sample mass (ASTM C127 Sec 7.3)
            const minSampleMassTable = [
                { nominalMax: '12.5 mm (1/2")', minMass: '2 kg' },
                { nominalMax: '19.0 mm (3/4")', minMass: '3 kg' },
                { nominalMax: '25.0 mm (1")', minMass: '4 kg' },
                { nominalMax: '37.5 mm (1½")', minMass: '5 kg' },
                { nominalMax: '50 mm (2")', minMass: '8 kg' },
                { nominalMax: '63 mm (2½")', minMass: '12 kg' },
                { nominalMax: '75 mm (3")', minMass: '18 kg' },
                { nominalMax: '90 mm (3½")', minMass: '25 kg' },
                { nominalMax: '100 mm (4")', minMass: '40 kg' },
                { nominalMax: '125 mm (5")', minMass: '75 kg' },
            ];

            // Mode A: Single Sample State
            const [singleSample, setSingleSample] = useState({
                dryMassA: '',
                ssdMassB: '',
                waterMassC: '',
            });

            // Mode B: Composite/Fractions State
            const [fractions, setFractions] = useState([
                { id: 1, name: 'Size 1" (25mm)', percentage: '', dryMassA: '', ssdMassB: '', waterMassC: '' },
                { id: 2, name: 'Size 3/4" (19mm)', percentage: '', dryMassA: '', ssdMassB: '', waterMassC: '' },
            ]);

            // Add new fraction row
            const addFraction = () => {
                const newId = Math.max(...fractions.map(f => f.id), 0) + 1;
                setFractions([...fractions, {
                    id: newId,
                    name: `Fraction ${newId}`,
                    percentage: '',
                    dryMassA: '',
                    ssdMassB: '',
                    waterMassC: ''
                }]);
            };

            // Remove fraction row
            const removeFraction = (id) => {
                if (fractions.length > 1) {
                    setFractions(fractions.filter(f => f.id !== id));
                }
            };

            // Update fraction data
            const updateFraction = (id, field, value) => {
                setFractions(fractions.map(f => 
                    f.id === id ? { ...f, [field]: value } : f
                ));
            };

            // Calculate single sample results (Sec 9.1)
            const singleResults = useMemo(() => {
                const A = parseFloat(singleSample.dryMassA) || 0;
                const B = parseFloat(singleSample.ssdMassB) || 0;
                const C = parseFloat(singleSample.waterMassC) || 0;

                if (A === 0 || B === 0 || (B - C) === 0) {
                    return { bulkOD: 0, bulkSSD: 0, apparent: 0, absorption: 0, hasData: false };
                }

                // ASTM C127 Formulas (Sec 9.1)
                const bulkOD = A / (B - C);           // Bulk SG (Oven-Dry)
                const bulkSSD = B / (B - C);          // Bulk SG (SSD)
                const apparent = A / (A - C);          // Apparent SG
                const absorption = ((B - A) / A) * 100; // Absorption %

                return {
                    bulkOD: parseFloat(bulkOD.toFixed(2)),
                    bulkSSD: parseFloat(bulkSSD.toFixed(2)),
                    apparent: parseFloat(apparent.toFixed(2)),
                    absorption: parseFloat(absorption.toFixed(1)),
                    hasData: true
                };
            }, [singleSample]);

            // Calculate composite/fraction results (Sec 9.2)
            const compositeResults = useMemo(() => {
                // Calculate individual fraction results
                const fractionResults = fractions.map(f => {
                    const A = parseFloat(f.dryMassA) || 0;
                    const B = parseFloat(f.ssdMassB) || 0;
                    const C = parseFloat(f.waterMassC) || 0;
                    const P = parseFloat(f.percentage) || 0;

                    if (A === 0 || B === 0 || (B - C) === 0) {
                        return { 
                            ...f, 
                            bulkOD: 0, 
                            bulkSSD: 0, 
                            apparent: 0, 
                            absorption: 0, 
                            hasData: false,
                            P
                        };
                    }

                    const bulkOD = A / (B - C);
                    const bulkSSD = B / (B - C);
                    const apparent = A / (A - C);
                    const absorption = ((B - A) / A) * 100;

                    return {
                        ...f,
                        bulkOD: parseFloat(bulkOD.toFixed(3)),
                        bulkSSD: parseFloat(bulkSSD.toFixed(3)),
                        apparent: parseFloat(apparent.toFixed(3)),
                        absorption: parseFloat(absorption.toFixed(2)),
                        hasData: true,
                        P
                    };
                });

                // Calculate total percentage
                const totalP = fractionResults.reduce((sum, f) => sum + f.P, 0);
                const isPValid = Math.abs(totalP - 100) < 0.1;

                // Calculate harmonic mean for SG (Sec 9.2)
                // G_avg = 1 / Σ(P_i / (100 * G_i))
                const validFractions = fractionResults.filter(f => f.hasData && f.P > 0);

                let avgBulkOD = 0, avgBulkSSD = 0, avgApparent = 0;
                
                if (validFractions.length > 0 && isPValid) {
                    // Harmonic mean for specific gravities
                    const sumOD = validFractions.reduce((sum, f) => sum + (f.P / (100 * f.bulkOD)), 0);
                    const sumSSD = validFractions.reduce((sum, f) => sum + (f.P / (100 * f.bulkSSD)), 0);
                    const sumApp = validFractions.reduce((sum, f) => sum + (f.P / (100 * f.apparent)), 0);

                    avgBulkOD = sumOD > 0 ? 1 / sumOD : 0;
                    avgBulkSSD = sumSSD > 0 ? 1 / sumSSD : 0;
                    avgApparent = sumApp > 0 ? 1 / sumApp : 0;
                }

                // Arithmetic mean for absorption (Sec 9.4)
                // Abs_avg = Σ(P_i * A_i) / 100
                const avgAbsorption = validFractions.reduce((sum, f) => sum + (f.P * f.absorption), 0) / 100;

                return {
                    fractionResults,
                    totalP,
                    isPValid,
                    avgBulkOD: parseFloat(avgBulkOD.toFixed(2)),
                    avgBulkSSD: parseFloat(avgBulkSSD.toFixed(2)),
                    avgApparent: parseFloat(avgApparent.toFixed(2)),
                    avgAbsorption: parseFloat(avgAbsorption.toFixed(1)),
                    hasData: validFractions.length > 0
                };
            }, [fractions]);

            const handleReset = () => {
                setSingleSample({ dryMassA: '', ssdMassB: '', waterMassC: '' });
                setFractions([
                    { id: 1, name: 'Size 1" (25mm)', percentage: '', dryMassA: '', ssdMassB: '', waterMassC: '' },
                    { id: 2, name: 'Size 3/4" (19mm)', percentage: '', dryMassA: '', ssdMassB: '', waterMassC: '' },
                ]);
            };

            // Get current results based on mode
            const currentResults = calcMode === 'A' ? singleResults : {
                bulkOD: compositeResults.avgBulkOD,
                bulkSSD: compositeResults.avgBulkSSD,
                apparent: compositeResults.avgApparent,
                absorption: compositeResults.avgAbsorption,
                hasData: compositeResults.hasData
            };

            return (
                <div className="p-4 space-y-4">
                    {/* Header Card */}
                    <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                        <div className="flex items-center justify-between mb-4">
                            <div>
                                <h2 className="text-lg font-bold text-slate-800">
                                    الوزن النوعي والامتصاص - ركام خشن
                                </h2>
                                <p className="english-text text-sm text-slate-500">
                                    Specific Gravity & Absorption of Coarse Aggregate (ASTM C127)
                                </p>
                            </div>
                            <button
                                onClick={handleReset}
                                className="flex items-center gap-2 px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors text-sm"
                            >
                                <RefreshIcon />
                                <span className="font-medium">إعادة تعيين</span>
                            </button>
                        </div>

                        {/* Calculation Mode Toggle */}
                        <div className="bg-gradient-to-l from-teal-50 to-cyan-50 rounded-lg p-4 border border-teal-100">
                            <h3 className="text-sm font-bold text-teal-800 mb-3">
                                طريقة الحساب <span className="english-text text-xs font-normal text-teal-600">/ Calculation Mode</span>
                            </h3>
                            <div className="flex gap-3">
                                <button
                                    onClick={() => setCalcMode('A')}
                                    className={`flex-1 px-4 py-3 rounded-lg transition-all ${
                                        calcMode === 'A'
                                            ? 'bg-teal-600 text-white shadow-lg'
                                            : 'bg-white border border-slate-300 text-slate-600 hover:bg-slate-50'
                                    }`}
                                >
                                    <div className="font-bold">طريقة A - عينة واحدة</div>
                                    <div className="english-text text-xs opacity-80">Mode A: Single Sample (Default)</div>
                                </button>
                                <button
                                    onClick={() => setCalcMode('B')}
                                    className={`flex-1 px-4 py-3 rounded-lg transition-all ${
                                        calcMode === 'B'
                                            ? 'bg-teal-600 text-white shadow-lg'
                                            : 'bg-white border border-slate-300 text-slate-600 hover:bg-slate-50'
                                    }`}
                                >
                                    <div className="font-bold">طريقة B - عينات مجزأة / متوسط</div>
                                    <div className="english-text text-xs opacity-80">Mode B: Composite/Average (Sec 9.2)</div>
                                </button>
                            </div>
                        </div>

                        {/* Reference Table (Collapsible) */}
                        <div className="mt-4">
                            <button
                                onClick={() => setShowRefTable(!showRefTable)}
                                className="flex items-center gap-2 text-sm font-medium text-slate-600 hover:text-slate-800 transition-colors"
                            >
                                <span className={`transform transition-transform ${showRefTable ? 'rotate-90' : ''}`}>▶</span>
                                <span>جدول الحد الأدنى لوزن العينة (Sec 7.3)</span>
                                <span className="english-text text-xs text-slate-400">/ Min Test Sample Mass Table</span>
                            </button>
                            
                            {showRefTable && (
                                <div className="mt-3 bg-slate-50 rounded-lg border border-slate-200 overflow-hidden">
                                    <table className="w-full text-sm">
                                        <thead>
                                            <tr className="bg-slate-200">
                                                <th className="px-3 py-2 text-right font-bold text-slate-700">
                                                    المقاس الاسمي الأقصى
                                                    <span className="english-text block text-xs font-normal text-slate-500">Nominal Max Size</span>
                                                </th>
                                                <th className="px-3 py-2 text-center font-bold text-slate-700">
                                                    الحد الأدنى للوزن
                                                    <span className="english-text block text-xs font-normal text-slate-500">Min Mass</span>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {minSampleMassTable.map((row, i) => (
                                                <tr key={i} className={i % 2 === 0 ? 'bg-white' : 'bg-slate-50'}>
                                                    <td className="px-3 py-1.5 english-text text-slate-700">{row.nominalMax}</td>
                                                    <td className="px-3 py-1.5 text-center english-text font-bold text-teal-700">{row.minMass}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Mode A: Single Sample Input */}
                    {calcMode === 'A' && (
                        <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                            <div className="bg-slate-50 border-b border-slate-200 px-4 py-3">
                                <h3 className="text-sm font-bold text-slate-800">
                                    بيانات العينة الواحدة
                                </h3>
                                <p className="english-text text-xs text-slate-500">
                                    Single Sample Data Entry (Sec 9.1)
                                </p>
                            </div>
                            <div className="p-4">
                                <div className="grid grid-cols-3 gap-4">
                                    {/* Mass A - Dry */}
                                    <div className="bg-amber-50 rounded-lg p-4 border border-amber-200">
                                        <label className="block text-sm font-bold text-amber-800 mb-2">
                                            A - الكتلة الجافة (جم)
                                            <span className="english-text block text-xs font-normal text-amber-600">Oven-Dry Mass (g)</span>
                                        </label>
                                        <input
                                            type="number"
                                            min="0"
                                            step="0.1"
                                            value={singleSample.dryMassA}
                                            onChange={(e) => setSingleSample(p => ({ ...p, dryMassA: e.target.value }))}
                                            className="w-full px-4 py-3 border-2 border-amber-300 rounded-lg text-center english-text text-lg font-bold focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none bg-white"
                                            placeholder="0.0"
                                            dir="ltr"
                                        />
                                    </div>

                                    {/* Mass B - SSD */}
                                    <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                                        <label className="block text-sm font-bold text-blue-800 mb-2">
                                            B - كتلة المشبع جاف السطح (جم)
                                            <span className="english-text block text-xs font-normal text-blue-600">SSD Mass (g)</span>
                                        </label>
                                        <input
                                            type="number"
                                            min="0"
                                            step="0.1"
                                            value={singleSample.ssdMassB}
                                            onChange={(e) => setSingleSample(p => ({ ...p, ssdMassB: e.target.value }))}
                                            className="w-full px-4 py-3 border-2 border-blue-300 rounded-lg text-center english-text text-lg font-bold focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white"
                                            placeholder="0.0"
                                            dir="ltr"
                                        />
                                    </div>

                                    {/* Mass C - Water */}
                                    <div className="bg-cyan-50 rounded-lg p-4 border border-cyan-200">
                                        <label className="block text-sm font-bold text-cyan-800 mb-2">
                                            C - الكتلة الظاهرية في الماء (جم)
                                            <span className="english-text block text-xs font-normal text-cyan-600">Apparent Mass in Water (g)</span>
                                        </label>
                                        <input
                                            type="number"
                                            min="0"
                                            step="0.1"
                                            value={singleSample.waterMassC}
                                            onChange={(e) => setSingleSample(p => ({ ...p, waterMassC: e.target.value }))}
                                            className="w-full px-4 py-3 border-2 border-cyan-300 rounded-lg text-center english-text text-lg font-bold focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 outline-none bg-white"
                                            placeholder="0.0"
                                            dir="ltr"
                                        />
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Mode B: Composite/Fractions Input */}
                    {calcMode === 'B' && (
                        <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                            <div className="bg-slate-50 border-b border-slate-200 px-4 py-3 flex items-center justify-between">
                                <div>
                                    <h3 className="text-sm font-bold text-slate-800">
                                        بيانات الكسور المجزأة
                                    </h3>
                                    <p className="english-text text-xs text-slate-500">
                                        Composite Fractions Data Entry (Sec 9.2)
                                    </p>
                                </div>
                                <button
                                    onClick={addFraction}
                                    className="flex items-center gap-1 px-3 py-1.5 bg-teal-600 hover:bg-teal-700 text-white rounded-lg transition-colors text-sm font-medium"
                                >
                                    <span>+</span>
                                    <span>إضافة كسر</span>
                                    <span className="english-text text-xs opacity-80">/ Add Fraction</span>
                                </button>
                            </div>

                            {/* Percentage Validation */}
                            <div className={`px-4 py-2 flex items-center justify-between ${
                                compositeResults.isPValid ? 'bg-green-100' : 'bg-red-100'
                            }`}>
                                <div className="flex items-center gap-2">
                                    {compositeResults.isPValid ? <CheckCircleIcon /> : <AlertTriangleIcon />}
                                    <span className={`text-sm font-bold ${compositeResults.isPValid ? 'text-green-700' : 'text-red-700'}`}>
                                        مجموع النسب: {compositeResults.totalP.toFixed(1)}%
                                    </span>
                                </div>
                                <span className={`english-text text-sm ${compositeResults.isPValid ? 'text-green-600' : 'text-red-600'}`}>
                                    {compositeResults.isPValid ? 'Total = 100% ✓' : 'Adjust to reach 100%'}
                                </span>
                            </div>

                            <div className="overflow-x-auto">
                                <table className="w-full text-sm" dir="rtl">
                                    <thead>
                                        <tr className="bg-slate-800 text-white">
                                            <th className="px-2 py-2 text-right w-8"></th>
                                            <th className="px-2 py-2 text-right">
                                                <div className="font-bold text-xs">اسم الكسر</div>
                                                <div className="english-text text-xs text-slate-300 font-normal">Fraction Name</div>
                                            </th>
                                            <th className="px-2 py-2 text-center bg-purple-700">
                                                <div className="font-bold text-xs">النسبة P%</div>
                                                <div className="english-text text-xs text-purple-200 font-normal">Percentage P%</div>
                                            </th>
                                            <th className="px-2 py-2 text-center bg-amber-700">
                                                <div className="font-bold text-xs">A - جاف (جم)</div>
                                                <div className="english-text text-xs text-amber-200 font-normal">A - Dry (g)</div>
                                            </th>
                                            <th className="px-2 py-2 text-center bg-blue-700">
                                                <div className="font-bold text-xs">B - مشبع (جم)</div>
                                                <div className="english-text text-xs text-blue-200 font-normal">B - SSD (g)</div>
                                            </th>
                                            <th className="px-2 py-2 text-center bg-cyan-700">
                                                <div className="font-bold text-xs">C - في الماء (جم)</div>
                                                <div className="english-text text-xs text-cyan-200 font-normal">C - Water (g)</div>
                                            </th>
                                            <th className="px-2 py-2 text-center bg-teal-700">
                                                <div className="font-bold text-xs">G (OD)</div>
                                                <div className="english-text text-xs text-teal-200 font-normal">Bulk SG</div>
                                            </th>
                                            <th className="px-2 py-2 text-center bg-green-700">
                                                <div className="font-bold text-xs">الامتصاص %</div>
                                                <div className="english-text text-xs text-green-200 font-normal">Abs. %</div>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {compositeResults.fractionResults.map((f, index) => (
                                            <tr key={f.id} className={index % 2 === 0 ? 'bg-white' : 'bg-slate-50'}>
                                                <td className="px-2 py-2 text-center">
                                                    <button
                                                        onClick={() => removeFraction(f.id)}
                                                        className="w-6 h-6 rounded-full bg-red-100 hover:bg-red-200 text-red-600 text-xs font-bold transition-colors"
                                                        disabled={fractions.length <= 1}
                                                    >
                                                        ×
                                                    </button>
                                                </td>
                                                <td className="px-2 py-2">
                                                    <input
                                                        type="text"
                                                        value={f.name}
                                                        onChange={(e) => updateFraction(f.id, 'name', e.target.value)}
                                                        className="w-32 px-2 py-1.5 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500 outline-none"
                                                        placeholder="Fraction name"
                                                    />
                                                </td>
                                                <td className="px-2 py-2 bg-purple-50">
                                                    <input
                                                        type="number"
                                                        min="0"
                                                        max="100"
                                                        step="0.1"
                                                        value={f.percentage}
                                                        onChange={(e) => updateFraction(f.id, 'percentage', e.target.value)}
                                                        className="w-20 px-2 py-1.5 border border-purple-300 rounded text-center english-text text-sm font-bold focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none bg-white"
                                                        placeholder="0"
                                                        dir="ltr"
                                                    />
                                                </td>
                                                <td className="px-2 py-2 bg-amber-50">
                                                    <input
                                                        type="number"
                                                        min="0"
                                                        step="0.1"
                                                        value={f.dryMassA}
                                                        onChange={(e) => updateFraction(f.id, 'dryMassA', e.target.value)}
                                                        className="w-24 px-2 py-1.5 border border-amber-300 rounded text-center english-text text-sm focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none bg-white"
                                                        placeholder="0.0"
                                                        dir="ltr"
                                                    />
                                                </td>
                                                <td className="px-2 py-2 bg-blue-50">
                                                    <input
                                                        type="number"
                                                        min="0"
                                                        step="0.1"
                                                        value={f.ssdMassB}
                                                        onChange={(e) => updateFraction(f.id, 'ssdMassB', e.target.value)}
                                                        className="w-24 px-2 py-1.5 border border-blue-300 rounded text-center english-text text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white"
                                                        placeholder="0.0"
                                                        dir="ltr"
                                                    />
                                                </td>
                                                <td className="px-2 py-2 bg-cyan-50">
                                                    <input
                                                        type="number"
                                                        min="0"
                                                        step="0.1"
                                                        value={f.waterMassC}
                                                        onChange={(e) => updateFraction(f.id, 'waterMassC', e.target.value)}
                                                        className="w-24 px-2 py-1.5 border border-cyan-300 rounded text-center english-text text-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 outline-none bg-white"
                                                        placeholder="0.0"
                                                        dir="ltr"
                                                    />
                                                </td>
                                                <td className="px-2 py-2 text-center bg-teal-50">
                                                    <span className={`english-text font-bold ${f.hasData ? 'text-teal-700' : 'text-slate-400'}`}>
                                                        {f.hasData ? f.bulkOD.toFixed(3) : '-'}
                                                    </span>
                                                </td>
                                                <td className="px-2 py-2 text-center bg-green-50">
                                                    <span className={`english-text font-bold ${f.hasData ? 'text-green-700' : 'text-slate-400'}`}>
                                                        {f.hasData ? f.absorption.toFixed(2) : '-'}
                                                    </span>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* Results Section */}
                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div className="bg-gradient-to-l from-teal-600 to-cyan-600 px-4 py-3">
                            <h3 className="text-sm font-bold text-white">
                                النتائج المحسوبة
                                <span className="english-text text-xs font-normal text-teal-100 mr-2">/ Calculated Results</span>
                            </h3>
                        </div>
                        <div className="p-4">
                            <div className="grid grid-cols-4 gap-4">
                                {/* Bulk SG (OD) */}
                                <div className="bg-gradient-to-br from-amber-50 to-amber-100 rounded-xl p-4 border border-amber-200">
                                    <div className="text-xs font-medium text-amber-800 mb-1">
                                        الوزن النوعي الظاهري (OD)
                                        <span className="english-text block text-amber-600">Bulk SG (Oven-Dry)</span>
                                    </div>
                                    <div className={`text-3xl font-bold english-text ${currentResults.hasData ? 'text-amber-700' : 'text-slate-300'}`}>
                                        {currentResults.hasData ? currentResults.bulkOD.toFixed(2) : '-'}
                                    </div>
                                    <div className="english-text text-xs text-amber-600 mt-1 font-mono">
                                        A / (B - C)
                                    </div>
                                </div>

                                {/* Bulk SG (SSD) */}
                                <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 border border-blue-200">
                                    <div className="text-xs font-medium text-blue-800 mb-1">
                                        الوزن النوعي الظاهري (SSD)
                                        <span className="english-text block text-blue-600">Bulk SG (SSD)</span>
                                    </div>
                                    <div className={`text-3xl font-bold english-text ${currentResults.hasData ? 'text-blue-700' : 'text-slate-300'}`}>
                                        {currentResults.hasData ? currentResults.bulkSSD.toFixed(2) : '-'}
                                    </div>
                                    <div className="english-text text-xs text-blue-600 mt-1 font-mono">
                                        B / (B - C)
                                    </div>
                                </div>

                                {/* Apparent SG */}
                                <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-4 border border-purple-200">
                                    <div className="text-xs font-medium text-purple-800 mb-1">
                                        الوزن النوعي الحقيقي
                                        <span className="english-text block text-purple-600">Apparent SG</span>
                                    </div>
                                    <div className={`text-3xl font-bold english-text ${currentResults.hasData ? 'text-purple-700' : 'text-slate-300'}`}>
                                        {currentResults.hasData ? currentResults.apparent.toFixed(2) : '-'}
                                    </div>
                                    <div className="english-text text-xs text-purple-600 mt-1 font-mono">
                                        A / (A - C)
                                    </div>
                                </div>

                                {/* Absorption */}
                                <div className="bg-gradient-to-br from-green-50 to-emerald-100 rounded-xl p-4 border border-green-200">
                                    <div className="text-xs font-medium text-green-800 mb-1">
                                        نسبة الامتصاص (%)
                                        <span className="english-text block text-green-600">Absorption (%)</span>
                                    </div>
                                    <div className={`text-3xl font-bold english-text ${currentResults.hasData ? 'text-green-700' : 'text-slate-300'}`}>
                                        {currentResults.hasData ? currentResults.absorption.toFixed(1) : '-'}
                                        {currentResults.hasData && <span className="text-lg">%</span>}
                                    </div>
                                    <div className="english-text text-xs text-green-600 mt-1 font-mono">
                                        ((B - A) / A) × 100
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Formulas Reference */}
                    <div className="grid grid-cols-1 xl:grid-cols-2 gap-4">
                        {/* Basic Formulas */}
                        <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                            <h3 className="text-sm font-bold text-slate-800 mb-3">
                                معادلات الحساب الأساسية (Sec 9.1)
                                <span className="english-text text-xs font-normal text-slate-500 mr-2">/ Basic Calculation Formulas</span>
                            </h3>
                            <div className="space-y-2 text-xs">
                                <div className="bg-amber-50 rounded-lg p-2 border border-amber-200 font-mono english-text">
                                    <strong>Bulk SG (OD)</strong> = A / (B - C)
                                </div>
                                <div className="bg-blue-50 rounded-lg p-2 border border-blue-200 font-mono english-text">
                                    <strong>Bulk SG (SSD)</strong> = B / (B - C)
                                </div>
                                <div className="bg-purple-50 rounded-lg p-2 border border-purple-200 font-mono english-text">
                                    <strong>Apparent SG</strong> = A / (A - C)
                                </div>
                                <div className="bg-green-50 rounded-lg p-2 border border-green-200 font-mono english-text">
                                    <strong>Absorption %</strong> = ((B - A) / A) × 100
                                </div>
                            </div>
                        </div>

                        {/* Composite Formulas (Mode B) */}
                        <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                            <h3 className="text-sm font-bold text-slate-800 mb-3">
                                معادلات المتوسط المرجح (Sec 9.2 & 9.4)
                                <span className="english-text text-xs font-normal text-slate-500 mr-2">/ Average Formulas</span>
                            </h3>
                            <div className="space-y-2 text-xs">
                                <div className="bg-teal-50 rounded-lg p-3 border border-teal-200">
                                    <div className="font-bold text-teal-800 mb-1">المتوسط التوافقي للوزن النوعي (Harmonic Mean):</div>
                                    <div className="font-mono english-text text-teal-700 text-center">
                                        G<sub>avg</sub> = 1 / Σ(P<sub>i</sub> / (100 × G<sub>i</sub>))
                                    </div>
                                </div>
                                <div className="bg-green-50 rounded-lg p-3 border border-green-200">
                                    <div className="font-bold text-green-800 mb-1">المتوسط الحسابي للامتصاص (Arithmetic Mean):</div>
                                    <div className="font-mono english-text text-green-700 text-center">
                                        Abs<sub>avg</sub> = Σ(P<sub>i</sub> × A<sub>i</sub>) / 100
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Test Reference */}
                    <div className="bg-gradient-to-l from-slate-700 to-slate-800 rounded-xl p-4 text-white">
                        <div className="flex items-center gap-3">
                            <span className="px-3 py-1.5 bg-teal-500 text-white font-bold rounded-lg text-sm">ASTM C127</span>
                            <div>
                                <div className="font-bold text-sm">
                                    Standard Test Method for Relative Density (Specific Gravity) and Absorption of Coarse Aggregate
                                </div>
                                <div className="text-slate-300 text-xs english-text">
                                    طريقة الاختبار القياسية للكثافة النسبية (الوزن النوعي) وامتصاص الركام الخشن
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ============= ASTM C128 - SPECIFIC GRAVITY & ABSORPTION (FINE) =============
        const SpecificGravityFine = () => {
            // Procedure Method: A = Gravimetric (Pycnometer), B = Volumetric (Le Chatelier)
            const [procedureMethod, setProcedureMethod] = useState('A');
            const [showSSDInfo, setShowSSDInfo] = useState(false);

            // Common Inputs (Both Methods)
            const [commonInputs, setCommonInputs] = useState({
                dryMassA: '',      // A: Mass of Oven-Dry Specimen (g)
                ssdMassS: '',      // S: Mass of SSD Specimen (g) - usually 500g for pycnometer
            });

            // Method A (Pycnometer) Inputs
            const [pycnometerInputs, setPycnometerInputs] = useState({
                pycnometerWaterB: '',   // B: Mass of Pycnometer filled with water (g)
                pycnometerSpecimenC: '', // C: Mass of Pycnometer with specimen + water (g)
            });

            // Method B (Volumetric/Le Chatelier) Inputs
            const [volumetricInputs, setVolumetricInputs] = useState({
                ssdMassS1: '',     // S1: Mass of SSD specimen used in flask (usually ~55g)
                initialReadR1: '', // R1: Initial Reading of water level (mL)
                finalReadR2: '',   // R2: Final Reading of water level (mL)
            });

            // Calculate Method A (Pycnometer) results - Section 10.1
            const pycnometerResults = useMemo(() => {
                const A = parseFloat(commonInputs.dryMassA) || 0;
                const S = parseFloat(commonInputs.ssdMassS) || 0;
                const B = parseFloat(pycnometerInputs.pycnometerWaterB) || 0;
                const C = parseFloat(pycnometerInputs.pycnometerSpecimenC) || 0;

                if (A === 0 || S === 0 || B === 0 || C === 0) {
                    return { bulkOD: 0, bulkSSD: 0, apparent: 0, absorption: 0, hasData: false };
                }

                const denominator = B + S - C;
                if (denominator === 0) {
                    return { bulkOD: 0, bulkSSD: 0, apparent: 0, absorption: 0, hasData: false };
                }

                // ASTM C128 Section 10.1 Formulas
                const bulkOD = A / denominator;           // Bulk SG (Oven-Dry)
                const bulkSSD = S / denominator;          // Bulk SG (SSD)
                const apparent = A / (B + A - C);          // Apparent SG
                const absorption = ((S - A) / A) * 100;    // Absorption %

                return {
                    bulkOD: parseFloat(bulkOD.toFixed(2)),
                    bulkSSD: parseFloat(bulkSSD.toFixed(2)),
                    apparent: parseFloat(apparent.toFixed(2)),
                    absorption: parseFloat(absorption.toFixed(1)),
                    hasData: true
                };
            }, [commonInputs, pycnometerInputs]);

            // Calculate Method B (Volumetric) results - Section 10.2
            const volumetricResults = useMemo(() => {
                const A = parseFloat(commonInputs.dryMassA) || 0;
                const S = parseFloat(commonInputs.ssdMassS) || 0;
                const S1 = parseFloat(volumetricInputs.ssdMassS1) || 0;
                const R1 = parseFloat(volumetricInputs.initialReadR1) || 0;
                const R2 = parseFloat(volumetricInputs.finalReadR2) || 0;

                if (A === 0 || S === 0 || S1 === 0 || R1 === 0 || R2 === 0) {
                    return { bulkOD: 0, bulkSSD: 0, apparent: 0, absorption: 0, volume: 0, hasData: false };
                }

                // Temperature correction factor (10.2.1.2) - using 0.9975 for ~23°C
                const tempFactor = 0.9975;
                const volume = tempFactor * (R2 - R1);

                if (volume === 0) {
                    return { bulkOD: 0, bulkSSD: 0, apparent: 0, absorption: 0, volume: 0, hasData: false };
                }

                // ASTM C128 Section 10.2 Formulas
                const bulkOD = (S1 * (A / S)) / volume;    // Bulk SG (OD)
                const bulkSSD = S1 / volume;                // Bulk SG (SSD)
                
                // Apparent SG formula from 10.2.1.2
                const apparentNum = S1 * (A / S);
                const apparentDenom = tempFactor * (R2 - R1) - ((S1 / S) * (S - A));
                const apparent = apparentDenom !== 0 ? apparentNum / apparentDenom : 0;
                
                const absorption = ((S - A) / A) * 100;    // Absorption %

                return {
                    bulkOD: parseFloat(bulkOD.toFixed(2)),
                    bulkSSD: parseFloat(bulkSSD.toFixed(2)),
                    apparent: parseFloat(apparent.toFixed(2)),
                    absorption: parseFloat(absorption.toFixed(1)),
                    volume: parseFloat(volume.toFixed(2)),
                    hasData: true
                };
            }, [commonInputs, volumetricInputs]);

            // Get current results based on method
            const currentResults = procedureMethod === 'A' ? pycnometerResults : volumetricResults;

            const handleReset = () => {
                setCommonInputs({ dryMassA: '', ssdMassS: '' });
                setPycnometerInputs({ pycnometerWaterB: '', pycnometerSpecimenC: '' });
                setVolumetricInputs({ ssdMassS1: '', initialReadR1: '', finalReadR2: '' });
            };

            return (
                <div className="p-4 space-y-4">
                    {/* Header Card */}
                    <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                        <div className="flex items-center justify-between mb-4">
                            <div>
                                <h2 className="text-lg font-bold text-slate-800">
                                    الوزن النوعي والامتصاص - ركام ناعم
                                </h2>
                                <p className="english-text text-sm text-slate-500">
                                    Specific Gravity & Absorption of Fine Aggregate (ASTM C128)
                                </p>
                            </div>
                            <button
                                onClick={handleReset}
                                className="flex items-center gap-2 px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors text-sm"
                            >
                                <RefreshIcon />
                                <span className="font-medium">إعادة تعيين</span>
                            </button>
                        </div>

                        {/* Procedure Method Toggle */}
                        <div className="bg-gradient-to-l from-indigo-50 to-violet-50 rounded-lg p-4 border border-indigo-100">
                            <h3 className="text-sm font-bold text-indigo-800 mb-3">
                                طريقة الإجراء (القسم 9) <span className="english-text text-xs font-normal text-indigo-600">/ Procedure Method (Section 9)</span>
                            </h3>
                            <div className="flex gap-3">
                                <button
                                    onClick={() => setProcedureMethod('A')}
                                    className={`flex-1 px-4 py-3 rounded-lg transition-all ${
                                        procedureMethod === 'A'
                                            ? 'bg-indigo-600 text-white shadow-lg'
                                            : 'bg-white border border-slate-300 text-slate-600 hover:bg-slate-50'
                                    }`}
                                >
                                    <div className="font-bold">طريقة A - القنينة (الوزنية)</div>
                                    <div className="english-text text-xs opacity-80">Method A: Gravimetric (Pycnometer)</div>
                                </button>
                                <button
                                    onClick={() => setProcedureMethod('B')}
                                    className={`flex-1 px-4 py-3 rounded-lg transition-all ${
                                        procedureMethod === 'B'
                                            ? 'bg-indigo-600 text-white shadow-lg'
                                            : 'bg-white border border-slate-300 text-slate-600 hover:bg-slate-50'
                                    }`}
                                >
                                    <div className="font-bold">طريقة B - دورق لوشاتلييه (الحجمية)</div>
                                    <div className="english-text text-xs opacity-80">Method B: Volumetric (Le Chatelier Flask)</div>
                                </button>
                            </div>
                        </div>

                        {/* SSD Check Info Box (Collapsible) */}
                        <div className="mt-4">
                            <button
                                onClick={() => setShowSSDInfo(!showSSDInfo)}
                                className="flex items-center gap-2 text-sm font-medium text-slate-600 hover:text-slate-800 transition-colors"
                            >
                                <span className={`transform transition-transform ${showSSDInfo ? 'rotate-90' : ''}`}>▶</span>
                                <span>التحقق من حالة SSD (اختبار المخروط - القسم 8.3)</span>
                                <span className="english-text text-xs text-slate-400">/ SSD Check (Cone Test - Sec 8.3)</span>
                            </button>
                            
                            {showSSDInfo && (
                                <div className="mt-3 bg-amber-50 rounded-lg border border-amber-200 p-4">
                                    <div className="flex items-start gap-3">
                                        <div className="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center text-amber-600">
                                            <AlertTriangleIcon />
                                        </div>
                                        <div>
                                            <h4 className="font-bold text-amber-800 text-sm mb-2">
                                                اختبار المخروط لتحديد حالة التشبع السطحي الجاف
                                            </h4>
                                            <div className="text-xs text-amber-700 space-y-1">
                                                <p>١. ضع المخروط المعدني على سطح مستوٍ غير ماص.</p>
                                                <p>٢. املأ المخروط بالركام الناعم بشكل فضفاض.</p>
                                                <p>٣. اضغط برفق 25 مرة باستخدام المدكة.</p>
                                                <p>٤. ارفع المخروط عمودياً.</p>
                                                <p className="font-bold">٥. إذا انهار الركام قليلاً → تم الوصول لحالة SSD ✓</p>
                                            </div>
                                            <div className="english-text text-xs text-amber-600 mt-3 border-t border-amber-200 pt-2">
                                                <p><strong>Cone Test Procedure:</strong></p>
                                                <p>Fill cone loosely, tamp 25 times with tamper, lift cone vertically.</p>
                                                <p><strong>Result:</strong> If removing mold causes slight slump → SSD condition reached ✓</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Common Inputs Section */}
                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div className="bg-slate-50 border-b border-slate-200 px-4 py-3">
                            <h3 className="text-sm font-bold text-slate-800">
                                البيانات المشتركة
                            </h3>
                            <p className="english-text text-xs text-slate-500">
                                Common Input Data (Required for both methods)
                            </p>
                        </div>
                        <div className="p-4">
                            <div className="grid grid-cols-2 gap-4">
                                {/* Mass A - Dry */}
                                <div className="bg-amber-50 rounded-lg p-4 border border-amber-200">
                                    <label className="block text-sm font-bold text-amber-800 mb-2">
                                        A - كتلة العينة المجففة (جم)
                                        <span className="english-text block text-xs font-normal text-amber-600">Mass of Oven-Dry Specimen (g)</span>
                                    </label>
                                    <input
                                        type="number"
                                        min="0"
                                        step="0.1"
                                        value={commonInputs.dryMassA}
                                        onChange={(e) => setCommonInputs(p => ({ ...p, dryMassA: e.target.value }))}
                                        className="w-full px-4 py-3 border-2 border-amber-300 rounded-lg text-center english-text text-lg font-bold focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none bg-white"
                                        placeholder="0.0"
                                        dir="ltr"
                                    />
                                </div>

                                {/* Mass S - SSD */}
                                <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                                    <label className="block text-sm font-bold text-blue-800 mb-2">
                                        S - كتلة العينة المشبعة جافة السطح (جم)
                                        <span className="english-text block text-xs font-normal text-blue-600">Mass of SSD Specimen (g) - Usually 500g</span>
                                    </label>
                                    <input
                                        type="number"
                                        min="0"
                                        step="0.1"
                                        value={commonInputs.ssdMassS}
                                        onChange={(e) => setCommonInputs(p => ({ ...p, ssdMassS: e.target.value }))}
                                        className="w-full px-4 py-3 border-2 border-blue-300 rounded-lg text-center english-text text-lg font-bold focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white"
                                        placeholder="500.0"
                                        dir="ltr"
                                    />
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Method A: Pycnometer Inputs */}
                    {procedureMethod === 'A' && (
                        <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                            <div className="bg-gradient-to-l from-indigo-600 to-violet-600 px-4 py-3">
                                <h3 className="text-sm font-bold text-white">
                                    بيانات طريقة القنينة (A)
                                    <span className="english-text text-xs font-normal text-indigo-100 mr-2">/ Pycnometer Method (A) - Section 9.1</span>
                                </h3>
                            </div>
                            <div className="p-4">
                                <div className="grid grid-cols-2 gap-4">
                                    {/* B - Pycnometer with Water */}
                                    <div className="bg-cyan-50 rounded-lg p-4 border border-cyan-200">
                                        <label className="block text-sm font-bold text-cyan-800 mb-2">
                                            B - كتلة القنينة مملوءة بالماء (جم)
                                            <span className="english-text block text-xs font-normal text-cyan-600">Mass of Pycnometer filled with water (g)</span>
                                        </label>
                                        <input
                                            type="number"
                                            min="0"
                                            step="0.1"
                                            value={pycnometerInputs.pycnometerWaterB}
                                            onChange={(e) => setPycnometerInputs(p => ({ ...p, pycnometerWaterB: e.target.value }))}
                                            className="w-full px-4 py-3 border-2 border-cyan-300 rounded-lg text-center english-text text-lg font-bold focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 outline-none bg-white"
                                            placeholder="0.0"
                                            dir="ltr"
                                        />
                                    </div>

                                    {/* C - Pycnometer with Specimen + Water */}
                                    <div className="bg-purple-50 rounded-lg p-4 border border-purple-200">
                                        <label className="block text-sm font-bold text-purple-800 mb-2">
                                            C - كتلة القنينة + العينة + الماء (جم)
                                            <span className="english-text block text-xs font-normal text-purple-600">Mass of Pycnometer with specimen + water (g)</span>
                                        </label>
                                        <input
                                            type="number"
                                            min="0"
                                            step="0.1"
                                            value={pycnometerInputs.pycnometerSpecimenC}
                                            onChange={(e) => setPycnometerInputs(p => ({ ...p, pycnometerSpecimenC: e.target.value }))}
                                            className="w-full px-4 py-3 border-2 border-purple-300 rounded-lg text-center english-text text-lg font-bold focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none bg-white"
                                            placeholder="0.0"
                                            dir="ltr"
                                        />
                                    </div>
                                </div>

                                {/* Diagram/Visual Aid */}
                                <div className="mt-4 bg-slate-50 rounded-lg p-4 border border-slate-200">
                                    <div className="text-center">
                                        <div className="inline-flex items-center gap-4 text-sm">
                                            <div className="bg-cyan-100 px-3 py-2 rounded-lg border border-cyan-300">
                                                <div className="font-bold text-cyan-700">B</div>
                                                <div className="english-text text-xs text-cyan-600">Pycno + H₂O</div>
                                            </div>
                                            <span className="text-2xl text-slate-400">+</span>
                                            <div className="bg-blue-100 px-3 py-2 rounded-lg border border-blue-300">
                                                <div className="font-bold text-blue-700">S</div>
                                                <div className="english-text text-xs text-blue-600">SSD Sample</div>
                                            </div>
                                            <span className="text-2xl text-slate-400">−</span>
                                            <div className="bg-purple-100 px-3 py-2 rounded-lg border border-purple-300">
                                                <div className="font-bold text-purple-700">C</div>
                                                <div className="english-text text-xs text-purple-600">Pycno + Sample + H₂O</div>
                                            </div>
                                            <span className="text-2xl text-slate-400">=</span>
                                            <div className="bg-green-100 px-3 py-2 rounded-lg border border-green-300">
                                                <div className="font-bold text-green-700">Denominator</div>
                                                <div className="english-text text-xs text-green-600">For SG Calculation</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Method B: Volumetric Inputs */}
                    {procedureMethod === 'B' && (
                        <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                            <div className="bg-gradient-to-l from-teal-600 to-emerald-600 px-4 py-3">
                                <h3 className="text-sm font-bold text-white">
                                    بيانات طريقة دورق لوشاتلييه (B)
                                    <span className="english-text text-xs font-normal text-teal-100 mr-2">/ Le Chatelier Flask Method (B) - Section 9.2</span>
                                </h3>
                            </div>
                            <div className="p-4">
                                <div className="grid grid-cols-3 gap-4">
                                    {/* S1 - SSD mass in flask */}
                                    <div className="bg-teal-50 rounded-lg p-4 border border-teal-200">
                                        <label className="block text-sm font-bold text-teal-800 mb-2">
                                            S₁ - كتلة العينة SSD في الدورق (جم)
                                            <span className="english-text block text-xs font-normal text-teal-600">SSD specimen mass in flask (g) - ~55g</span>
                                        </label>
                                        <input
                                            type="number"
                                            min="0"
                                            step="0.1"
                                            value={volumetricInputs.ssdMassS1}
                                            onChange={(e) => setVolumetricInputs(p => ({ ...p, ssdMassS1: e.target.value }))}
                                            className="w-full px-4 py-3 border-2 border-teal-300 rounded-lg text-center english-text text-lg font-bold focus:ring-2 focus:ring-teal-500 focus:border-teal-500 outline-none bg-white"
                                            placeholder="55.0"
                                            dir="ltr"
                                        />
                                    </div>

                                    {/* R1 - Initial Reading */}
                                    <div className="bg-sky-50 rounded-lg p-4 border border-sky-200">
                                        <label className="block text-sm font-bold text-sky-800 mb-2">
                                            R₁ - القراءة الابتدائية (مل)
                                            <span className="english-text block text-xs font-normal text-sky-600">Initial water level reading (mL)</span>
                                        </label>
                                        <input
                                            type="number"
                                            min="0"
                                            step="0.1"
                                            value={volumetricInputs.initialReadR1}
                                            onChange={(e) => setVolumetricInputs(p => ({ ...p, initialReadR1: e.target.value }))}
                                            className="w-full px-4 py-3 border-2 border-sky-300 rounded-lg text-center english-text text-lg font-bold focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none bg-white"
                                            placeholder="0.0"
                                            dir="ltr"
                                        />
                                    </div>

                                    {/* R2 - Final Reading */}
                                    <div className="bg-emerald-50 rounded-lg p-4 border border-emerald-200">
                                        <label className="block text-sm font-bold text-emerald-800 mb-2">
                                            R₂ - القراءة النهائية (مل)
                                            <span className="english-text block text-xs font-normal text-emerald-600">Final water level reading (mL)</span>
                                        </label>
                                        <input
                                            type="number"
                                            min="0"
                                            step="0.1"
                                            value={volumetricInputs.finalReadR2}
                                            onChange={(e) => setVolumetricInputs(p => ({ ...p, finalReadR2: e.target.value }))}
                                            className="w-full px-4 py-3 border-2 border-emerald-300 rounded-lg text-center english-text text-lg font-bold focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none bg-white"
                                            placeholder="0.0"
                                            dir="ltr"
                                        />
                                    </div>
                                </div>

                                {/* Volume Calculation Display */}
                                {volumetricResults.hasData && (
                                    <div className="mt-4 bg-green-50 rounded-lg p-4 border border-green-200">
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <div className="text-sm font-bold text-green-800">
                                                    الحجم المحسوب (مصحح لدرجة الحرارة)
                                                </div>
                                                <div className="english-text text-xs text-green-600">
                                                    Calculated Volume (Temperature Corrected) - Factor: 0.9975
                                                </div>
                                            </div>
                                            <div className="text-2xl font-bold text-green-700 english-text">
                                                {volumetricResults.volume.toFixed(2)} mL
                                            </div>
                                        </div>
                                        <div className="mt-2 bg-green-100 rounded p-2 font-mono text-xs text-center english-text text-green-700">
                                            Volume = 0.9975 × (R₂ - R₁) = 0.9975 × ({volumetricInputs.finalReadR2 || 0} - {volumetricInputs.initialReadR1 || 0}) = {volumetricResults.volume.toFixed(2)} mL
                                        </div>
                                    </div>
                                )}

                                {/* Info Note */}
                                <div className="mt-4 bg-amber-50 rounded-lg p-3 border border-amber-200">
                                    <div className="flex items-start gap-2">
                                        <AlertTriangleIcon />
                                        <div className="text-xs text-amber-800">
                                            <strong>ملاحظة (10.2.1.2):</strong> يتم تصحيح الحجم لدرجة الحرارة باستخدام المعامل 0.9975 (عند ~23°C).
                                            <span className="english-text block text-amber-600 mt-1">
                                                Note: Volume is temperature corrected using factor 0.9975 (at ~23°C).
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Results Section */}
                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div className="bg-gradient-to-l from-indigo-600 to-purple-600 px-4 py-3">
                            <h3 className="text-sm font-bold text-white">
                                النتائج المحسوبة (القسم 10)
                                <span className="english-text text-xs font-normal text-indigo-100 mr-2">/ Calculated Results (Section 10)</span>
                            </h3>
                        </div>
                        <div className="p-4">
                            <div className="grid grid-cols-4 gap-4">
                                {/* Bulk SG (OD) */}
                                <div className="bg-gradient-to-br from-amber-50 to-amber-100 rounded-xl p-4 border border-amber-200">
                                    <div className="text-xs font-medium text-amber-800 mb-1">
                                        الوزن النوعي الظاهري (OD)
                                        <span className="english-text block text-amber-600">Bulk SG (Oven-Dry)</span>
                                    </div>
                                    <div className={`text-3xl font-bold english-text ${currentResults.hasData ? 'text-amber-700' : 'text-slate-300'}`}>
                                        {currentResults.hasData ? currentResults.bulkOD.toFixed(2) : '-'}
                                    </div>
                                    <div className="english-text text-xs text-amber-600 mt-1 font-mono">
                                        {procedureMethod === 'A' ? 'A / (B + S - C)' : '(S₁ × A/S) / Vol'}
                                    </div>
                                </div>

                                {/* Bulk SG (SSD) */}
                                <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 border border-blue-200">
                                    <div className="text-xs font-medium text-blue-800 mb-1">
                                        الوزن النوعي الظاهري (SSD)
                                        <span className="english-text block text-blue-600">Bulk SG (SSD)</span>
                                    </div>
                                    <div className={`text-3xl font-bold english-text ${currentResults.hasData ? 'text-blue-700' : 'text-slate-300'}`}>
                                        {currentResults.hasData ? currentResults.bulkSSD.toFixed(2) : '-'}
                                    </div>
                                    <div className="english-text text-xs text-blue-600 mt-1 font-mono">
                                        {procedureMethod === 'A' ? 'S / (B + S - C)' : 'S₁ / Vol'}
                                    </div>
                                </div>

                                {/* Apparent SG */}
                                <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-4 border border-purple-200">
                                    <div className="text-xs font-medium text-purple-800 mb-1">
                                        الوزن النوعي الحقيقي
                                        <span className="english-text block text-purple-600">Apparent SG</span>
                                    </div>
                                    <div className={`text-3xl font-bold english-text ${currentResults.hasData ? 'text-purple-700' : 'text-slate-300'}`}>
                                        {currentResults.hasData ? currentResults.apparent.toFixed(2) : '-'}
                                    </div>
                                    <div className="english-text text-xs text-purple-600 mt-1 font-mono">
                                        {procedureMethod === 'A' ? 'A / (B + A - C)' : 'Complex Formula'}
                                    </div>
                                </div>

                                {/* Absorption */}
                                <div className="bg-gradient-to-br from-green-50 to-emerald-100 rounded-xl p-4 border border-green-200">
                                    <div className="text-xs font-medium text-green-800 mb-1">
                                        نسبة الامتصاص (%)
                                        <span className="english-text block text-green-600">Absorption (%)</span>
                                    </div>
                                    <div className={`text-3xl font-bold english-text ${currentResults.hasData ? 'text-green-700' : 'text-slate-300'}`}>
                                        {currentResults.hasData ? currentResults.absorption.toFixed(1) : '-'}
                                        {currentResults.hasData && <span className="text-lg">%</span>}
                                    </div>
                                    <div className="english-text text-xs text-green-600 mt-1 font-mono">
                                        ((S - A) / A) × 100
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Formulas Reference */}
                    <div className="grid grid-cols-1 xl:grid-cols-2 gap-4">
                        {/* Method A Formulas */}
                        <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                            <h3 className="text-sm font-bold text-slate-800 mb-3">
                                معادلات طريقة القنينة (A) - القسم 10.1
                                <span className="english-text text-xs font-normal text-slate-500 mr-2">/ Pycnometer Formulas (Sec 10.1)</span>
                            </h3>
                            <div className="space-y-2 text-xs">
                                <div className="bg-amber-50 rounded-lg p-2 border border-amber-200 font-mono english-text">
                                    <strong>Bulk SG (OD)</strong> = A / (B + S - C)
                                </div>
                                <div className="bg-blue-50 rounded-lg p-2 border border-blue-200 font-mono english-text">
                                    <strong>Bulk SG (SSD)</strong> = S / (B + S - C)
                                </div>
                                <div className="bg-purple-50 rounded-lg p-2 border border-purple-200 font-mono english-text">
                                    <strong>Apparent SG</strong> = A / (B + A - C)
                                </div>
                                <div className="bg-green-50 rounded-lg p-2 border border-green-200 font-mono english-text">
                                    <strong>Absorption %</strong> = ((S - A) / A) × 100
                                </div>
                            </div>
                        </div>

                        {/* Method B Formulas */}
                        <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                            <h3 className="text-sm font-bold text-slate-800 mb-3">
                                معادلات طريقة لوشاتلييه (B) - القسم 10.2
                                <span className="english-text text-xs font-normal text-slate-500 mr-2">/ Le Chatelier Formulas (Sec 10.2)</span>
                            </h3>
                            <div className="space-y-2 text-xs">
                                <div className="bg-teal-50 rounded-lg p-2 border border-teal-200 font-mono english-text">
                                    <strong>Volume</strong> = 0.9975 × (R₂ - R₁)
                                </div>
                                <div className="bg-amber-50 rounded-lg p-2 border border-amber-200 font-mono english-text">
                                    <strong>Bulk SG (OD)</strong> = (S₁ × A/S) / Vol
                                </div>
                                <div className="bg-blue-50 rounded-lg p-2 border border-blue-200 font-mono english-text">
                                    <strong>Bulk SG (SSD)</strong> = S₁ / Vol
                                </div>
                                <div className="bg-purple-50 rounded-lg p-2 border border-purple-200 font-mono english-text text-xs">
                                    <strong>Apparent SG</strong> = (S₁×A/S) / [0.9975×(R₂-R₁) - (S₁/S)×(S-A)]
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Variables Legend */}
                    <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                        <h3 className="text-sm font-bold text-slate-800 mb-3">
                            دليل الرموز <span className="english-text text-xs font-normal text-slate-500">/ Variables Legend</span>
                        </h3>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs">
                            <div className="bg-amber-50 rounded-lg p-2 border border-amber-100">
                                <span className="font-bold text-amber-700">A</span>
                                <span className="text-slate-600 mr-1">= كتلة العينة الجافة</span>
                                <span className="english-text block text-slate-500">Oven-Dry Mass</span>
                            </div>
                            <div className="bg-blue-50 rounded-lg p-2 border border-blue-100">
                                <span className="font-bold text-blue-700">S</span>
                                <span className="text-slate-600 mr-1">= كتلة SSD</span>
                                <span className="english-text block text-slate-500">SSD Mass (usually 500g)</span>
                            </div>
                            <div className="bg-cyan-50 rounded-lg p-2 border border-cyan-100">
                                <span className="font-bold text-cyan-700">B</span>
                                <span className="text-slate-600 mr-1">= القنينة + ماء</span>
                                <span className="english-text block text-slate-500">Pycnometer + Water</span>
                            </div>
                            <div className="bg-purple-50 rounded-lg p-2 border border-purple-100">
                                <span className="font-bold text-purple-700">C</span>
                                <span className="text-slate-600 mr-1">= القنينة + عينة + ماء</span>
                                <span className="english-text block text-slate-500">Pycno + Sample + Water</span>
                            </div>
                            <div className="bg-teal-50 rounded-lg p-2 border border-teal-100">
                                <span className="font-bold text-teal-700">S₁</span>
                                <span className="text-slate-600 mr-1">= كتلة SSD في الدورق</span>
                                <span className="english-text block text-slate-500">SSD in Flask (~55g)</span>
                            </div>
                            <div className="bg-sky-50 rounded-lg p-2 border border-sky-100">
                                <span className="font-bold text-sky-700">R₁</span>
                                <span className="text-slate-600 mr-1">= القراءة الابتدائية</span>
                                <span className="english-text block text-slate-500">Initial Reading (mL)</span>
                            </div>
                            <div className="bg-emerald-50 rounded-lg p-2 border border-emerald-100">
                                <span className="font-bold text-emerald-700">R₂</span>
                                <span className="text-slate-600 mr-1">= القراءة النهائية</span>
                                <span className="english-text block text-slate-500">Final Reading (mL)</span>
                            </div>
                            <div className="bg-green-50 rounded-lg p-2 border border-green-100">
                                <span className="font-bold text-green-700">Vol</span>
                                <span className="text-slate-600 mr-1">= الحجم المصحح</span>
                                <span className="english-text block text-slate-500">Corrected Volume</span>
                            </div>
                        </div>
                    </div>

                    {/* Test Reference */}
                    <div className="bg-gradient-to-l from-slate-700 to-slate-800 rounded-xl p-4 text-white">
                        <div className="flex items-center gap-3">
                            <span className="px-3 py-1.5 bg-indigo-500 text-white font-bold rounded-lg text-sm">ASTM C128</span>
                            <div>
                                <div className="font-bold text-sm">
                                    Standard Test Method for Relative Density (Specific Gravity) and Absorption of Fine Aggregate
                                </div>
                                <div className="text-slate-300 text-xs english-text">
                                    طريقة الاختبار القياسية للكثافة النسبية (الوزن النوعي) وامتصاص الركام الناعم
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ============= ASTM C117 - MATERIALS FINER THAN 75-μm =============
        const MaterialsFinerThan200 = () => {
            // Procedure Selection: A = Plain Water, B = With Wetting Agent
            const [procedure, setProcedure] = useState('A');
            const [showMinMassGuide, setShowMinMassGuide] = useState(false);

            // Input State
            const [nominalMaxSize, setNominalMaxSize] = useState('4.75mm');
            const [originalDryMassB, setOriginalDryMassB] = useState('');
            const [dryMassAfterWashC, setDryMassAfterWashC] = useState('');

            // Minimum Mass Guide (Sec 6.2)
            const minMassGuide = [
                { size: '4.75 mm (No. 4) or smaller', minMass: '300 g', key: '4.75mm' },
                { size: '4.75 mm to 9.5 mm (No. 4 to 3/8")', minMass: '1000 g', key: '9.5mm' },
                { size: '9.5 mm to 19.0 mm (3/8" to 3/4")', minMass: '2500 g', key: '19mm' },
                { size: 'Larger than 19.0 mm (> 3/4")', minMass: '5000 g', key: '19mm+' },
            ];

            // Get recommended min mass based on selection
            const getRecommendedMass = () => {
                const guide = minMassGuide.find(g => g.key === nominalMaxSize);
                return guide ? guide.minMass : '300 g';
            };

            // Calculate results (Sec 10)
            const results = useMemo(() => {
                const B = parseFloat(originalDryMassB) || 0;
                const C = parseFloat(dryMassAfterWashC) || 0;

                if (B === 0) {
                    return { 
                        percentFiner: 0, 
                        displayValue: '-', 
                        hasData: false, 
                        isValid: true,
                        massLoss: 0
                    };
                }

                // Validation: B must be >= C
                if (C > B) {
                    return { 
                        percentFiner: 0, 
                        displayValue: 'خطأ / Error', 
                        hasData: true, 
                        isValid: false,
                        massLoss: 0,
                        errorMessage: 'الوزن بعد الغسيل أكبر من الوزن الأصلي / Washed mass exceeds original'
                    };
                }

                // Formula: A = [(B - C) / B] * 100 (Sec 10)
                const massLoss = B - C;
                const percentFiner = ((B - C) / B) * 100;

                // Rounding Rules (Sec 11.1.1)
                let displayValue;
                if (percentFiner < 10) {
                    // Round to nearest 0.1%
                    displayValue = percentFiner.toFixed(1);
                } else {
                    // Round to nearest whole number
                    displayValue = Math.round(percentFiner).toString();
                }

                return { 
                    percentFiner, 
                    displayValue, 
                    hasData: true, 
                    isValid: true,
                    massLoss: parseFloat(massLoss.toFixed(1))
                };
            }, [originalDryMassB, dryMassAfterWashC]);

            const handleReset = () => {
                setOriginalDryMassB('');
                setDryMassAfterWashC('');
                setNominalMaxSize('4.75mm');
                setProcedure('A');
            };

            return (
                <div className="p-4 space-y-4">
                    {/* Header Card */}
                    <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                        <div className="flex items-center justify-between mb-4">
                            <div>
                                <h2 className="text-lg font-bold text-slate-800">
                                    المواد أنعم من منخل 75 ميكرون (رقم 200) بالغسيل
                                </h2>
                                <p className="english-text text-sm text-slate-500">
                                    Materials Finer than 75-μm (No. 200) Sieve by Washing (ASTM C117)
                                </p>
                            </div>
                            <button
                                onClick={handleReset}
                                className="flex items-center gap-2 px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors text-sm"
                            >
                                <RefreshIcon />
                                <span className="font-medium">إعادة تعيين</span>
                            </button>
                        </div>

                        {/* Procedure Selection (Sec 7) */}
                        <div className="bg-gradient-to-l from-cyan-50 to-sky-50 rounded-lg p-4 border border-cyan-100">
                            <h3 className="text-sm font-bold text-cyan-800 mb-3">
                                طريقة الإجراء (القسم 7) <span className="english-text text-xs font-normal text-cyan-600">/ Procedure Method (Section 7)</span>
                            </h3>
                            <div className="flex gap-3">
                                <button
                                    onClick={() => setProcedure('A')}
                                    className={`flex-1 px-4 py-3 rounded-lg transition-all ${
                                        procedure === 'A'
                                            ? 'bg-cyan-600 text-white shadow-lg'
                                            : 'bg-white border border-slate-300 text-slate-600 hover:bg-slate-50'
                                    }`}
                                >
                                    <div className="font-bold">طريقة A - الغسيل بالماء العادي</div>
                                    <div className="english-text text-xs opacity-80">Procedure A: Washing with Plain Water</div>
                                </button>
                                <button
                                    onClick={() => setProcedure('B')}
                                    className={`flex-1 px-4 py-3 rounded-lg transition-all ${
                                        procedure === 'B'
                                            ? 'bg-cyan-600 text-white shadow-lg'
                                            : 'bg-white border border-slate-300 text-slate-600 hover:bg-slate-50'
                                    }`}
                                >
                                    <div className="font-bold">طريقة B - الغسيل بمادة مبللة</div>
                                    <div className="english-text text-xs opacity-80">Procedure B: Washing with Wetting Agent/Detergent</div>
                                </button>
                            </div>

                            {procedure === 'B' && (
                                <div className="mt-3 bg-amber-50 rounded-lg p-3 border border-amber-200">
                                    <div className="flex items-start gap-2">
                                        <AlertTriangleIcon />
                                        <div className="text-xs text-amber-800">
                                            <strong>ملاحظة:</strong> عند استخدام طريقة B، أضف كمية صغيرة من مادة مبللة (صابون سائل) إلى ماء الغسيل.
                                            <span className="english-text block text-amber-600 mt-1">
                                                Note: When using Procedure B, add a small amount of wetting agent (liquid soap) to the wash water.
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Minimum Mass Guide (Sec 6.2) - Collapsible */}
                        <div className="mt-4">
                            <button
                                onClick={() => setShowMinMassGuide(!showMinMassGuide)}
                                className="flex items-center gap-2 text-sm font-medium text-slate-600 hover:text-slate-800 transition-colors"
                            >
                                <span className={`transform transition-transform ${showMinMassGuide ? 'rotate-90' : ''}`}>▶</span>
                                <span>دليل الحد الأدنى للكتلة (القسم 6.2)</span>
                                <span className="english-text text-xs text-slate-400">/ Minimum Mass Guide (Sec 6.2)</span>
                            </button>
                            
                            {showMinMassGuide && (
                                <div className="mt-3 bg-slate-50 rounded-lg border border-slate-200 overflow-hidden">
                                    <table className="w-full text-sm">
                                        <thead>
                                            <tr className="bg-slate-200">
                                                <th className="px-3 py-2 text-right font-bold text-slate-700">
                                                    المقاس الاسمي الأقصى
                                                    <span className="english-text block text-xs font-normal text-slate-500">Nominal Max Size</span>
                                                </th>
                                                <th className="px-3 py-2 text-center font-bold text-slate-700">
                                                    الحد الأدنى للكتلة
                                                    <span className="english-text block text-xs font-normal text-slate-500">Minimum Mass</span>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {minMassGuide.map((row, i) => (
                                                <tr key={i} className={`${i % 2 === 0 ? 'bg-white' : 'bg-slate-50'} ${nominalMaxSize === row.key ? 'ring-2 ring-cyan-400 ring-inset' : ''}`}>
                                                    <td className="px-3 py-2 english-text text-slate-700">{row.size}</td>
                                                    <td className="px-3 py-2 text-center english-text font-bold text-cyan-700">{row.minMass}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Input Section */}
                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div className="bg-slate-50 border-b border-slate-200 px-4 py-3">
                            <h3 className="text-sm font-bold text-slate-800">
                                بيانات الاختبار
                            </h3>
                            <p className="english-text text-xs text-slate-500">
                                Test Input Data
                            </p>
                        </div>
                        <div className="p-4">
                            <div className="grid grid-cols-3 gap-4">
                                {/* Nominal Max Size Dropdown */}
                                <div className="bg-slate-50 rounded-lg p-4 border border-slate-200">
                                    <label className="block text-sm font-bold text-slate-800 mb-2">
                                        المقاس الاسمي الأقصى
                                        <span className="english-text block text-xs font-normal text-slate-500">Nominal Maximum Size</span>
                                    </label>
                                    <select
                                        value={nominalMaxSize}
                                        onChange={(e) => setNominalMaxSize(e.target.value)}
                                        className="w-full px-3 py-3 border-2 border-slate-300 rounded-lg english-text font-medium focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 outline-none bg-white"
                                    >
                                        <option value="4.75mm">4.75 mm (No. 4) or smaller</option>
                                        <option value="9.5mm">4.75 mm to 9.5 mm</option>
                                        <option value="19mm">9.5 mm to 19.0 mm</option>
                                        <option value="19mm+">Larger than 19.0 mm</option>
                                    </select>
                                    <div className="mt-2 text-xs text-slate-600">
                                        الحد الأدنى المطلوب: <span className="font-bold text-cyan-700">{getRecommendedMass()}</span>
                                        <span className="english-text block text-slate-500">Minimum Required: {getRecommendedMass()}</span>
                                    </div>
                                </div>

                                {/* B - Original Dry Mass */}
                                <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                                    <label className="block text-sm font-bold text-blue-800 mb-2">
                                        B - الوزن الجاف الأصلي (جم)
                                        <span className="english-text block text-xs font-normal text-blue-600">Original Dry Mass (g)</span>
                                    </label>
                                    <input
                                        type="number"
                                        min="0"
                                        step="0.1"
                                        value={originalDryMassB}
                                        onChange={(e) => setOriginalDryMassB(e.target.value)}
                                        className="w-full px-4 py-3 border-2 border-blue-300 rounded-lg text-center english-text text-lg font-bold focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white"
                                        placeholder="0.0"
                                        dir="ltr"
                                    />
                                </div>

                                {/* C - Dry Mass After Washing */}
                                <div className="bg-amber-50 rounded-lg p-4 border border-amber-200">
                                    <label className="block text-sm font-bold text-amber-800 mb-2">
                                        C - الوزن الجاف بعد الغسيل (جم)
                                        <span className="english-text block text-xs font-normal text-amber-600">Dry Mass After Washing (g)</span>
                                    </label>
                                    <input
                                        type="number"
                                        min="0"
                                        step="0.1"
                                        value={dryMassAfterWashC}
                                        onChange={(e) => setDryMassAfterWashC(e.target.value)}
                                        className="w-full px-4 py-3 border-2 border-amber-300 rounded-lg text-center english-text text-lg font-bold focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none bg-white"
                                        placeholder="0.0"
                                        dir="ltr"
                                    />
                                </div>
                            </div>

                            {/* Validation Error */}
                            {results.hasData && !results.isValid && (
                                <div className="mt-4 bg-red-50 rounded-lg p-4 border border-red-200">
                                    <div className="flex items-center gap-2 text-red-700">
                                        <AlertTriangleIcon />
                                        <span className="font-bold">{results.errorMessage}</span>
                                    </div>
                                </div>
                            )}

                            {/* Mass Loss Display */}
                            {results.hasData && results.isValid && (
                                <div className="mt-4 bg-purple-50 rounded-lg p-4 border border-purple-200">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <div className="text-sm font-bold text-purple-800">
                                                كتلة المواد المفقودة بالغسيل
                                            </div>
                                            <div className="english-text text-xs text-purple-600">
                                                Mass of Material Lost by Washing (B - C)
                                            </div>
                                        </div>
                                        <div className="text-2xl font-bold text-purple-700 english-text">
                                            {results.massLoss.toFixed(1)} g
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Results Section */}
                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div className="bg-gradient-to-l from-cyan-600 to-sky-600 px-4 py-3">
                            <h3 className="text-sm font-bold text-white">
                                النتيجة المحسوبة (القسم 10)
                                <span className="english-text text-xs font-normal text-cyan-100 mr-2">/ Calculated Result (Section 10)</span>
                            </h3>
                        </div>
                        <div className="p-6">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {/* Main Result */}
                                <div className={`rounded-2xl p-6 text-center ${
                                    results.hasData && results.isValid 
                                        ? 'bg-gradient-to-br from-cyan-500 to-sky-600' 
                                        : 'bg-gradient-to-br from-slate-300 to-slate-400'
                                }`}>
                                    <div className="text-white">
                                        <div className="text-sm font-medium opacity-90 mb-2">
                                            نسبة المواد أنعم من 75 ميكرون (%)
                                            <span className="english-text block text-xs opacity-80">Materials Finer than 75-μm (%)</span>
                                        </div>
                                        <div className={`font-bold english-text ${results.hasData ? 'text-6xl' : 'text-4xl'}`}>
                                            {results.displayValue}
                                            {results.hasData && results.isValid && <span className="text-3xl">%</span>}
                                        </div>
                                        <div className="mt-3 text-xs opacity-80 english-text font-mono">
                                            A = [(B - C) / B] × 100
                                        </div>
                                    </div>
                                </div>

                                {/* Report Details */}
                                <div className="space-y-4">
                                    {/* Procedure Used */}
                                    <div className={`rounded-xl p-4 border-2 ${
                                        procedure === 'A' 
                                            ? 'bg-blue-50 border-blue-200' 
                                            : 'bg-amber-50 border-amber-200'
                                    }`}>
                                        <div className="text-xs font-medium text-slate-600 mb-1">
                                            الطريقة المستخدمة
                                            <span className="english-text block text-slate-500">Procedure Used (Sec 11)</span>
                                        </div>
                                        <div className={`text-lg font-bold ${procedure === 'A' ? 'text-blue-700' : 'text-amber-700'}`}>
                                            {procedure === 'A' ? 'طريقة A - ماء عادي' : 'طريقة B - مادة مبللة'}
                                            <span className="english-text block text-sm font-medium">
                                                {procedure === 'A' ? 'Procedure A - Plain Water' : 'Procedure B - Wetting Agent'}
                                            </span>
                                        </div>
                                    </div>

                                    {/* Rounding Rules Applied */}
                                    <div className="bg-green-50 rounded-xl p-4 border border-green-200">
                                        <div className="text-xs font-medium text-slate-600 mb-1">
                                            قاعدة التقريب المطبقة (القسم 11.1.1)
                                            <span className="english-text block text-slate-500">Rounding Rule Applied (Sec 11.1.1)</span>
                                        </div>
                                        <div className="text-sm font-bold text-green-700">
                                            {results.hasData && results.isValid ? (
                                                results.percentFiner < 10 ? (
                                                    <>
                                                        أقل من 10% → تقريب لأقرب 0.1%
                                                        <span className="english-text block text-xs font-medium text-green-600">
                                                            {"< 10% → Round to nearest 0.1%"}
                                                        </span>
                                                    </>
                                                ) : (
                                                    <>
                                                        10% أو أكثر → تقريب لأقرب عدد صحيح
                                                        <span className="english-text block text-xs font-medium text-green-600">
                                                            {"≥ 10% → Round to nearest whole number"}
                                                        </span>
                                                    </>
                                                )
                                            ) : (
                                                <span className="text-slate-400">-</span>
                                            )}
                                        </div>
                                    </div>

                                    {/* Calculation Breakdown */}
                                    {results.hasData && results.isValid && (
                                        <div className="bg-slate-50 rounded-xl p-4 border border-slate-200">
                                            <div className="text-xs font-medium text-slate-600 mb-2">
                                                تفاصيل الحساب
                                                <span className="english-text block text-slate-500">Calculation Breakdown</span>
                                            </div>
                                            <div className="font-mono text-sm text-slate-700 english-text space-y-1">
                                                <div>B = {originalDryMassB} g (Original Dry Mass)</div>
                                                <div>C = {dryMassAfterWashC} g (After Washing)</div>
                                                <div className="border-t border-slate-300 pt-1 mt-1">
                                                    A = [({originalDryMassB} - {dryMassAfterWashC}) / {originalDryMassB}] × 100
                                                </div>
                                                <div className="font-bold text-cyan-700">
                                                    A = {results.percentFiner.toFixed(3)}% → <span className="text-lg">{results.displayValue}%</span>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Formula & Procedure Reference */}
                    <div className="grid grid-cols-1 xl:grid-cols-2 gap-4">
                        {/* Formula */}
                        <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                            <h3 className="text-sm font-bold text-slate-800 mb-3">
                                معادلة الحساب (القسم 10)
                                <span className="english-text text-xs font-normal text-slate-500 mr-2">/ Calculation Formula (Sec 10)</span>
                            </h3>
                            <div className="bg-cyan-50 rounded-lg p-4 border border-cyan-200">
                                <div className="text-center font-mono text-lg english-text text-cyan-800 font-bold">
                                    A = [(B - C) / B] × 100
                                </div>
                                <div className="mt-3 text-xs text-cyan-700 space-y-1">
                                    <div><strong>A</strong> = نسبة المواد أنعم من 75 ميكرون (%) / % Finer than 75-μm</div>
                                    <div><strong>B</strong> = الوزن الجاف الأصلي (جم) / Original Dry Mass (g)</div>
                                    <div><strong>C</strong> = الوزن الجاف بعد الغسيل (جم) / Dry Mass After Washing (g)</div>
                                </div>
                            </div>
                        </div>

                        {/* Rounding Rules */}
                        <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                            <h3 className="text-sm font-bold text-slate-800 mb-3">
                                قواعد التقريب (القسم 11.1.1)
                                <span className="english-text text-xs font-normal text-slate-500 mr-2">/ Rounding Rules (Sec 11.1.1)</span>
                            </h3>
                            <div className="space-y-2">
                                <div className="bg-blue-50 rounded-lg p-3 border border-blue-200">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <div className="font-bold text-blue-800 text-sm">إذا النتيجة {"<"} 10%</div>
                                            <div className="english-text text-xs text-blue-600">If Result {"<"} 10%</div>
                                        </div>
                                        <div className="text-left">
                                            <div className="font-bold text-blue-700">→ تقريب لأقرب 0.1%</div>
                                            <div className="english-text text-xs text-blue-600">Round to nearest 0.1%</div>
                                        </div>
                                    </div>
                                    <div className="mt-2 english-text text-xs text-blue-600">
                                        Example: 4.567% → <strong>4.6%</strong>
                                    </div>
                                </div>
                                <div className="bg-amber-50 rounded-lg p-3 border border-amber-200">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <div className="font-bold text-amber-800 text-sm">إذا النتيجة ≥ 10%</div>
                                            <div className="english-text text-xs text-amber-600">If Result ≥ 10%</div>
                                        </div>
                                        <div className="text-left">
                                            <div className="font-bold text-amber-700">→ تقريب لأقرب عدد صحيح</div>
                                            <div className="english-text text-xs text-amber-600">Round to nearest whole number</div>
                                        </div>
                                    </div>
                                    <div className="mt-2 english-text text-xs text-amber-600">
                                        Example: 12.456% → <strong>12%</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Test Procedure Summary */}
                    <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                        <h3 className="text-sm font-bold text-slate-800 mb-3">
                            ملخص إجراء الاختبار
                            <span className="english-text text-xs font-normal text-slate-500 mr-2">/ Test Procedure Summary</span>
                        </h3>
                        <div className="grid grid-cols-1 md:grid-cols-5 gap-3">
                            <div className="bg-slate-50 rounded-lg p-3 text-center border border-slate-200">
                                <div className="w-8 h-8 bg-cyan-500 text-white rounded-full flex items-center justify-center mx-auto mb-2 font-bold">1</div>
                                <div className="text-xs font-bold text-slate-700">تجفيف العينة</div>
                                <div className="english-text text-xs text-slate-500">Dry Sample</div>
                            </div>
                            <div className="bg-slate-50 rounded-lg p-3 text-center border border-slate-200">
                                <div className="w-8 h-8 bg-cyan-500 text-white rounded-full flex items-center justify-center mx-auto mb-2 font-bold">2</div>
                                <div className="text-xs font-bold text-slate-700">وزن العينة (B)</div>
                                <div className="english-text text-xs text-slate-500">Weigh (B)</div>
                            </div>
                            <div className="bg-slate-50 rounded-lg p-3 text-center border border-slate-200">
                                <div className="w-8 h-8 bg-cyan-500 text-white rounded-full flex items-center justify-center mx-auto mb-2 font-bold">3</div>
                                <div className="text-xs font-bold text-slate-700">الغسيل فوق منخل 75μm</div>
                                <div className="english-text text-xs text-slate-500">Wash over No. 200</div>
                            </div>
                            <div className="bg-slate-50 rounded-lg p-3 text-center border border-slate-200">
                                <div className="w-8 h-8 bg-cyan-500 text-white rounded-full flex items-center justify-center mx-auto mb-2 font-bold">4</div>
                                <div className="text-xs font-bold text-slate-700">تجفيف المتبقي</div>
                                <div className="english-text text-xs text-slate-500">Dry Residue</div>
                            </div>
                            <div className="bg-slate-50 rounded-lg p-3 text-center border border-slate-200">
                                <div className="w-8 h-8 bg-cyan-500 text-white rounded-full flex items-center justify-center mx-auto mb-2 font-bold">5</div>
                                <div className="text-xs font-bold text-slate-700">وزن المتبقي (C)</div>
                                <div className="english-text text-xs text-slate-500">Weigh Residue (C)</div>
                            </div>
                        </div>
                    </div>

                    {/* Test Reference */}
                    <div className="bg-gradient-to-l from-slate-700 to-slate-800 rounded-xl p-4 text-white">
                        <div className="flex items-center gap-3">
                            <span className="px-3 py-1.5 bg-cyan-500 text-white font-bold rounded-lg text-sm">ASTM C117</span>
                            <div>
                                <div className="font-bold text-sm">
                                    Standard Test Method for Materials Finer than 75-μm (No. 200) Sieve in Mineral Aggregates by Washing
                                </div>
                                <div className="text-slate-300 text-xs english-text">
                                    طريقة الاختبار القياسية للمواد أنعم من منخل 75 ميكرون (رقم 200) في الركام المعدني بالغسيل
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ============= ASTM C142 - CLAY LUMPS AND FRIABLE PARTICLES =============
        const ClayLumpsTest = () => {
            // Aggregate Mode: 'fine' or 'coarse'
            const [aggregateMode, setAggregateMode] = useState('coarse');
            const [showTooltip, setShowTooltip] = useState(false);

            // Fine Aggregate State
            const [fineAggregate, setFineAggregate] = useState({
                testMass: '',
                retainedMass: ''
            });

            // Coarse Aggregate Fractions (per ASTM C142 Sec 5.4)
            const coarseFractions = [
                { id: 'f1', sizeRange: '4.75 - 9.5 mm', imperial: 'No.4 to 3/8"', minMass: 1000, washSieve: 'No. 8 (2.36 mm)' },
                { id: 'f2', sizeRange: '9.5 - 19.0 mm', imperial: '3/8" to 3/4"', minMass: 2000, washSieve: 'No. 4 (4.75 mm)' },
                { id: 'f3', sizeRange: '19.0 - 37.5 mm', imperial: '3/4" to 1-1/2"', minMass: 3000, washSieve: '3/8" (9.5 mm)' },
                { id: 'f4', sizeRange: '37.5 - 75.0 mm', imperial: '1-1/2" to 3"', minMass: 5000, washSieve: '3/4" (19.0 mm)' },
            ];

            // Coarse Aggregate State
            const [coarseData, setCoarseData] = useState(() => {
                const initial = {};
                coarseFractions.forEach(f => {
                    initial[f.id] = {
                        originalGrading: '',
                        testMass: '',
                        retainedMass: ''
                    };
                });
                return initial;
            });

            // Fine Aggregate Calculation
            const fineResults = useMemo(() => {
                const M = parseFloat(fineAggregate.testMass) || 0;
                const R = parseFloat(fineAggregate.retainedMass) || 0;

                if (M === 0) {
                    return { percentage: 0, hasData: false, isValid: true };
                }

                if (R > M) {
                    return { percentage: 0, hasData: true, isValid: false, errorMessage: 'الوزن المتبقي أكبر من وزن العينة' };
                }

                const percentage = ((M - R) / M) * 100;
                return { 
                    percentage: parseFloat(percentage.toFixed(1)), 
                    hasData: true, 
                    isValid: true 
                };
            }, [fineAggregate]);

            // Coarse Aggregate Calculations
            const coarseResults = useMemo(() => {
                const results = coarseFractions.map(fraction => {
                    const data = coarseData[fraction.id];
                    const originalGrading = parseFloat(data.originalGrading) || 0;
                    const M = parseFloat(data.testMass) || 0;
                    const R = parseFloat(data.retainedMass) || 0;

                    if (M === 0) {
                        return {
                            ...fraction,
                            originalGrading,
                            testMass: M,
                            retainedMass: R,
                            percentage: 0,
                            weightedValue: 0,
                            hasData: false,
                            isValid: true,
                            skipTest: originalGrading < 5
                        };
                    }

                    if (R > M) {
                        return {
                            ...fraction,
                            originalGrading,
                            testMass: M,
                            retainedMass: R,
                            percentage: 0,
                            weightedValue: 0,
                            hasData: true,
                            isValid: false,
                            errorMessage: 'R > M',
                            skipTest: false
                        };
                    }

                    const percentage = ((M - R) / M) * 100;
                    const weightedValue = (percentage * originalGrading) / 100;

                    return {
                        ...fraction,
                        originalGrading,
                        testMass: M,
                        retainedMass: R,
                        percentage: parseFloat(percentage.toFixed(1)),
                        weightedValue: parseFloat(weightedValue.toFixed(2)),
                        hasData: true,
                        isValid: true,
                        skipTest: originalGrading < 5
                    };
                });

                // Calculate weighted average (Sec 7.2)
                const totalWeightedAverage = results
                    .filter(r => r.hasData && r.isValid && !r.skipTest)
                    .reduce((sum, r) => sum + r.weightedValue, 0);

                const totalGrading = results.reduce((sum, r) => sum + r.originalGrading, 0);
                const isGradingValid = Math.abs(totalGrading - 100) < 0.5 || totalGrading === 0;
                const testedCount = results.filter(r => r.hasData).length;

                return {
                    fractionResults: results,
                    totalWeightedAverage: parseFloat(totalWeightedAverage.toFixed(1)),
                    totalGrading,
                    isGradingValid,
                    testedCount
                };
            }, [coarseData]);

            // Handle coarse data changes
            const handleCoarseChange = (fractionId, field, value) => {
                setCoarseData(prev => ({
                    ...prev,
                    [fractionId]: { ...prev[fractionId], [field]: value }
                }));
            };

            const handleReset = () => {
                setFineAggregate({ testMass: '', retainedMass: '' });
                const resetCoarse = {};
                coarseFractions.forEach(f => {
                    resetCoarse[f.id] = { originalGrading: '', testMass: '', retainedMass: '' };
                });
                setCoarseData(resetCoarse);
            };

            return (
                <div className="p-4 space-y-4">
                    {/* Header Card */}
                    <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                        <div className="flex items-center justify-between mb-4">
                            <div>
                                <h2 className="text-lg font-bold text-slate-800">
                                    الكتل الطينية والحبيبات الهشة
                                </h2>
                                <p className="english-text text-sm text-slate-500">
                                    Clay Lumps and Friable Particles in Aggregates (ASTM C142)
                                </p>
                            </div>
                            <button
                                onClick={handleReset}
                                className="flex items-center gap-2 px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors text-sm"
                            >
                                <RefreshIcon />
                                <span className="font-medium">إعادة تعيين</span>
                            </button>
                        </div>

                        {/* Aggregate Mode Toggle */}
                        <div className="bg-gradient-to-l from-rose-50 to-pink-50 rounded-lg p-4 border border-rose-100">
                            <h3 className="text-sm font-bold text-rose-800 mb-3">
                                نوع الركام <span className="english-text text-xs font-normal text-rose-600">/ Aggregate Type</span>
                            </h3>
                            <div className="flex gap-3">
                                <button
                                    onClick={() => setAggregateMode('fine')}
                                    className={`flex-1 px-4 py-3 rounded-lg transition-all ${
                                        aggregateMode === 'fine'
                                            ? 'bg-rose-600 text-white shadow-lg'
                                            : 'bg-white border border-slate-300 text-slate-600 hover:bg-slate-50'
                                    }`}
                                >
                                    <div className="font-bold">الركام الناعم</div>
                                    <div className="english-text text-xs opacity-80">Fine Aggregate (Sec 5.3)</div>
                                </button>
                                <button
                                    onClick={() => setAggregateMode('coarse')}
                                    className={`flex-1 px-4 py-3 rounded-lg transition-all ${
                                        aggregateMode === 'coarse'
                                            ? 'bg-rose-600 text-white shadow-lg'
                                            : 'bg-white border border-slate-300 text-slate-600 hover:bg-slate-50'
                                    }`}
                                >
                                    <div className="font-bold">الركام الخشن</div>
                                    <div className="english-text text-xs opacity-80">Coarse Aggregate (Sec 5.4)</div>
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Fine Aggregate Mode */}
                    {aggregateMode === 'fine' && (
                        <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                            <div className="bg-gradient-to-l from-rose-600 to-pink-600 px-4 py-3">
                                <h3 className="text-sm font-bold text-white">
                                    اختبار الركام الناعم (القسم 5.3)
                                    <span className="english-text text-xs font-normal text-rose-100 mr-2">/ Fine Aggregate Test (Sec 5.3)</span>
                                </h3>
                            </div>
                            
                            {/* Reference Info */}
                            <div className="bg-amber-50 border-b border-amber-200 px-4 py-3">
                                <div className="flex items-center gap-4 text-sm">
                                    <div className="flex items-center gap-2">
                                        <span className="font-bold text-amber-800">الحد الأدنى للعينة:</span>
                                        <span className="english-text font-bold text-amber-700">25 g</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span className="font-bold text-amber-800">الجزء المختبر:</span>
                                        <span className="english-text text-amber-700">Retained on No. 16 (1.18 mm)</span>
                                    </div>
                                </div>
                            </div>

                            <div className="p-4">
                                <div className="grid grid-cols-3 gap-4">
                                    {/* M - Test Mass */}
                                    <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                                        <label className="block text-sm font-bold text-blue-800 mb-2">
                                            M - وزن عينة الاختبار (جم)
                                            <span className="english-text block text-xs font-normal text-blue-600">Mass of Test Sample (g)</span>
                                        </label>
                                        <input
                                            type="number"
                                            min="0"
                                            step="0.1"
                                            value={fineAggregate.testMass}
                                            onChange={(e) => setFineAggregate(p => ({ ...p, testMass: e.target.value }))}
                                            className="w-full px-4 py-3 border-2 border-blue-300 rounded-lg text-center english-text text-lg font-bold focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white"
                                            placeholder="≥25.0"
                                            dir="ltr"
                                        />
                                    </div>

                                    {/* R - Retained Mass */}
                                    <div className="bg-green-50 rounded-lg p-4 border border-green-200">
                                        <label className="block text-sm font-bold text-green-800 mb-2">
                                            R - الوزن المتبقي بعد الاختبار (جم)
                                            <span className="english-text block text-xs font-normal text-green-600">Retained Mass After Test (g)</span>
                                        </label>
                                        <input
                                            type="number"
                                            min="0"
                                            step="0.1"
                                            value={fineAggregate.retainedMass}
                                            onChange={(e) => setFineAggregate(p => ({ ...p, retainedMass: e.target.value }))}
                                            className="w-full px-4 py-3 border-2 border-green-300 rounded-lg text-center english-text text-lg font-bold focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none bg-white"
                                            placeholder="0.0"
                                            dir="ltr"
                                        />
                                    </div>

                                    {/* Result */}
                                    <div className={`rounded-lg p-4 border-2 ${
                                        fineResults.hasData && fineResults.isValid 
                                            ? 'bg-rose-50 border-rose-300' 
                                            : fineResults.hasData && !fineResults.isValid
                                                ? 'bg-red-50 border-red-300'
                                                : 'bg-slate-50 border-slate-200'
                                    }`}>
                                        <div className="text-sm font-bold text-slate-800 mb-2">
                                            P - نسبة الكتل الطينية (%)
                                            <span className="english-text block text-xs font-normal text-slate-600">% Clay Lumps & Friable</span>
                                        </div>
                                        <div className={`text-3xl font-bold english-text ${
                                            fineResults.hasData && fineResults.isValid 
                                                ? 'text-rose-700' 
                                                : fineResults.hasData && !fineResults.isValid
                                                    ? 'text-red-600'
                                                    : 'text-slate-400'
                                        }`}>
                                            {fineResults.hasData && fineResults.isValid 
                                                ? `${fineResults.percentage}%` 
                                                : fineResults.hasData && !fineResults.isValid
                                                    ? 'Error'
                                                    : '-'}
                                        </div>
                                        <div className="english-text text-xs text-slate-500 mt-1 font-mono">
                                            P = [(M - R) / M] × 100
                                        </div>
                                    </div>
                                </div>

                                {/* Validation Error */}
                                {fineResults.hasData && !fineResults.isValid && (
                                    <div className="mt-4 bg-red-50 rounded-lg p-3 border border-red-200">
                                        <div className="flex items-center gap-2 text-red-700 text-sm">
                                            <AlertTriangleIcon />
                                            <span className="font-bold">{fineResults.errorMessage}</span>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Coarse Aggregate Mode */}
                    {aggregateMode === 'coarse' && (
                        <>
                            {/* Tooltip Info */}
                            <div className="bg-amber-50 rounded-xl border border-amber-200 p-4">
                                <button
                                    onClick={() => setShowTooltip(!showTooltip)}
                                    className="flex items-center gap-2 text-sm font-medium text-amber-800 hover:text-amber-900 transition-colors w-full"
                                >
                                    <AlertTriangleIcon />
                                    <span>ملاحظة هامة (القسم 7.2) - انقر للتفاصيل</span>
                                    <span className="english-text text-xs text-amber-600 mr-2">/ Important Note (Sec 7.2) - Click for details</span>
                                    <span className={`transform transition-transform ${showTooltip ? 'rotate-180' : ''}`}>▼</span>
                                </button>
                                
                                {showTooltip && (
                                    <div className="mt-3 bg-white rounded-lg p-4 border border-amber-300">
                                        <div className="text-sm text-amber-800 space-y-2">
                                            <p className="font-bold">
                                                إذا كان كسر حجمي يمثل أقل من 5% من العينة الأصلية:
                                            </p>
                                            <ul className="list-disc list-inside mr-4 space-y-1 text-amber-700">
                                                <li>لا يتم اختباره بشكل منفصل</li>
                                                <li>يُفترض أن له نفس نسبة الكتل الطينية للكسر الأكبر أو الأصغر منه</li>
                                            </ul>
                                            <div className="english-text text-xs text-amber-600 mt-2 border-t border-amber-200 pt-2">
                                                <p><strong>If a size fraction is {"<"} 5% of original sample:</strong></p>
                                                <ul className="list-disc list-inside">
                                                    <li>Do not test it separately</li>
                                                    <li>Assume it has the same % Clay Lumps as the next larger or smaller size</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Grading Validation */}
                            {coarseResults.totalGrading > 0 && (
                                <div className={`rounded-lg p-3 flex items-center justify-between ${
                                    coarseResults.isGradingValid ? 'bg-green-100 border border-green-300' : 'bg-red-100 border border-red-300'
                                }`}>
                                    <div className="flex items-center gap-2">
                                        {coarseResults.isGradingValid ? <CheckCircleIcon /> : <AlertTriangleIcon />}
                                        <span className={`text-sm font-bold ${coarseResults.isGradingValid ? 'text-green-700' : 'text-red-700'}`}>
                                            مجموع التدرج الأصلي: {coarseResults.totalGrading.toFixed(1)}%
                                        </span>
                                    </div>
                                    <span className={`english-text text-sm ${coarseResults.isGradingValid ? 'text-green-600' : 'text-red-600'}`}>
                                        {coarseResults.isGradingValid ? 'Total Grading ≈ 100% ✓' : 'Adjust to reach 100%'}
                                    </span>
                                </div>
                            )}

                            {/* Coarse Aggregate Table */}
                            <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                                <div className="bg-gradient-to-l from-rose-600 to-pink-600 px-4 py-3">
                                    <h3 className="text-sm font-bold text-white">
                                        جدول اختبار الركام الخشن (القسم 5.4 و 6.1)
                                        <span className="english-text text-xs font-normal text-rose-100 mr-2">/ Coarse Aggregate Test Table (Sec 5.4 & 6.1)</span>
                                    </h3>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm" dir="rtl">
                                        <thead>
                                            <tr className="bg-slate-800 text-white">
                                                <th className="px-2 py-2 text-right">
                                                    <div className="font-bold text-xs">كسر المقاس</div>
                                                    <div className="english-text text-xs text-slate-300 font-normal">Size Fraction</div>
                                                </th>
                                                <th className="px-2 py-2 text-center bg-slate-700">
                                                    <div className="font-bold text-xs">الحد الأدنى (جم)</div>
                                                    <div className="english-text text-xs text-slate-300 font-normal">Min Mass (g)</div>
                                                </th>
                                                <th className="px-2 py-2 text-center bg-slate-700">
                                                    <div className="font-bold text-xs">منخل الغسيل</div>
                                                    <div className="english-text text-xs text-slate-300 font-normal">Wash Sieve</div>
                                                </th>
                                                <th className="px-2 py-2 text-center bg-purple-700">
                                                    <div className="font-bold text-xs">% التدرج الأصلي</div>
                                                    <div className="english-text text-xs text-purple-200 font-normal">Original Grading %</div>
                                                </th>
                                                <th className="px-2 py-2 text-center bg-blue-700">
                                                    <div className="font-bold text-xs">M - وزن العينة (جم)</div>
                                                    <div className="english-text text-xs text-blue-200 font-normal">Test Mass M (g)</div>
                                                </th>
                                                <th className="px-2 py-2 text-center bg-green-700">
                                                    <div className="font-bold text-xs">R - الوزن المتبقي (جم)</div>
                                                    <div className="english-text text-xs text-green-200 font-normal">Retained Mass R (g)</div>
                                                </th>
                                                <th className="px-2 py-2 text-center bg-rose-700">
                                                    <div className="font-bold text-xs">P - النسبة (%)</div>
                                                    <div className="english-text text-xs text-rose-200 font-normal">% Clay Lumps</div>
                                                </th>
                                                <th className="px-2 py-2 text-center bg-amber-700">
                                                    <div className="font-bold text-xs">القيمة المرجحة</div>
                                                    <div className="english-text text-xs text-amber-200 font-normal">Weighted Value</div>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {coarseResults.fractionResults.map((row, index) => (
                                                <tr 
                                                    key={row.id}
                                                    className={`border-b border-slate-100 transition-colors ${
                                                        row.skipTest 
                                                            ? 'bg-slate-100 opacity-60' 
                                                            : !row.isValid && row.hasData
                                                                ? 'bg-red-50'
                                                                : index % 2 === 0 
                                                                    ? 'bg-white hover:bg-slate-50' 
                                                                    : 'bg-slate-50/50 hover:bg-slate-100'
                                                    }`}
                                                >
                                                    <td className="px-2 py-2">
                                                        <div className="font-bold text-slate-800 text-xs">{row.sizeRange}</div>
                                                        <div className="english-text text-xs text-slate-500">({row.imperial})</div>
                                                        {row.skipTest && (
                                                            <span className="inline-block mt-1 px-1.5 py-0.5 bg-slate-200 text-slate-600 text-xs rounded">
                                                                {"<"} 5% - تخطي
                                                            </span>
                                                        )}
                                                    </td>
                                                    <td className="px-2 py-2 text-center bg-slate-50">
                                                        <span className="english-text text-sm font-medium text-slate-700">{row.minMass}</span>
                                                    </td>
                                                    <td className="px-2 py-2 text-center bg-slate-50">
                                                        <span className="english-text text-xs text-slate-600">{row.washSieve}</span>
                                                    </td>
                                                    <td className="px-2 py-2 bg-purple-50">
                                                        <input
                                                            type="number"
                                                            min="0"
                                                            max="100"
                                                            step="0.1"
                                                            value={coarseData[row.id].originalGrading}
                                                            onChange={(e) => handleCoarseChange(row.id, 'originalGrading', e.target.value)}
                                                            className="w-20 px-2 py-1.5 border border-purple-300 rounded text-center english-text text-sm font-bold focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none bg-white"
                                                            placeholder="0"
                                                            dir="ltr"
                                                        />
                                                    </td>
                                                    <td className="px-2 py-2 bg-blue-50">
                                                        <input
                                                            type="number"
                                                            min="0"
                                                            step="0.1"
                                                            value={coarseData[row.id].testMass}
                                                            onChange={(e) => handleCoarseChange(row.id, 'testMass', e.target.value)}
                                                            className={`w-24 px-2 py-1.5 border rounded text-center english-text text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white ${
                                                                row.skipTest ? 'border-slate-200 bg-slate-100' : 'border-blue-300'
                                                            }`}
                                                            placeholder={`≥${row.minMass}`}
                                                            dir="ltr"
                                                            disabled={row.skipTest}
                                                        />
                                                    </td>
                                                    <td className="px-2 py-2 bg-green-50">
                                                        <input
                                                            type="number"
                                                            min="0"
                                                            step="0.1"
                                                            value={coarseData[row.id].retainedMass}
                                                            onChange={(e) => handleCoarseChange(row.id, 'retainedMass', e.target.value)}
                                                            className={`w-24 px-2 py-1.5 border rounded text-center english-text text-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none bg-white ${
                                                                row.skipTest ? 'border-slate-200 bg-slate-100' : 'border-green-300'
                                                            }`}
                                                            placeholder="0.0"
                                                            dir="ltr"
                                                            disabled={row.skipTest}
                                                        />
                                                    </td>
                                                    <td className="px-2 py-2 text-center bg-rose-50">
                                                        <span className={`english-text font-bold text-sm ${
                                                            row.hasData && row.isValid 
                                                                ? 'text-rose-700' 
                                                                : row.hasData && !row.isValid
                                                                    ? 'text-red-600'
                                                                    : 'text-slate-400'
                                                        }`}>
                                                            {row.hasData && row.isValid 
                                                                ? row.percentage.toFixed(1) 
                                                                : row.hasData && !row.isValid 
                                                                    ? 'Err' 
                                                                    : '-'}
                                                        </span>
                                                    </td>
                                                    <td className="px-2 py-2 text-center bg-amber-50">
                                                        <span className={`english-text font-bold text-sm ${
                                                            row.hasData && row.isValid && !row.skipTest
                                                                ? 'text-amber-700' 
                                                                : 'text-slate-400'
                                                        }`}>
                                                            {row.hasData && row.isValid && !row.skipTest
                                                                ? row.weightedValue.toFixed(2) 
                                                                : '-'}
                                                        </span>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                        <tfoot>
                                            <tr className="bg-slate-100 border-t-2 border-slate-300">
                                                <td colSpan={6} className="px-3 py-3 text-left">
                                                    <div className="font-bold text-slate-700">
                                                        المتوسط المرجح (المجموع)
                                                        <span className="english-text text-sm font-normal text-slate-500 mr-2">
                                                            / Weighted Average (Sec 7.2)
                                                        </span>
                                                    </div>
                                                </td>
                                                <td colSpan={2} className="px-3 py-3 text-center">
                                                    <span className="text-2xl font-bold text-rose-700 english-text">
                                                        {coarseResults.totalWeightedAverage.toFixed(1)}%
                                                    </span>
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </>
                    )}

                    {/* Results Summary Card */}
                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div className="bg-gradient-to-l from-rose-600 to-pink-600 px-4 py-3">
                            <h3 className="text-sm font-bold text-white">
                                النتيجة النهائية
                                <span className="english-text text-xs font-normal text-rose-100 mr-2">/ Final Result</span>
                            </h3>
                        </div>
                        <div className="p-6">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {/* Main Result Display */}
                                <div className={`rounded-2xl p-6 text-center ${
                                    (aggregateMode === 'fine' && fineResults.hasData && fineResults.isValid) ||
                                    (aggregateMode === 'coarse' && coarseResults.testedCount > 0)
                                        ? 'bg-gradient-to-br from-rose-500 to-pink-600'
                                        : 'bg-gradient-to-br from-slate-300 to-slate-400'
                                }`}>
                                    <div className="text-white">
                                        <div className="text-sm font-medium opacity-90 mb-2">
                                            {aggregateMode === 'fine' ? 'نسبة الكتل الطينية (ركام ناعم)' : 'المتوسط المرجح (ركام خشن)'}
                                            <span className="english-text block text-xs opacity-80">
                                                {aggregateMode === 'fine' ? '% Clay Lumps (Fine Agg.)' : 'Weighted Average (Coarse Agg.)'}
                                            </span>
                                        </div>
                                        <div className="text-5xl font-bold english-text">
                                            {aggregateMode === 'fine' 
                                                ? (fineResults.hasData && fineResults.isValid ? `${fineResults.percentage}%` : '-')
                                                : (coarseResults.testedCount > 0 ? `${coarseResults.totalWeightedAverage}%` : '-')
                                            }
                                        </div>
                                    </div>
                                </div>

                                {/* Test Info */}
                                <div className="space-y-4">
                                    <div className="bg-slate-50 rounded-xl p-4 border border-slate-200">
                                        <div className="text-xs font-medium text-slate-600 mb-1">
                                            نوع الركام المختبر
                                            <span className="english-text block text-slate-500">Aggregate Type Tested</span>
                                        </div>
                                        <div className="text-lg font-bold text-slate-800">
                                            {aggregateMode === 'fine' ? 'الركام الناعم' : 'الركام الخشن'}
                                            <span className="english-text block text-sm font-medium text-slate-600">
                                                {aggregateMode === 'fine' ? 'Fine Aggregate' : 'Coarse Aggregate'}
                                            </span>
                                        </div>
                                    </div>

                                    {aggregateMode === 'coarse' && (
                                        <div className="bg-amber-50 rounded-xl p-4 border border-amber-200">
                                            <div className="text-xs font-medium text-amber-800 mb-1">
                                                الكسور المختبرة
                                                <span className="english-text block text-amber-600">Fractions Tested</span>
                                            </div>
                                            <div className="text-lg font-bold text-amber-700 english-text">
                                                {coarseResults.testedCount} / {coarseFractions.length}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Formula & Reference */}
                    <div className="grid grid-cols-1 xl:grid-cols-2 gap-4">
                        {/* Formula */}
                        <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                            <h3 className="text-sm font-bold text-slate-800 mb-3">
                                معادلة الحساب
                                <span className="english-text text-xs font-normal text-slate-500 mr-2">/ Calculation Formula</span>
                            </h3>
                            <div className="space-y-2">
                                <div className="bg-rose-50 rounded-lg p-3 border border-rose-200">
                                    <div className="font-bold text-rose-800 text-sm mb-1">نسبة الكتل الطينية (لكل كسر):</div>
                                    <div className="font-mono text-center english-text text-rose-700">
                                        P = [(M - R) / M] × 100
                                    </div>
                                </div>
                                <div className="bg-amber-50 rounded-lg p-3 border border-amber-200">
                                    <div className="font-bold text-amber-800 text-sm mb-1">المتوسط المرجح (القسم 7.2):</div>
                                    <div className="font-mono text-center english-text text-amber-700 text-sm">
                                        Weighted Avg = Σ (P × Original Grading %) / 100
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Variables Legend */}
                        <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                            <h3 className="text-sm font-bold text-slate-800 mb-3">
                                دليل الرموز
                                <span className="english-text text-xs font-normal text-slate-500 mr-2">/ Variables Legend</span>
                            </h3>
                            <div className="grid grid-cols-2 gap-2 text-xs">
                                <div className="bg-blue-50 rounded-lg p-2 border border-blue-100">
                                    <span className="font-bold text-blue-700">M</span>
                                    <span className="text-slate-600 mr-1">= وزن عينة الاختبار</span>
                                    <span className="english-text block text-slate-500">Mass of Test Sample (g)</span>
                                </div>
                                <div className="bg-green-50 rounded-lg p-2 border border-green-100">
                                    <span className="font-bold text-green-700">R</span>
                                    <span className="text-slate-600 mr-1">= الوزن المتبقي</span>
                                    <span className="english-text block text-slate-500">Retained Mass (g)</span>
                                </div>
                                <div className="bg-rose-50 rounded-lg p-2 border border-rose-100">
                                    <span className="font-bold text-rose-700">P</span>
                                    <span className="text-slate-600 mr-1">= نسبة الكتل الطينية</span>
                                    <span className="english-text block text-slate-500">% Clay Lumps</span>
                                </div>
                                <div className="bg-purple-50 rounded-lg p-2 border border-purple-100">
                                    <span className="font-bold text-purple-700">%</span>
                                    <span className="text-slate-600 mr-1">= التدرج الأصلي</span>
                                    <span className="english-text block text-slate-500">Original Grading %</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Test Reference */}
                    <div className="bg-gradient-to-l from-slate-700 to-slate-800 rounded-xl p-4 text-white">
                        <div className="flex items-center gap-3">
                            <span className="px-3 py-1.5 bg-rose-500 text-white font-bold rounded-lg text-sm">ASTM C142</span>
                            <div>
                                <div className="font-bold text-sm">
                                    Standard Test Method for Clay Lumps and Friable Particles in Aggregates
                                </div>
                                <div className="text-slate-300 text-xs english-text">
                                    طريقة الاختبار القياسية للكتل الطينية والحبيبات الهشة في الركام
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ============= ASTM C131 - L.A. ABRASION RESISTANCE =============
        const LAAbrasionTest = () => {
            // Grading Selection
            const [selectedGrading, setSelectedGrading] = useState('A');
            const [showUniformityCheck, setShowUniformityCheck] = useState(false);

            // Table 1: Grading Requirements (ASTM C131)
            const gradingData = {
                A: {
                    sieves: [
                        { range: '37.5 - 25.0 mm (1½" - 1")', mass: 1250 },
                        { range: '25.0 - 19.0 mm (1" - ¾")', mass: 1250 },
                        { range: '19.0 - 12.5 mm (¾" - ½")', mass: 1250 },
                        { range: '12.5 - 9.5 mm (½" - ⅜")', mass: 1250 },
                    ],
                    totalMass: 5000,
                    spheres: 12,
                    chargeMass: 5000
                },
                B: {
                    sieves: [
                        { range: '25.0 - 19.0 mm (1" - ¾")', mass: 2500 },
                        { range: '19.0 - 12.5 mm (¾" - ½")', mass: 2500 },
                    ],
                    totalMass: 5000,
                    spheres: 11,
                    chargeMass: 4584
                },
                C: {
                    sieves: [
                        { range: '19.0 - 12.5 mm (¾" - ½")', mass: 2500 },
                        { range: '12.5 - 9.5 mm (½" - ⅜")', mass: 2500 },
                    ],
                    totalMass: 5000,
                    spheres: 8,
                    chargeMass: 3330
                },
                D: {
                    sieves: [
                        { range: '12.5 - 9.5 mm (½" - ⅜")', mass: 2500 },
                        { range: '9.5 - 6.3 mm (⅜" - ¼")', mass: 2500 },
                    ],
                    totalMass: 5000,
                    spheres: 6,
                    chargeMass: 2500
                }
            };

            // Input State
            const [originalMassC, setOriginalMassC] = useState('');
            const [finalMassY, setFinalMassY] = useState('');
            const [maxSpecLimit, setMaxSpecLimit] = useState(40);

            // Uniformity Check State (Note 7)
            const [mass100Revs, setMass100Revs] = useState('');

            // Calculate results (Sec 10)
            const results = useMemo(() => {
                const C = parseFloat(originalMassC) || 0;
                const Y = parseFloat(finalMassY) || 0;

                if (C === 0) {
                    return { 
                        percentLoss: 0, 
                        displayValue: '-', 
                        hasData: false, 
                        isValid: true,
                        massLoss: 0
                    };
                }

                // Validation: C must be >= Y
                if (Y > C) {
                    return { 
                        percentLoss: 0, 
                        displayValue: 'خطأ / Error', 
                        hasData: true, 
                        isValid: false,
                        massLoss: 0,
                        errorMessage: 'الوزن النهائي أكبر من الوزن الأصلي / Final mass exceeds original'
                    };
                }

                // Formula: Percent Loss = ((C - Y) / C) * 100 (Sec 10)
                const massLoss = C - Y;
                const percentLoss = ((C - Y) / C) * 100;

                // Round to nearest 1% (whole number)
                const displayValue = Math.round(percentLoss).toString();

                return { 
                    percentLoss, 
                    displayValue, 
                    hasData: true, 
                    isValid: true,
                    massLoss: parseFloat(massLoss.toFixed(1)),
                    isPassing: Math.round(percentLoss) <= maxSpecLimit
                };
            }, [originalMassC, finalMassY, maxSpecLimit]);

            // Uniformity Check Calculation (Note 7)
            const uniformityCheck = useMemo(() => {
                const C = parseFloat(originalMassC) || 0;
                const mass100 = parseFloat(mass100Revs) || 0;
                const Y = parseFloat(finalMassY) || 0;

                if (C === 0 || mass100 === 0 || Y === 0) {
                    return { ratio: 0, hasData: false, isUniform: true };
                }

                const loss100 = C - mass100;
                const loss500 = C - Y;

                if (loss500 === 0) {
                    return { ratio: 0, hasData: false, isUniform: true };
                }

                const ratio = loss100 / loss500;
                const isUniform = ratio <= 0.20;

                return {
                    loss100: parseFloat(loss100.toFixed(1)),
                    loss500: parseFloat(loss500.toFixed(1)),
                    ratio: parseFloat(ratio.toFixed(3)),
                    hasData: true,
                    isUniform
                };
            }, [originalMassC, mass100Revs, finalMassY]);

            const currentGrading = gradingData[selectedGrading];

            const handleReset = () => {
                setOriginalMassC('');
                setFinalMassY('');
                setMass100Revs('');
                setMaxSpecLimit(40);
            };

            return (
                <div className="p-4 space-y-4">
                    {/* Header Card */}
                    <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                        <div className="flex items-center justify-between mb-4">
                            <div>
                                <h2 className="text-lg font-bold text-slate-800">
                                    مقاومة البري (لوس أنجلوس)
                                </h2>
                                <p className="english-text text-sm text-slate-500">
                                    L.A. Abrasion Resistance Test (ASTM C131)
                                </p>
                            </div>
                            <button
                                onClick={handleReset}
                                className="flex items-center gap-2 px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors text-sm"
                            >
                                <RefreshIcon />
                                <span className="font-medium">إعادة تعيين</span>
                            </button>
                        </div>

                        {/* Step 1: Grading Selection */}
                        <div className="bg-gradient-to-l from-violet-50 to-purple-50 rounded-lg p-4 border border-violet-100">
                            <h3 className="text-sm font-bold text-violet-800 mb-3">
                                الخطوة 1: اختر التدرج (جدول 1) <span className="english-text text-xs font-normal text-violet-600">/ Step 1: Select Grading (Table 1)</span>
                            </h3>
                            <div className="flex gap-3">
                                {['A', 'B', 'C', 'D'].map(grade => (
                                    <button
                                        key={grade}
                                        onClick={() => setSelectedGrading(grade)}
                                        className={`flex-1 px-4 py-3 rounded-lg transition-all ${
                                            selectedGrading === grade
                                                ? 'bg-violet-600 text-white shadow-lg'
                                                : 'bg-white border border-slate-300 text-slate-600 hover:bg-slate-50'
                                        }`}
                                    >
                                        <div className="text-2xl font-bold">{grade}</div>
                                        <div className={`text-xs ${selectedGrading === grade ? 'text-violet-100' : 'text-slate-500'}`}>
                                            التدرج {grade}
                                        </div>
                                        <div className={`english-text text-xs ${selectedGrading === grade ? 'text-violet-200' : 'text-slate-400'}`}>
                                            Grading {grade}
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Step 2: Sample Preparation Guide (Dynamic Table 1) */}
                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div className="bg-gradient-to-l from-violet-600 to-purple-600 px-4 py-3">
                            <h3 className="text-sm font-bold text-white">
                                الخطوة 2: دليل تحضير العينة (جدول 1)
                                <span className="english-text text-xs font-normal text-violet-100 mr-2">/ Step 2: Sample Preparation Guide (Table 1)</span>
                            </h3>
                        </div>
                        <div className="p-4">
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm" dir="rtl">
                                    <thead>
                                        <tr className="bg-slate-100">
                                            <th className="px-3 py-2 text-right font-bold text-slate-700">
                                                كسر المقاس
                                                <span className="english-text block text-xs font-normal text-slate-500">Size Fraction</span>
                                            </th>
                                            <th className="px-3 py-2 text-center font-bold text-slate-700">
                                                الكتلة المطلوبة (جم)
                                                <span className="english-text block text-xs font-normal text-slate-500">Required Mass (g)</span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {currentGrading.sieves.map((sieve, index) => (
                                            <tr key={index} className={index % 2 === 0 ? 'bg-white' : 'bg-slate-50'}>
                                                <td className="px-3 py-2 english-text text-slate-700">{sieve.range}</td>
                                                <td className="px-3 py-2 text-center english-text font-bold text-violet-700">{sieve.mass}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                    <tfoot>
                                        <tr className="bg-violet-100 border-t-2 border-violet-300">
                                            <td className="px-3 py-2 font-bold text-violet-800">
                                                المجموع الكلي
                                                <span className="english-text block text-xs font-normal text-violet-600">Total Mass</span>
                                            </td>
                                            <td className="px-3 py-2 text-center text-xl font-bold text-violet-700 english-text">
                                                {currentGrading.totalMass} g
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>

                            {/* Step 3: Charge Info (Sec 6.4) */}
                            <div className="mt-4 grid grid-cols-2 gap-4">
                                <div className="bg-amber-50 rounded-lg p-4 border border-amber-200">
                                    <div className="text-sm font-bold text-amber-800 mb-1">
                                        عدد الكرات الفولاذية (القسم 6.4)
                                        <span className="english-text block text-xs font-normal text-amber-600">Number of Steel Spheres (Sec 6.4)</span>
                                    </div>
                                    <div className="text-3xl font-bold text-amber-700 english-text">
                                        {currentGrading.spheres}
                                    </div>
                                </div>
                                <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                                    <div className="text-sm font-bold text-blue-800 mb-1">
                                        كتلة الشحنة الكلية
                                        <span className="english-text block text-xs font-normal text-blue-600">Total Charge Mass (g)</span>
                                    </div>
                                    <div className="text-3xl font-bold text-blue-700 english-text">
                                        {currentGrading.chargeMass} g
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Inputs Section */}
                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div className="bg-slate-50 border-b border-slate-200 px-4 py-3">
                            <h3 className="text-sm font-bold text-slate-800">
                                بيانات الاختبار
                            </h3>
                            <p className="english-text text-xs text-slate-500">
                                Test Data Entry
                            </p>
                        </div>
                        <div className="p-4">
                            <div className="grid grid-cols-3 gap-4">
                                {/* C - Original Mass */}
                                <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                                    <label className="block text-sm font-bold text-blue-800 mb-2">
                                        C - وزن العينة الأصلية (جم)
                                        <span className="english-text block text-xs font-normal text-blue-600">Original Test Sample Mass (g)</span>
                                    </label>
                                    <input
                                        type="number"
                                        min="0"
                                        step="0.1"
                                        value={originalMassC}
                                        onChange={(e) => setOriginalMassC(e.target.value)}
                                        className="w-full px-4 py-3 border-2 border-blue-300 rounded-lg text-center english-text text-lg font-bold focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white"
                                        placeholder={`${currentGrading.totalMass}.0`}
                                        dir="ltr"
                                    />
                                </div>

                                {/* Y - Final Mass */}
                                <div className="bg-green-50 rounded-lg p-4 border border-green-200">
                                    <label className="block text-sm font-bold text-green-800 mb-2">
                                        Y - الوزن النهائي (المحجوز على منخل 1.70 مم)
                                        <span className="english-text block text-xs font-normal text-green-600">Final Mass Retained on No. 12 (g)</span>
                                    </label>
                                    <input
                                        type="number"
                                        min="0"
                                        step="0.1"
                                        value={finalMassY}
                                        onChange={(e) => setFinalMassY(e.target.value)}
                                        className="w-full px-4 py-3 border-2 border-green-300 rounded-lg text-center english-text text-lg font-bold focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none bg-white"
                                        placeholder="0.0"
                                        dir="ltr"
                                    />
                                </div>

                                {/* Max Spec Limit */}
                                <div className="bg-amber-50 rounded-lg p-4 border border-amber-200">
                                    <label className="block text-sm font-bold text-amber-800 mb-2">
                                        الحد الأقصى المسموح (%)
                                        <span className="english-text block text-xs font-normal text-amber-600">Max Spec Limit (%)</span>
                                    </label>
                                    <input
                                        type="number"
                                        min="0"
                                        max="100"
                                        value={maxSpecLimit}
                                        onChange={(e) => setMaxSpecLimit(parseFloat(e.target.value) || 0)}
                                        className="w-full px-4 py-3 border-2 border-amber-300 rounded-lg text-center english-text text-lg font-bold focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none bg-white"
                                        dir="ltr"
                                    />
                                </div>
                            </div>

                            {/* Validation Error */}
                            {results.hasData && !results.isValid && (
                                <div className="mt-4 bg-red-50 rounded-lg p-4 border border-red-200">
                                    <div className="flex items-center gap-2 text-red-700">
                                        <AlertTriangleIcon />
                                        <span className="font-bold">{results.errorMessage}</span>
                                    </div>
                                </div>
                            )}

                            {/* Mass Loss Display */}
                            {results.hasData && results.isValid && (
                                <div className="mt-4 bg-purple-50 rounded-lg p-4 border border-purple-200">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <div className="text-sm font-bold text-purple-800">
                                                كتلة المواد المفقودة (C - Y)
                                            </div>
                                            <div className="english-text text-xs text-purple-600">
                                                Mass Lost by Abrasion (C - Y)
                                            </div>
                                        </div>
                                        <div className="text-2xl font-bold text-purple-700 english-text">
                                            {results.massLoss.toFixed(1)} g
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Optional: Uniformity Check (Note 7) */}
                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <button
                            onClick={() => setShowUniformityCheck(!showUniformityCheck)}
                            className="w-full bg-slate-50 border-b border-slate-200 px-4 py-3 flex items-center justify-between hover:bg-slate-100 transition-colors"
                        >
                            <div className="text-right">
                                <h3 className="text-sm font-bold text-slate-800">
                                    فحص التجانس عند 100 دورة (اختياري - الملاحظة 7)
                                </h3>
                                <p className="english-text text-xs text-slate-500">
                                    Uniformity Check at 100 Revolutions (Optional - Note 7)
                                </p>
                            </div>
                            <span className={`transform transition-transform ${showUniformityCheck ? 'rotate-180' : ''}`}>▼</span>
                        </button>
                        
                        {showUniformityCheck && (
                            <div className="p-4">
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-cyan-50 rounded-lg p-4 border border-cyan-200">
                                        <label className="block text-sm font-bold text-cyan-800 mb-2">
                                            الوزن المتبقي بعد 100 دورة (جم)
                                            <span className="english-text block text-xs font-normal text-cyan-600">Mass @ 100 Revolutions (g)</span>
                                        </label>
                                        <input
                                            type="number"
                                            min="0"
                                            step="0.1"
                                            value={mass100Revs}
                                            onChange={(e) => setMass100Revs(e.target.value)}
                                            className="w-full px-4 py-3 border-2 border-cyan-300 rounded-lg text-center english-text text-lg font-bold focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 outline-none bg-white"
                                            placeholder="0.0"
                                            dir="ltr"
                                        />
                                    </div>

                                    {uniformityCheck.hasData && (
                                        <div className={`rounded-lg p-4 border-2 ${
                                            uniformityCheck.isUniform 
                                                ? 'bg-green-50 border-green-300' 
                                                : 'bg-red-50 border-red-300'
                                        }`}>
                                            <div className="text-sm font-bold mb-2">
                                                <span className={uniformityCheck.isUniform ? 'text-green-800' : 'text-red-800'}>
                                                    نسبة الفقد (100 / 500 دورة)
                                                </span>
                                                <span className={`english-text block text-xs font-normal ${uniformityCheck.isUniform ? 'text-green-600' : 'text-red-600'}`}>
                                                    Ratio (Loss @ 100 / Loss @ 500)
                                                </span>
                                            </div>
                                            <div className={`text-3xl font-bold english-text ${uniformityCheck.isUniform ? 'text-green-700' : 'text-red-700'}`}>
                                                {uniformityCheck.ratio.toFixed(3)}
                                            </div>
                                            <div className={`mt-2 text-xs font-bold ${uniformityCheck.isUniform ? 'text-green-600' : 'text-red-600'}`}>
                                                {uniformityCheck.isUniform 
                                                    ? '✓ العينة متجانسة الصلابة / Uniform Hardness' 
                                                    : '⚠ العينة غير متجانسة الصلابة / Non-uniform Hardness'}
                                            </div>
                                            <div className="mt-2 text-xs text-slate-600 english-text">
                                                (Loss @ 100: {uniformityCheck.loss100}g / Loss @ 500: {uniformityCheck.loss500}g)
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Uniformity Rule */}
                                <div className="mt-4 bg-amber-50 rounded-lg p-3 border border-amber-200">
                                    <div className="flex items-start gap-2">
                                        <AlertTriangleIcon />
                                        <div className="text-xs text-amber-800">
                                            <strong>الملاحظة 7:</strong> إذا كانت النسبة {">"} 0.20، تُعتبر العينة غير متجانسة الصلابة
                                            <span className="english-text block text-amber-600 mt-1">
                                                Note 7: If ratio {">"} 0.20, specimen has non-uniform hardness across sizes
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Results Section */}
                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div className="bg-gradient-to-l from-violet-600 to-purple-600 px-4 py-3">
                            <h3 className="text-sm font-bold text-white">
                                النتيجة المحسوبة (القسم 10)
                                <span className="english-text text-xs font-normal text-violet-100 mr-2">/ Calculated Result (Section 10)</span>
                            </h3>
                        </div>
                        <div className="p-6">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {/* Main Result */}
                                <div className={`rounded-2xl p-6 text-center ${
                                    results.hasData && results.isValid 
                                        ? results.isPassing
                                            ? 'bg-gradient-to-br from-green-500 to-emerald-600'
                                            : 'bg-gradient-to-br from-red-500 to-rose-600'
                                        : 'bg-gradient-to-br from-slate-300 to-slate-400'
                                }`}>
                                    <div className="text-white">
                                        <div className="text-sm font-medium opacity-90 mb-2">
                                            نسبة الفقد بالبري (%)
                                            <span className="english-text block text-xs opacity-80">Percent Loss by Abrasion (%)</span>
                                        </div>
                                        <div className={`font-bold english-text ${results.hasData ? 'text-6xl' : 'text-4xl'}`}>
                                            {results.displayValue}
                                            {results.hasData && results.isValid && <span className="text-3xl">%</span>}
                                        </div>
                                        <div className="mt-3 text-xs opacity-80 english-text font-mono">
                                            Loss = [(C - Y) / C] × 100
                                        </div>
                                        {results.hasData && results.isValid && (
                                            <div className={`mt-3 px-4 py-2 rounded-full inline-block ${
                                                results.isPassing ? 'bg-white/20' : 'bg-white/20'
                                            }`}>
                                                <span className="font-bold text-lg">
                                                    {results.isPassing ? 'ناجح / PASS' : 'راسب / FAIL'}
                                                </span>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* Test Details */}
                                <div className="space-y-4">
                                    {/* Grading Used */}
                                    <div className="bg-violet-50 rounded-xl p-4 border border-violet-200">
                                        <div className="text-xs font-medium text-slate-600 mb-1">
                                            التدرج المستخدم
                                            <span className="english-text block text-slate-500">Grading Used</span>
                                        </div>
                                        <div className="text-2xl font-bold text-violet-700">
                                            التدرج {selectedGrading}
                                            <span className="english-text block text-sm font-medium text-violet-600">
                                                Grading {selectedGrading} - {currentGrading.spheres} Spheres
                                            </span>
                                        </div>
                                    </div>

                                    {/* Spec Comparison */}
                                    <div className={`rounded-xl p-4 border-2 ${
                                        results.hasData && results.isValid
                                            ? results.isPassing
                                                ? 'bg-green-50 border-green-300'
                                                : 'bg-red-50 border-red-300'
                                            : 'bg-slate-50 border-slate-200'
                                    }`}>
                                        <div className="text-xs font-medium text-slate-600 mb-1">
                                            المقارنة بالحد المسموح
                                            <span className="english-text block text-slate-500">Comparison to Spec Limit</span>
                                        </div>
                                        <div className="flex items-center justify-between">
                                            <div className="text-lg font-bold english-text">
                                                <span className={results.isPassing ? 'text-green-700' : 'text-red-700'}>
                                                    {results.hasData && results.isValid ? `${results.displayValue}%` : '-'}
                                                </span>
                                                <span className="text-slate-400 mx-2">vs</span>
                                                <span className="text-slate-600">≤{maxSpecLimit}%</span>
                                            </div>
                                            {results.hasData && results.isValid && (
                                                <span className={`px-3 py-1 rounded-full text-sm font-bold ${
                                                    results.isPassing 
                                                        ? 'bg-green-200 text-green-800' 
                                                        : 'bg-red-200 text-red-800'
                                                }`}>
                                                    {results.isPassing ? '✓' : '✗'}
                                                </span>
                                            )}
                                        </div>
                                    </div>

                                    {/* Calculation Breakdown */}
                                    {results.hasData && results.isValid && (
                                        <div className="bg-slate-50 rounded-xl p-4 border border-slate-200">
                                            <div className="text-xs font-medium text-slate-600 mb-2">
                                                تفاصيل الحساب
                                                <span className="english-text block text-slate-500">Calculation Breakdown</span>
                                            </div>
                                            <div className="font-mono text-sm text-slate-700 english-text space-y-1">
                                                <div>C = {originalMassC} g (Original Mass)</div>
                                                <div>Y = {finalMassY} g (Final Mass on No. 12)</div>
                                                <div className="border-t border-slate-300 pt-1 mt-1">
                                                    Loss = [({originalMassC} - {finalMassY}) / {originalMassC}] × 100
                                                </div>
                                                <div className="font-bold text-violet-700">
                                                    Loss = {results.percentLoss.toFixed(2)}% → <span className="text-lg">{results.displayValue}%</span>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Formula & Reference */}
                    <div className="grid grid-cols-1 xl:grid-cols-2 gap-4">
                        {/* Formula */}
                        <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                            <h3 className="text-sm font-bold text-slate-800 mb-3">
                                معادلة الحساب (القسم 10)
                                <span className="english-text text-xs font-normal text-slate-500 mr-2">/ Calculation Formula (Sec 10)</span>
                            </h3>
                            <div className="bg-violet-50 rounded-lg p-4 border border-violet-200">
                                <div className="text-center font-mono text-lg english-text text-violet-800 font-bold">
                                    Percent Loss = [(C - Y) / C] × 100
                                </div>
                                <div className="mt-3 text-xs text-violet-700 space-y-1">
                                    <div><strong>C</strong> = وزن العينة الأصلية (جم) / Original Sample Mass (g)</div>
                                    <div><strong>Y</strong> = الوزن النهائي المحجوز على منخل 1.70 مم (جم) / Final Mass on No. 12 Sieve (g)</div>
                                </div>
                            </div>
                            <div className="mt-3 bg-amber-50 rounded-lg p-3 border border-amber-200">
                                <div className="text-xs text-amber-800">
                                    <strong>التقريب:</strong> يُقرب الناتج لأقرب عدد صحيح (1%)
                                    <span className="english-text block text-amber-600 mt-1">
                                        Rounding: Round result to nearest whole number (1%)
                                    </span>
                                </div>
                            </div>
                        </div>

                        {/* Steel Charge Table */}
                        <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                            <h3 className="text-sm font-bold text-slate-800 mb-3">
                                شحنة الكرات الفولاذية (القسم 6.4)
                                <span className="english-text text-xs font-normal text-slate-500 mr-2">/ Steel Ball Charge (Sec 6.4)</span>
                            </h3>
                            <div className="overflow-x-auto">
                                <table className="w-full text-xs">
                                    <thead>
                                        <tr className="bg-slate-100">
                                            <th className="px-2 py-1.5 text-center font-bold text-slate-700">التدرج</th>
                                            <th className="px-2 py-1.5 text-center font-bold text-slate-700">عدد الكرات</th>
                                            <th className="px-2 py-1.5 text-center font-bold text-slate-700">كتلة الشحنة (جم)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {Object.entries(gradingData).map(([grade, data], index) => (
                                            <tr 
                                                key={grade} 
                                                className={`${index % 2 === 0 ? 'bg-white' : 'bg-slate-50'} ${
                                                    selectedGrading === grade ? 'ring-2 ring-violet-400 ring-inset' : ''
                                                }`}
                                            >
                                                <td className="px-2 py-1.5 text-center font-bold text-violet-700">{grade}</td>
                                                <td className="px-2 py-1.5 text-center english-text">{data.spheres}</td>
                                                <td className="px-2 py-1.5 text-center english-text">{data.chargeMass} ± 25</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    {/* Test Reference */}
                    <div className="bg-gradient-to-l from-slate-700 to-slate-800 rounded-xl p-4 text-white">
                        <div className="flex items-center gap-3">
                            <span className="px-3 py-1.5 bg-violet-500 text-white font-bold rounded-lg text-sm">ASTM C131</span>
                            <div>
                                <div className="font-bold text-sm">
                                    Standard Test Method for Resistance to Degradation of Small-Size Coarse Aggregate by Abrasion and Impact in the Los Angeles Machine
                                </div>
                                <div className="text-slate-300 text-xs english-text">
                                    طريقة الاختبار القياسية لمقاومة التدهور للركام الخشن صغير المقاس بالبري والصدم في جهاز لوس أنجلوس
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
// ============= ASTM C88 - SOUNDNESS OF AGGREGATES (SEPARATE TABLES) =============
        const SoundnessTest = () => {
            // Settings
            const [aggType, setAggType] = useState('coarse'); 
            const [solution, setSolution] = useState('sodium'); 
            const [maxLimit, setMaxLimit] = useState(12); // Default 12% for Sodium

            // 1. جدول الركام الناعم (Fine Aggregate Data)
            const [fineRows, setFineRows] = useState([
                { id: 'f1', range: '150 - 300 μm (No. 100 to No. 50)', grading: '', before: '', after: '', assumedLoss: '' },
                { id: 'f2', range: '300 - 600 μm (No. 50 to No. 30)', grading: '', before: '', after: '', assumedLoss: '' },
                { id: 'f3', range: '600 μm - 1.18 mm (No. 30 to No. 16)', grading: '', before: '', after: '', assumedLoss: '' },
                { id: 'f4', range: '1.18 - 2.36 mm (No. 16 to No. 8)', grading: '', before: '', after: '', assumedLoss: '' },
                { id: 'f5', range: '2.36 - 4.75 mm (No. 8 to No. 4)', grading: '', before: '', after: '', assumedLoss: '' },
                { id: 'f6', range: '4.75 - 9.5 mm (No. 4 to 3/8")', grading: '', before: '', after: '', assumedLoss: '' },
            ]);

            // 2. جدول الركام الخشن (Coarse Aggregate Data)
            const [coarseRows, setCoarseRows] = useState([
                { id: 'c1', range: '4.75 - 9.5 mm (No. 4 to 3/8")', grading: '', before: '', after: '', washSieve: 'No. 5 (4.00 mm)', minMass: '300g', assumedLoss: '' },
                { id: 'c2', range: '9.5 - 19.0 mm (3/8" to 3/4")', grading: '', before: '', after: '', washSieve: '5/16" (8.0 mm)', minMass: '1000g', assumedLoss: '' },
                { id: 'c3', range: '19.0 - 37.5 mm (3/4" to 1½")', grading: '', before: '', after: '', washSieve: '5/8" (16.0 mm)', minMass: '1500g', assumedLoss: '' },
                { id: 'c4', range: '37.5 - 63 mm (1½" to 2½")', grading: '', before: '', after: '', washSieve: '1¼" (31.5 mm)', minMass: '3000g', assumedLoss: '' },
                { id: 'c5', range: '63 - 75 mm (2½" to 3")', grading: '', before: '', after: '', washSieve: '2½" (63 mm)', minMass: '7000g', assumedLoss: '' },
            ]);

            // Qualitative Exam Data (Table 2 - Only for Coarse > 19mm)
            const [qualitativeData, setQualitativeData] = useState([
                { id: 'q1', size: '19.0 - 37.5 mm (3/4" to 1½")', total: '', split: '', crumble: '', crack: '', flake: '' },
                { id: 'q2', size: '37.5 - 63 mm (1½" to 2½")', total: '', split: '', crumble: '', crack: '', flake: '' },
            ]);

            const handleChange = (type, id, field, value) => {
                const setter = type === 'fine' ? setFineRows : setCoarseRows;
                setter(prev => prev.map(row => row.id === id ? { ...row, [field]: value } : row));
            };

            const handleQualitativeChange = (id, field, value) => {
                setQualitativeData(prev => prev.map(row => row.id === id ? { ...row, [field]: value } : row));
            };

            // Main Calculations
            const calculations = useMemo(() => {
                const currentRows = aggType === 'fine' ? fineRows : coarseRows;
                let totalWeightedLoss = 0;
                let totalGrading = 0;

                const processedRows = currentRows.map(row => {
                    const grading = parseFloat(row.grading) || 0;
                    const before = parseFloat(row.before) || 0;
                    const after = parseFloat(row.after) || 0;
                    const assumed = parseFloat(row.assumedLoss) || 0;
                    
                    // The 5% Rule (Sec 11.1.3.4)
                    const isSmallFraction = grading < 5; 
                    const isFinerThan50 = row.id === 'f1'; 

                    let percentLoss = 0;
                    let usedAssumed = false;

                    if (isSmallFraction) {
                        percentLoss = assumed;
                        usedAssumed = true;
                    } else if (isFinerThan50) {
                        percentLoss = 0;
                    } else if (before > 0) {
                        percentLoss = ((before - after) / before) * 100;
                    }

                    const weightedLoss = (percentLoss * grading) / 100;
                    
                    totalGrading += grading;
                    totalWeightedLoss += weightedLoss;

                    return {
                        ...row, grading, before, after, percentLoss, weightedLoss, isSmallFraction, usedAssumed
                    };
                });

                const finalResult = Math.round(totalWeightedLoss);

                return {
                    rows: processedRows,
                    totalWeightedLoss,
                    finalResult,
                    totalGrading,
                    isPassing: finalResult <= maxLimit
                };
            }, [fineRows, coarseRows, aggType, maxLimit]);

            const handleReset = () => {
                setFineRows(prev => prev.map(r => ({...r, grading:'', before:'', after:'', assumedLoss:''})));
                setCoarseRows(prev => prev.map(r => ({...r, grading:'', before:'', after:'', assumedLoss:''})));
                setQualitativeData(prev => prev.map(r => ({...r, total:'', split:'', crumble:'', crack:'', flake:''})));
            };

            return (
                <div className="p-4 space-y-4">
                    {/* Header */}
                    <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
                        <div className="flex items-center justify-between mb-4">
                            <div>
                                <h2 className="text-lg font-bold text-slate-800">أصالة الركام (Soundness)</h2>
                                <p className="english-text text-sm text-slate-500">ASTM C88 - Sodium/Magnesium Sulfate</p>
                            </div>
                            <button onClick={handleReset} className="flex items-center gap-2 px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-sm transition-colors">
                                <RefreshIcon /><span className="font-medium">إعادة تعيين</span>
                            </button>
                        </div>

                        {/* Settings */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 bg-slate-50 p-4 rounded-lg border border-slate-200">
                            <div>
                                <label className="block text-xs font-bold text-slate-700 mb-2">نوع الركام / Aggregate Type</label>
                                <div className="flex bg-white rounded-lg border border-slate-300 p-1">
                                    <button onClick={() => setAggType('fine')} className={`flex-1 py-2 rounded-md text-sm font-bold transition-all ${aggType === 'fine' ? 'bg-amber-500 text-white shadow' : 'text-slate-600 hover:bg-slate-50'}`}>ناعم (Fine)</button>
                                    <button onClick={() => setAggType('coarse')} className={`flex-1 py-2 rounded-md text-sm font-bold transition-all ${aggType === 'coarse' ? 'bg-amber-500 text-white shadow' : 'text-slate-600 hover:bg-slate-50'}`}>خشن (Coarse)</button>
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-700 mb-2">المحلول / Solution</label>
                                <select value={solution} onChange={(e) => { setSolution(e.target.value); setMaxLimit(e.target.value === 'sodium' ? 12 : 18); }} className="w-full p-2 border border-slate-300 rounded-lg text-sm english-text bg-white outline-none">
                                    <option value="sodium">Sodium Sulfate</option>
                                    <option value="magnesium">Magnesium Sulfate</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-700 mb-2">الحد الأقصى / Max Limit (%)</label>
                                <input type="number" value={maxLimit} onChange={(e) => setMaxLimit(parseFloat(e.target.value))} className="w-full p-2 border border-slate-300 rounded-lg text-center font-bold text-amber-600 outline-none" dir="ltr" />
                            </div>
                        </div>
                    </div>

                    {/* Table */}
                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div className="bg-amber-600 px-4 py-3 flex justify-between items-center">
                            <h3 className="text-sm font-bold text-white">{aggType === 'fine' ? 'جدول الركام الناعم' : 'جدول الركام الخشن'}</h3>
                            {aggType === 'coarse' && <span className="text-xs text-amber-100 bg-amber-700 px-2 py-1 rounded">Check Min Mass (Sec 6.3)</span>}
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm" dir="rtl">
                                <thead>
                                    <tr className="bg-slate-100 text-slate-700">
                                        <th className="px-3 py-3 text-right">المقاس<br/><span className="english-text text-xs">Size</span></th>
                                        {aggType === 'coarse' && <th className="px-3 py-3 text-center bg-slate-200">منخل الغسيل<br/><span className="english-text text-xs">Wash Sieve</span></th>}
                                        <th className="px-3 py-3 text-center bg-purple-50">التدرج الأصلي %<br/><span className="english-text text-xs">Grading</span></th>
                                        <th className="px-3 py-3 text-center">الوزن قبل (جم)<br/><span className="english-text text-xs">Before</span></th>
                                        <th className="px-3 py-3 text-center">الوزن بعد (جم)<br/><span className="english-text text-xs">After</span></th>
                                        <th className="px-3 py-3 text-center">الفقد %<br/><span className="english-text text-xs">% Loss</span></th>
                                        <th className="px-3 py-3 text-center bg-amber-50">الفقد المرجح<br/><span className="english-text text-xs">W. Loss</span></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {calculations.rows.map((row, idx) => (
                                        <tr key={row.id} className={`border-b border-slate-50 ${row.isSmallFraction ? 'bg-slate-50' : 'bg-white'}`}>
                                            <td className="px-3 py-2 font-medium text-slate-700">
                                                <div className="text-sm">{row.range}</div>
                                                {row.isSmallFraction && <span className="text-[10px] text-red-500 font-bold block mt-1">تخطي (أقل من 5%)</span>}
                                            </td>
                                            {aggType === 'coarse' && <td className="px-3 py-2 text-center text-xs font-mono bg-slate-50">{row.washSieve}</td>}
                                            <td className="px-3 py-2 bg-purple-50/50 text-center">
                                                <input type="number" value={row.grading} onChange={(e) => handleChange(aggType, row.id, 'grading', e.target.value)} className="w-20 p-1.5 border border-purple-300 rounded text-center outline-none" placeholder="0.0" />
                                            </td>
                                            {row.isSmallFraction ? (
                                                <td colSpan={3} className="px-3 py-2 text-center">
                                                    <input type="number" value={row.assumedLoss} onChange={(e) => handleChange(aggType, row.id, 'assumedLoss', e.target.value)} className="w-24 p-1.5 border border-slate-300 rounded text-center text-xs bg-white" placeholder="Assumed %" />
                                                </td>
                                            ) : (
                                                <>
                                                    <td className="px-3 py-2 text-center"><input type="number" value={row.before} onChange={(e) => handleChange(aggType, row.id, 'before', e.target.value)} className="w-20 p-1.5 border border-slate-300 rounded text-center outline-none" placeholder="g" /></td>
                                                    <td className="px-3 py-2 text-center"><input type="number" value={row.after} onChange={(e) => handleChange(aggType, row.id, 'after', e.target.value)} className="w-20 p-1.5 border border-slate-300 rounded text-center outline-none" placeholder="g" /></td>
                                                    <td className="px-3 py-2 text-center font-bold text-slate-700">{row.percentLoss.toFixed(1)}%</td>
                                                </>
                                            )}
                                            <td className="px-3 py-2 text-center font-bold text-amber-700 bg-amber-50">{row.weightedLoss.toFixed(2)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                                <tfoot>
                                    <tr className="bg-slate-800 text-white">
                                        <td colSpan={aggType === 'coarse' ? 6 : 5} className="px-4 py-3 text-left font-bold">المجموع الكلي (Total Weighted Loss)</td>
                                        <td className="px-4 py-3 text-center text-xl font-bold text-amber-400">{calculations.finalResult}%</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    {/* Qualitative Exam (Coarse Only) */}
                    {aggType === 'coarse' && (
                        <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                            <div className="bg-slate-100 px-4 py-3 border-b border-slate-200">
                                <h3 className="text-sm font-bold text-slate-800">الفحص النوعي ({'>'} 19 مم)</h3>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-xs text-center" dir="rtl">
                                    <thead>
                                        <tr className="bg-slate-50 text-slate-600">
                                            <th className="p-2 border">المقاس</th>
                                            <th className="p-2 border">العدد الكلي</th>
                                            <th className="p-2 border">تشقق</th>
                                            <th className="p-2 border">تفتت</th>
                                            <th className="p-2 border">تصدع</th>
                                            <th className="p-2 border">تقشر</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {qualitativeData.map(row => (
                                            <tr key={row.id}>
                                                <td className="p-2 border font-bold">{row.size}</td>
                                                <td className="p-2 border"><input type="number" value={row.total} onChange={(e) => handleQualitativeChange(row.id, 'total', e.target.value)} className="w-14 p-1 border rounded text-center" /></td>
                                                <td className="p-2 border"><input type="number" value={row.split} onChange={(e) => handleQualitativeChange(row.id, 'split', e.target.value)} className="w-14 p-1 border rounded text-center" /></td>
                                                <td className="p-2 border"><input type="number" value={row.crumble} onChange={(e) => handleQualitativeChange(row.id, 'crumble', e.target.value)} className="w-14 p-1 border rounded text-center" /></td>
                                                <td className="p-2 border"><input type="number" value={row.crack} onChange={(e) => handleQualitativeChange(row.id, 'crack', e.target.value)} className="w-14 p-1 border rounded text-center" /></td>
                                                <td className="p-2 border"><input type="number" value={row.flake} onChange={(e) => handleQualitativeChange(row.id, 'flake', e.target.value)} className="w-14 p-1 border rounded text-center" /></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* Final Result */}
                    <div className={`p-6 rounded-xl text-center border-2 transition-all ${calculations.isPassing ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                        <div className={`text-3xl font-bold mb-2 ${calculations.isPassing ? 'text-green-700' : 'text-red-700'}`}>
                            {calculations.isPassing ? 'مطابق للمواصفات / PASS' : 'غير مطابق / FAIL'}
                        </div>
                        <div className="text-slate-600 font-medium english-text">
                            Result: {calculations.finalResult}% (Max Limit: {maxLimit}%)
                        </div>
                    </div>
                </div>
            );
        };
        // ============= GENERIC TEST PAGE =============
        const GenericTestPage = ({ test }) => {
            const Icon = test.icon;
            return (
                <div className="p-8">
                    <div className="bg-white rounded-xl border border-slate-200 p-8 text-center max-w-2xl mx-auto">
                        <div className="w-20 h-20 bg-gradient-to-br from-blue-500 to-blue-700 rounded-2xl flex items-center justify-center mx-auto mb-6 text-white shadow-lg">
                            <Icon />
                        </div>
                        <div className="inline-block px-3 py-1 bg-amber-100 text-amber-700 font-bold rounded-lg mb-4">
                            ASTM {test.astm}
                        </div>
                        <h2 className="text-xl font-bold text-slate-800 mb-2">{test.arabic}</h2>
                        <p className="english-text text-lg text-slate-500 mb-6">{test.english}</p>
                        
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <p className="text-blue-800 text-sm font-medium">قيد التطوير</p>
                            <p className="english-text text-blue-600 text-xs">Under Development</p>
                        </div>
                    </div>
                </div>
            );
        };

        // ============= TEST CONTAINER =============
        const TestContainer = ({ activeTest, gradationData, onGradationDataChange }) => {
            const test = testItems.find(t => t.id === activeTest);

            if (!test) {
                return (
                    <div className="flex items-center justify-center h-full">
                        <div className="text-center">
                            <h2 className="text-xl font-bold text-slate-600">اختر اختباراً للبدء</h2>
                            <p className="english-text text-slate-400">Select a test to begin</p>
                        </div>
                    </div>
                );
            }

            if (test.id === 'C136') {
                return <C136Page onGradationDataChange={onGradationDataChange} />;
            }

            if (test.id === 'D4791') {
                return <FlatElongatedTest gradationData={gradationData} />;
            }

            if (test.id === 'C127') {
                return <SpecificGravityCoarse />;
            }

            if (test.id === 'C128') {
                return <SpecificGravityFine />;
            }

            if (test.id === 'C117') {
                return <MaterialsFinerThan200 />;
            }

            if (test.id === 'C142') {
                return <ClayLumpsTest />;
            }

            if (test.id === 'C131') {
                return <LAAbrasionTest />;
            }
             if (test.id === 'C88') {
                return <SoundnessTest />;
            }
            return <GenericTestPage test={test} />;
        };

        // ============= HEADER =============
        const Header = ({ activeTest, isCollapsed, setIsCollapsed }) => {
            const test = testItems.find(t => t.id === activeTest);

            return (
                <header className="h-14 bg-white border-b border-slate-200 flex items-center justify-between px-4 shadow-sm">
                    <div className="flex items-center gap-3">
                        {isCollapsed && (
                            <button 
                                onClick={() => setIsCollapsed(false)}
                                className="p-2 hover:bg-slate-100 rounded-lg text-slate-600 transition-colors"
                            >
                                <MenuIcon />
                            </button>
                        )}
                        <div className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-gradient-to-br from-slate-700 to-slate-900 rounded-lg flex items-center justify-center text-white">
                                <FlaskIcon />
                            </div>
                            <div>
                                <h1 className="font-bold text-slate-800 text-sm">منصة اختبار مواد الهندسة المدنية</h1>
                                <p className="english-text text-xs text-slate-500">Civil Engineering Materials Testing Platform</p>
                            </div>
                        </div>
                    </div>
                    
                    {test && (
                        <div className="flex items-center gap-2 bg-slate-50 px-3 py-1.5 rounded-lg">
                            <div className="text-left">
                                <div className="font-bold text-slate-700 text-xs">{test.arabic}</div>
                                <div className="english-text text-xs text-slate-500">{test.english}</div>
                            </div>
                            <span className="px-2 py-0.5 bg-blue-600 text-white text-xs font-bold rounded">
                                ASTM {test.astm}
                            </span>
                        </div>
                    )}
                </header>
            );
        };

        // ============= MAIN APP =============
        const App = () => {
            const [activeTest, setActiveTest] = useState('C136');
            const [isCollapsed, setIsCollapsed] = useState(false);
            
            // Global gradation data from C136 (for use by D4791 and other tests)
            const [globalGradationData, setGlobalGradationData] = useState([]);

            return (
                <div className="min-h-screen bg-slate-100">
                    <Sidebar 
                        activeTest={activeTest} 
                        setActiveTest={setActiveTest}
                        isCollapsed={isCollapsed}
                        setIsCollapsed={setIsCollapsed}
                    />
                    
                    <div className={`transition-all duration-300 ${isCollapsed ? 'mr-0' : 'mr-72'}`}>
                        <Header 
                            activeTest={activeTest}
                            isCollapsed={isCollapsed}
                            setIsCollapsed={setIsCollapsed}
                        />
                        
                        <main className="h-[calc(100vh-3.5rem)] overflow-auto bg-slate-50">
                            <TestContainer 
                                activeTest={activeTest} 
                                gradationData={globalGradationData}
                                onGradationDataChange={setGlobalGradationData}
                            />
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
